
<!DOCTYPE html>
<html lang="">


<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-139540194-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-139540194-1');
</script>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  <!-- <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6846579683645896",
    enable_page_level_ads: true
  });
</script> -->
  
  
    <meta name="keywords" content="react,源码,">
  

  
    <meta name="description" content="react源码学习之首次渲染调度更新的过程">
  
  
  <link rel="icon" type="image/x-icon" href="https://ginnko.github.io/images/ginnko.jpeg">
  <title>react源码学习之首次渲染调度更新的过程 [ Ginnko&#39;s ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
</head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    <img class="avatar" src="https://ginnko.github.io/images/ginnko.jpeg">
    <span class="title">Ginnko&#39;s</span>
  </a>

  <ul class="pure-menu-list clearfix">
      
          
            <li class="pure-menu-item"><a href="/" class="pure-menu-link">首页</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/archives" class="pure-menu-link">归档</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/tags" class="pure-menu-link">标签</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/search" class="pure-menu-link">搜索</a></li>
          
      
          
            <li class="pure-menu-item"><a href="https://github.com/ginnko" class="pure-menu-link">关于</a></li>
          
      
  </ul>
   
</nav>
  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <div class="left-ads-container">
      

<div id="ads-left" class="ads-left">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- left -->
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6846579683645896" data-ad-slot="9201612849" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
  </div>
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        react源码学习之首次渲染调度更新的过程
      </h1>
      <span>
        
        <time class="time" datetime="2020-07-14T16:00:00.000Z">
        2020-07-15
      </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
      <span class="post-tags">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/源码/">源码</a></li></ul>
      </span>
    </span>
      <span class="slash">/</span>
      <span class="read">
      <span id="busuanzi_value_page_pv"></span> 点击
    </span>
      <span class="slash">/</span>
      <span class="read">阅读耗时 152 分钟</span>
    </header>

    <div class="post-content">
      <p>之前知道了首次渲染创建更新的过程，现在进入调度更新的过程（下图中的右侧部分，从scheduleUpdateOnFiber开始进入调度阶段）。</p>
<a id="more"></a>
<pre class="mermaid" style="background: none">graph TD;

  render --> legacyRenderSubtreeIntoContainer;
  legacyRenderSubtreeIntoContainer --> legacyCreateRootFromDOMContainer;
  legacyRenderSubtreeIntoContainer --> unbatchedUpdates;
  unbatchedUpdates --> updateContainer;
  updateContainer --> scheduleUpdateOnFiber;
  scheduleUpdateOnFiber --> checkForNestedUpdates;
  scheduleUpdateOnFiber --> markUpdateTimeFromFiberToRoot;
  markUpdateTimeFromFiberToRoot --> markRootUpdatedAtTime;
  scheduleUpdateOnFiber --> getCurrentPriorityLevel;
  scheduleUpdateOnFiber --> schedulePendingInteractions;
  schedulePendingInteractions --> scheduleInteractions;
  scheduleUpdateOnFiber --> performSyncWorkOnRoot;
  performSyncWorkOnRoot --> renderRootSync;
  renderRootSync --> pushDispatcher;
  renderRootSync --> prepareFreshStack;
  prepareFreshStack --> createWorkInProgress;
  renderRootSync --> startWorkOnPendingInteractions;
  startWorkOnPendingInteractions --> scheduleInteractions;
  renderRootSync --> pushInteractions;
  renderRootSync --> workLoopSync;</pre>

  <!-- beginWork  pushHostRootContext;
  pushHostRootContext  pushTopLevelContextObject;
  pushHostRootContext  pushHostContainer;
  pushHostContainer  getRootHostContext;
  getRootHostContext  getChildNamespace;
  pushHostContainer  pop;
  beginWork  bailoutOnAlreadyFinishedWork; -->
<table>
<thead>
<tr>
<th>函数名</th>
<th>参数(类型)</th>
<th>位置</th>
</tr>
</thead>
<tbody>
<tr>
<td>scheduleUpdateOnFiber</td>
<td>fiber(Fiber)、expirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>checkForNestedUpdates</td>
<td>-</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>markUpdateTimeFromFiberToRoot</td>
<td>-</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>markRootUpdatedAtTime</td>
<td>fiber(Fiber)、expirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactFiberRoot</td>
</tr>
<tr>
<td>getCurrentPriorityLevel</td>
<td>-</td>
<td>react-reconciler/src/SchedulerWithReactIntegration</td>
</tr>
<tr>
<td>schedulePendingInteractions</td>
<td>-</td>
<td>react-reconciler/src/SchedulerWithReactIntegration</td>
</tr>
<tr>
<td>scheduleInteractions</td>
<td>root, expirationTime, interactions</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>performSyncWorkOnRoot</td>
<td>root(FiberRoot)</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>renderRootSync</td>
<td>root(FiberRoot), expirationTime</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>pushDispatcher</td>
<td>root(FiberRoot), expirationTime</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>prepareFreshStack</td>
<td>root(FiberRoot), expirationTime</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>startWorkOnPendingInteractions</td>
<td>root(FiberRoot), expirationTime</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>startWorkOnPendingInteractions</td>
<td>root(FiberRoot), expirationTime, interactions</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>pushInteractions</td>
<td>root(FiberRoot)</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>workLoopSync</td>
<td>-</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>performUnitOfWork</td>
<td>workInProgress(Fiber)</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>createWorkInProgress</td>
<td>Fiber, pendingProps</td>
<td>react-reconciler/src/ReactFiber</td>
</tr>
<tr>
<td>pushHostRootContext</td>
<td>Fiber</td>
<td>react-reconciler/src/ReactFiberBeginWork</td>
</tr>
<tr>
<td>pushTopLevelContextObject</td>
<td>Fiber, context, didChange(boolean)</td>
<td>react-reconciler/src/ReactFiberContext</td>
</tr>
<tr>
<td>push</td>
<td>cursor(StackCursor<t>), value(T), fiber</t></td>
<td>react-reconciler/src/ReactFiberStack</td>
</tr>
<tr>
<td>pushHostContainer</td>
<td>fiber, dom</td>
<td>react-reconciler/src/ReactFiberHostContext</td>
</tr>
<tr>
<td>getRootHostContext</td>
<td>dom</td>
<td>react-dom/src/client/ReactDOMHostConfig</td>
</tr>
<tr>
<td>getChildNamespace</td>
<td>parentNamespace(string或null),type(string)</td>
<td>react-dom/src/shared/DOMNamespaces</td>
</tr>
<tr>
<td>pop</td>
<td>cursor(StackCursor<t>), value(T), fiber</t></td>
<td>react-reconciler/src/ReactFiberStack</td>
</tr>
<tr>
<td>beginWork</td>
<td>current(Fiber 或 null), workInProgress(Fiber), renderExpirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactFiberBeginWork</td>
</tr>
<tr>
<td>bailoutOnAlreadyFinishedWork</td>
<td>current(Fiber 或 null), workInProgress(Fiber), renderExpirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactFiberBeginWork</td>
</tr>
<tr>
<td>updateHostRoot</td>
<td>current(Fiber 或 null), workInProgress(Fiber), renderExpirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactFiberBeginWork</td>
</tr>
<tr>
<td>cloneUpdateQueue</td>
<td>current(Fiber), workInProgress(Fiber)</td>
<td>react-reconciler/src/ReactUpdateQueue</td>
</tr>
<tr>
<td>processUpdateQueue</td>
<td>workInProgress(Fiber), props(any), instance(any), renderExpirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactUpdateQueue</td>
</tr>
<tr>
<td>markRenderEventTimeAndConfig</td>
<td>expirationTime(ExpirationTime), suspenseConfig(null或SuspenseConfig)</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>getStateFromUpdate</td>
<td>workInProgress(Fiber), queue(UpdateQueue), update(Update), prevState(State), nextProps(any), instance(any)</td>
<td>react-reconciler/src/ReactUpdateQueue</td>
</tr>
<tr>
<td>reconcileChildren</td>
<td>current(Fiber 或 null), workInProgress(Fiber), nextChildren(any), renderExpirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactFiberBeginWork</td>
</tr>
<tr>
<td>reconcileChildFibers</td>
<td>returnFiber(Fiber), currentFirstChild(Fiber或null), newChild(any), renderExpirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactChildFiber</td>
</tr>
<tr>
<td>placeSingleChild</td>
<td>newFiber(Fiber)</td>
<td>react-reconciler/src/ReactChildFiber</td>
</tr>
<tr>
<td>reconcileSingleElement</td>
<td>returnFiber(Fiber), currentFirstChild(Fiber或null), element(ReactElement), expiration(Expiration)</td>
<td>react-reconciler/src/ReactChildFiber</td>
</tr>
<tr>
<td>createFiberFromElement</td>
<td>element(ReactElement), mode(TypeOfMode), expiration(Expiration)</td>
<td>react-reconciler/src/ReactFiber</td>
</tr>
<tr>
<td>createFiberFromTypeAndProps</td>
<td>type(ReactElementType), key(null或string), pendingProps(any), owner(null或Fiber), mode(TypeOfMode), expiration(Expiration)</td>
<td>react-reconciler/src/ReactFiber</td>
</tr>
<tr>
<td>coerceRef</td>
<td>returnFiber(Fiber), current(null或Fiber), element(ReactElement)</td>
<td>react-reconciler/src/ReactFiber</td>
</tr>
<tr>
<td>updateMode</td>
<td>current(null或Fiber), workInProgress(Fiber), renderExpirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactFiber</td>
</tr>
<tr>
<td>mountChildFibers</td>
<td>returnFiber(Fiber), currentFirstChild(Fiber或null), newChild(any), renderExpirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactChildFiber</td>
</tr>
<tr>
<td>placeSingleChild</td>
<td>newFiber(Fiber)</td>
<td>react-reconciler/src/ReactChildFiber</td>
</tr>
<tr>
<td>mountIndeterminateComponent</td>
<td>current(null或Fiber), workInProgress(Fiber), Component, renderExpirationTime</td>
<td>react-reconciler/src/ReactFiberBeginWork</td>
</tr>
<tr>
<td>getUnmaskedContext</td>
<td>current(null或Fiber), workInProgress(Fiber), Component, renderExpirationTime</td>
<td>react-reconciler/src/ReactFiberContext</td>
</tr>
<tr>
<td>renderWithHooks</td>
<td>current(null或Fiber), workInProgress(Fiber), Component, props, secondArg, nextRenderExpirationTime</td>
<td>react-reconciler/src/ReactFiberHooks</td>
</tr>
<tr>
<td>updateHostComponent</td>
<td>current(null或Fiber), workInProgress(Fiber), renderExpirationTime</td>
<td>react-reconciler/src/ReactFiberBeginWork</td>
</tr>
<tr>
<td>reconcileChildrenArray</td>
<td>returnFiber(Fiber),currentFirstChild(null或Fiber), newChildren(Array), expirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactChildFiber</td>
</tr>
<tr>
<td>createChild</td>
<td>returnFiber(Fiber),newChild(any), expirationTime(ExpirationTime)</td>
<td>react-reconciler/src/ReactChildFiber</td>
</tr>
<tr>
<td>placeChild</td>
<td>newFiber(Fiber),lastPlacedIndex(number), newIndex(number)</td>
<td>react-reconciler/src/ReactChildFiber</td>
</tr>
<tr>
<td>deleteRemainingChildren</td>
<td>returnFiber(Fiber),currentFirstChild(Fiber或null)</td>
<td>react-reconciler/src/ReactChildFiber</td>
</tr>
<tr>
<td>completeUnitOfWork</td>
<td>unitOfWork(Fiber)</td>
<td>react-reconciler/src/ReactFiberWorkLoop</td>
</tr>
<tr>
<td>completeWork</td>
<td>current(Fiber或null), workInProgress(Fiber), renderExpiration(ExpirationTime)</td>
<td>react-reconciler/src/ReactFiberCompleteWork</td>
</tr>
<tr>
<td>createInstance</td>
<td>type(string), props(props), rootContainerInstance(Container), hostContext(HostContext), internalInstanceHandle(Object)</td>
<td>react-dom/src/client/ReactDOMHostConfig</td>
</tr>
<tr>
<td>appendAllChildren</td>
<td>parent(Instance), workInProgress(Fiber), needsVisibilityToggle(boolean), isHidden(boolean)</td>
<td>react-reconciler/src/ReactFiberCompleteWork</td>
</tr>
<tr>
<td>createTextInstance</td>
<td>text(string), rootContainerInstance(container), hostContext(HostContext), internalInstanceHandle(Object)</td>
<td>react-reconciler/src/ReactFiberCompleteWork</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="主要函数"><a href="#主要函数" class="headerlink" title="主要函数"></a>主要函数</h3><ol>
<li>scheduleUpdateOnFiber</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// export const NoContext = /*             */ 0b0000000;</span></span><br><span class="line"><span class="comment">// const BatchedContext = /*               */ 0b0000001;</span></span><br><span class="line"><span class="comment">// const EventContext = /*                 */ 0b0000010;</span></span><br><span class="line"><span class="comment">// const DiscreteEventContext = /*         */ 0b0000100;</span></span><br><span class="line"><span class="comment">// const LegacyUnbatchedContext = /*       */ 0b0001000;</span></span><br><span class="line"><span class="comment">// const RenderContext = /*                */ 0b0010000;</span></span><br><span class="line"><span class="comment">// const CommitContext = /*                */ 0b0100000;</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scheduleUpdateOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  checkForNestedUpdates();</span><br><span class="line">  <span class="comment">// warnAboutRenderPhaseUpdatesInDEV(fiber); // 这个函数运行在测试环境</span></span><br><span class="line">  <span class="comment">// 首次渲染这个函数给FiberRoot的pendingTime设置了范围(firstPendingTime = MAX_SIGNED_31_BIT_INT, lastPendingTime = MAX_SIGNED_31_BIT_INT)</span></span><br><span class="line">  <span class="keyword">const</span> root = markUpdateTimeFromFiberToRoot(fiber, expirationTime);</span><br><span class="line">  <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">    warnAboutUpdateOnUnmountedFiberInDEV(fiber);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> computeExpirationForFiber also reads the priority. Pass the</span></span><br><span class="line">  <span class="comment">// priority as an argument to that function and this one.</span></span><br><span class="line">  <span class="keyword">const</span> priorityLevel = getCurrentPriorityLevel(); <span class="comment">// 首次渲染 NormalPriority = 3</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (expirationTime === Sync) &#123; <span class="comment">// 首次渲染等于Sync</span></span><br><span class="line">    <span class="comment">// 首次渲染过程中，处理过executionContext的地方位于unbatchedUpdates中</span></span><br><span class="line">    <span class="comment">// 经过如下步骤：</span></span><br><span class="line">    <span class="comment">// const prevExecutionContext = executionContext;</span></span><br><span class="line">    <span class="comment">// executionContext &amp;= ~BatchedContext;</span></span><br><span class="line">    <span class="comment">// executionContext |= LegacyUnbatchedContext;</span></span><br><span class="line">    <span class="comment">// 此时的executionContext中加入了LegacyUnbatchedContext，所以值为0b0001000，也就是8</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// Check if we're inside unbatchedUpdates</span></span><br><span class="line">      (executionContext &amp; LegacyUnbatchedContext) !== NoContext &amp;&amp;</span><br><span class="line">      <span class="comment">// Check if we're not already rendering</span></span><br><span class="line">      (executionContext &amp; (RenderContext | CommitContext)) === NoContext</span><br><span class="line">    ) &#123; <span class="comment">// 首次渲染进入该分支</span></span><br><span class="line">      <span class="comment">// Register pending interactions on the root to avoid losing traced interaction data.</span></span><br><span class="line">      schedulePendingInteractions(root, expirationTime);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// This is a legacy edge case. The initial mount of a ReactDOM.render-ed</span></span><br><span class="line">      <span class="comment">// root inside of batchedUpdates should be synchronous, but layout updates</span></span><br><span class="line">      <span class="comment">// should be deferred until the end of the batch.</span></span><br><span class="line">      performSyncWorkOnRoot(root);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ensureRootIsScheduled(root);</span><br><span class="line">      schedulePendingInteractions(root, expirationTime);</span><br><span class="line">      <span class="keyword">if</span> (executionContext === NoContext) &#123;</span><br><span class="line">        <span class="comment">// Flush the synchronous work now, unless we're already working or inside</span></span><br><span class="line">        <span class="comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span></span><br><span class="line">        <span class="comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span></span><br><span class="line">        <span class="comment">// without immediately flushing it. We only do this for user-initiated</span></span><br><span class="line">        <span class="comment">// updates, to preserve historical behavior of legacy mode.</span></span><br><span class="line">        flushSyncCallbackQueue();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Schedule a discrete update but only if it's not Sync.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (executionContext &amp; DiscreteEventContext) !== NoContext &amp;&amp;</span><br><span class="line">      <span class="comment">// Only updates at user-blocking priority or greater are considered</span></span><br><span class="line">      <span class="comment">// discrete, even inside a discrete event.</span></span><br><span class="line">      (priorityLevel === UserBlockingPriority ||</span><br><span class="line">        priorityLevel === ImmediatePriority)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// This is the result of a discrete event. Track the lowest priority</span></span><br><span class="line">      <span class="comment">// discrete update per root so we can flush them early, if needed.</span></span><br><span class="line">      <span class="keyword">if</span> (rootsWithPendingDiscreteUpdates === <span class="literal">null</span>) &#123;</span><br><span class="line">        rootsWithPendingDiscreteUpdates = <span class="keyword">new</span> <span class="built_in">Map</span>([[root, expirationTime]]);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> lastDiscreteTime = rootsWithPendingDiscreteUpdates.get(root);</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          lastDiscreteTime === <span class="literal">undefined</span> ||</span><br><span class="line">          lastDiscreteTime &gt; expirationTime</span><br><span class="line">        ) &#123;</span><br><span class="line">          rootsWithPendingDiscreteUpdates.set(root, expirationTime);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Schedule other updates after in case the callback is sync.</span></span><br><span class="line">    ensureRootIsScheduled(root);</span><br><span class="line">    schedulePendingInteractions(root, expirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>checkForNestedUpdates</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> NESTED_UPDATE_LIMIT = <span class="number">50</span>;</span><br><span class="line"><span class="keyword">let</span> nestedUpdateCount: number = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkForNestedUpdates</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (nestedUpdateCount &gt; NESTED_UPDATE_LIMIT) &#123;</span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">    rootWithNestedUpdates = <span class="literal">null</span>;</span><br><span class="line">    invariant(</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      <span class="string">'Maximum update depth exceeded. This can happen when a component '</span> +</span><br><span class="line">        <span class="string">'repeatedly calls setState inside componentWillUpdate or '</span> +</span><br><span class="line">        <span class="string">'componentDidUpdate. React limits the number of nested updates to '</span> +</span><br><span class="line">        <span class="string">'prevent infinite loops.'</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>markUpdateTimeFromFiberToRoot</li>
</ol>
<p>传入该函数的fiber值：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ====================fiber============================</span></span><br><span class="line">  &#123;</span><br><span class="line">    actualDuration: <span class="number">0</span>,</span><br><span class="line">    actualStartTime: <span class="number">-1</span>,</span><br><span class="line">    alternate: <span class="literal">null</span>,</span><br><span class="line">    child: <span class="literal">null</span>,</span><br><span class="line">    childExpirationTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">    dependencies_old: <span class="literal">null</span>,</span><br><span class="line">    effectTag: NoEffect, <span class="comment">// 0</span></span><br><span class="line">    elementType: <span class="literal">null</span>,</span><br><span class="line">    expirationTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">    firstEffect: <span class="literal">null</span>,</span><br><span class="line">    index: <span class="number">0</span>,</span><br><span class="line">    key: <span class="literal">null</span>,</span><br><span class="line">    lastEffect: <span class="literal">null</span>,</span><br><span class="line">    memoizedProps: <span class="literal">null</span>,</span><br><span class="line">    memoizedState: <span class="literal">null</span>,</span><br><span class="line">    mode: NoMode, <span class="comment">// 0</span></span><br><span class="line">    nextEffect: <span class="literal">null</span>,</span><br><span class="line">    pendingProps: <span class="literal">null</span>,</span><br><span class="line">    ref: <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">return</span>: <span class="literal">null</span>,</span><br><span class="line">    setBaseDuration: <span class="number">0</span>,</span><br><span class="line">    sibling: <span class="literal">null</span>,</span><br><span class="line">    stateNode: container,</span><br><span class="line">    tag: HostRoot, <span class="comment">// 3</span></span><br><span class="line">    treeBaseDuration: <span class="number">0</span>,</span><br><span class="line">    type: <span class="literal">null</span>,</span><br><span class="line">    updateQueue: &#123;</span><br><span class="line">      baseState: <span class="literal">null</span>,</span><br><span class="line">      effects: <span class="literal">null</span>,</span><br><span class="line">      firstBaseUpdate: <span class="literal">null</span>,</span><br><span class="line">      lastBaseUpdate: <span class="literal">null</span>,</span><br><span class="line">      shared: &#123;</span><br><span class="line">        pending: <span class="literal">null</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ======================expirationTime==================</span></span><br><span class="line"></span><br><span class="line">  MAX_SIGNED_31_BIT_INT, <span class="comment">// 1073741823</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ======================FiberRoot=======================</span></span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    callbackNode: <span class="literal">null</span>,</span><br><span class="line">    callbackPriority_old: Nopriority, <span class="comment">// 90</span></span><br><span class="line">    containerInfo: <span class="string">'&lt;div id="root"&gt;'</span>, <span class="comment">// dom元素()</span></span><br><span class="line">    context: &#123;&#125;,</span><br><span class="line">    current,</span><br><span class="line">    finishedExpirationTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">    finishedWork: <span class="literal">null</span>,</span><br><span class="line">    firstPendingTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">    firstSuspendedTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">    hydrate: <span class="literal">false</span>,</span><br><span class="line">    interactionThreadID: <span class="number">1</span>,</span><br><span class="line">    lastExpiredTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">    lastPendingTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">    lastPingedTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">    lastSuspendedTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">    memoizedInteractions: <span class="built_in">Set</span>[],</span><br><span class="line">    mutableSourceEagerHydrationData: <span class="literal">null</span>,</span><br><span class="line">    mutableSourceLastPendingUpdateTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">    nextKnownPendingLevel: NoWork, <span class="comment">// 0</span></span><br><span class="line">    pendingChildren: <span class="literal">null</span>,</span><br><span class="line">    pendingContext: <span class="literal">null</span>,</span><br><span class="line">    pendingInteractionMap_old: <span class="built_in">Map</span>(<span class="number">0</span>),</span><br><span class="line">    pingCache: <span class="literal">null</span>,</span><br><span class="line">    timeoutHandle: noTimeout, <span class="comment">// -1</span></span><br><span class="line">    tag: LegacyRoot, <span class="comment">// 0</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> workInProgressRoot: FiberRoot | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// This is split into a separate function so we can mark a fiber with pending</span></span><br><span class="line"><span class="comment">// work without treating it as a typical update that originates from an event;</span></span><br><span class="line"><span class="comment">// e.g. retrying a Suspense boundary isn't an update, but it does schedule work</span></span><br><span class="line"><span class="comment">// on a fiber.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">markUpdateTimeFromFiberToRoot</span>(<span class="params">fiber, expirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Update the source fiber's expiration time</span></span><br><span class="line">  <span class="keyword">if</span> (fiber.expirationTime &lt; expirationTime) &#123;</span><br><span class="line">    fiber.expirationTime = expirationTime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> alternate = fiber.alternate;</span><br><span class="line">  <span class="keyword">if</span> (alternate !== <span class="literal">null</span> &amp;&amp; alternate.expirationTime &lt; expirationTime) &#123; <span class="comment">// 首次渲染alternate是null，不会进入这个分支</span></span><br><span class="line">    alternate.expirationTime = expirationTime;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Walk the parent path to the root and update the child expiration time.</span></span><br><span class="line">  <span class="keyword">let</span> node = fiber.return; <span class="comment">// 首次渲染，值为null</span></span><br><span class="line">  <span class="keyword">let</span> root = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (node === <span class="literal">null</span> &amp;&amp; fiber.tag === HostRoot) &#123; <span class="comment">// 首次渲染进入该分支</span></span><br><span class="line">    root = fiber.stateNode; <span class="comment">// 首次渲染值为FiberRoot</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (node !== <span class="literal">null</span>) &#123;</span><br><span class="line">      alternate = node.alternate;</span><br><span class="line">      <span class="keyword">if</span> (node.childExpirationTime &lt; expirationTime) &#123;</span><br><span class="line">        node.childExpirationTime = expirationTime;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          alternate !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">          alternate.childExpirationTime &lt; expirationTime</span><br><span class="line">        ) &#123;</span><br><span class="line">          alternate.childExpirationTime = expirationTime;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        alternate !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        alternate.childExpirationTime &lt; expirationTime</span><br><span class="line">      ) &#123;</span><br><span class="line">        alternate.childExpirationTime = expirationTime;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (node.return === <span class="literal">null</span> &amp;&amp; node.tag === HostRoot) &#123;</span><br><span class="line">        root = node.stateNode;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (workInProgressRoot === root) &#123; <span class="comment">// 首次渲染 workInProgressRoot === null，不进入该分支</span></span><br><span class="line">      <span class="comment">// Received an update to a tree that's in the middle of rendering. Mark</span></span><br><span class="line">      <span class="comment">// that's unprocessed work on this root.</span></span><br><span class="line">      markUnprocessedUpdateTime(expirationTime);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (workInProgressRootExitStatus === RootSuspendedWithDelay) &#123;</span><br><span class="line">        <span class="comment">// The root already suspended with a delay, which means this render</span></span><br><span class="line">        <span class="comment">// definitely won't finish. Since we have a new update, let's mark it as</span></span><br><span class="line">        <span class="comment">// suspended now, right before marking the incoming update. This has the</span></span><br><span class="line">        <span class="comment">// effect of interrupting the current render and switching to the update.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This happens to work when receiving an update during the render</span></span><br><span class="line">        <span class="comment">// phase, because of the trick inside computeExpirationForFiber to</span></span><br><span class="line">        <span class="comment">// subtract 1 from `renderExpirationTime` to move it into a</span></span><br><span class="line">        <span class="comment">// separate bucket. But we should probably model it with an exception,</span></span><br><span class="line">        <span class="comment">// using the same mechanism we use to force hydration of a subtree.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This does not account for low pri updates that were already</span></span><br><span class="line">        <span class="comment">// scheduled before the root started rendering. Need to track the next</span></span><br><span class="line">        <span class="comment">// pending expiration time (perhaps by backtracking the return path) and</span></span><br><span class="line">        <span class="comment">// then trigger a restart in the `renderDidSuspendDelayIfPossible` path.</span></span><br><span class="line">        markRootSuspendedAtTime(root, renderExpirationTime);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Mark that the root has a pending update.</span></span><br><span class="line">    markRootUpdatedAtTime(root, expirationTime);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>markRootUpdatedAtTime</li>
</ol>
<p>首次渲染的时候上面的函数没有执行实质性的操作，该函数做的实质性操作是给FiberRoot的pending times设置了范围</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mark that the root has a pending update.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markRootUpdatedAtTime</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Update the range of pending times</span></span><br><span class="line">  <span class="keyword">const</span> firstPendingTime = root.firstPendingTime; <span class="comment">// 首次渲染 NoWork = 0</span></span><br><span class="line">  <span class="keyword">if</span> (expirationTime &gt; firstPendingTime) &#123;</span><br><span class="line">    root.firstPendingTime = expirationTime; <span class="comment">// 首次渲染 MAX_SIGNED_31_BIT_INT = 1073741823</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> lastPendingTime = root.lastPendingTime; <span class="comment">// 首次渲染 NoWork = 0</span></span><br><span class="line">  <span class="keyword">if</span> (lastPendingTime === NoWork || expirationTime &lt; lastPendingTime) &#123;</span><br><span class="line">    root.lastPendingTime = expirationTime; <span class="comment">// 首次渲染 MAX_SIGNED_31_BIT_INT = 1073741823</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update the range of suspended times. Treat everything lower priority or</span></span><br><span class="line">  <span class="comment">// equal to this update as unsuspended.</span></span><br><span class="line">  <span class="keyword">const</span> firstSuspendedTime = root.firstSuspendedTime; <span class="comment">// 首次渲染 NoWork = 0</span></span><br><span class="line">  <span class="keyword">if</span> (firstSuspendedTime !== NoWork) &#123; <span class="comment">// 首次渲染不会进入该分支</span></span><br><span class="line">    <span class="keyword">if</span> (expirationTime &gt;= firstSuspendedTime) &#123;</span><br><span class="line">      <span class="comment">// The entire suspended range is now unsuspended.</span></span><br><span class="line">      root.firstSuspendedTime = root.lastSuspendedTime = root.nextKnownPendingLevel = NoWork;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expirationTime &gt;= root.lastSuspendedTime) &#123;</span><br><span class="line">      root.lastSuspendedTime = expirationTime + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is a pending level. Check if it's higher priority than the next</span></span><br><span class="line">    <span class="comment">// known pending level.</span></span><br><span class="line">    <span class="keyword">if</span> (expirationTime &gt; root.nextKnownPendingLevel) &#123;</span><br><span class="line">      root.nextKnownPendingLevel = expirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>getCurrentPriorityLevel</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoPriority = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ImmediatePriority = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> UserBlockingPriority = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NormalPriority = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LowPriority = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IdlePriority = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> currentPriorityLevel = NormalPriority;</span><br><span class="line"><span class="comment">// Scheduler_getCurrentPriorityLevel就是unstable_getCurrentPriorityLevel</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_getCurrentPriorityLevel</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> currentPriorityLevel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ImmediatePriority as unstable_ImmediatePriority,</span></span><br><span class="line"><span class="comment">// UserBlockingPriority as unstable_UserBlockingPriority,</span></span><br><span class="line"><span class="comment">// NormalPriority as unstable_NormalPriority,</span></span><br><span class="line"><span class="comment">// IdlePriority as unstable_IdlePriority,</span></span><br><span class="line"><span class="comment">// LowPriority as unstable_LowPriority,</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// unstable_ImmediatePriority: Scheduler_ImmediatePriority,</span></span><br><span class="line"><span class="comment">// unstable_UserBlockingPriority: Scheduler_UserBlockingPriority,</span></span><br><span class="line"><span class="comment">// unstable_NormalPriority: Scheduler_NormalPriority,</span></span><br><span class="line"><span class="comment">// unstable_LowPriority: Scheduler_LowPriority,</span></span><br><span class="line"><span class="comment">// unstable_IdlePriority: Scheduler_IdlePriority,</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentPriorityLevel</span>(<span class="params"></span>): <span class="title">ReactPriorityLevel</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (Scheduler_getCurrentPriorityLevel()) &#123;</span><br><span class="line">    <span class="keyword">case</span> Scheduler_ImmediatePriority:</span><br><span class="line">      <span class="keyword">return</span> ImmediatePriority;</span><br><span class="line">    <span class="keyword">case</span> Scheduler_UserBlockingPriority:</span><br><span class="line">      <span class="keyword">return</span> UserBlockingPriority;</span><br><span class="line">    <span class="keyword">case</span> Scheduler_NormalPriority:</span><br><span class="line">      <span class="keyword">return</span> NormalPriority;</span><br><span class="line">    <span class="keyword">case</span> Scheduler_LowPriority:</span><br><span class="line">      <span class="keyword">return</span> LowPriority;</span><br><span class="line">    <span class="keyword">case</span> Scheduler_IdlePriority:</span><br><span class="line">      <span class="keyword">return</span> IdlePriority;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      invariant(<span class="literal">false</span>, <span class="string">'Unknown priority level.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首次渲染返回的结果是NormalPriority</p>
<ol start="6">
<li>schedulePendingInteractions</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">schedulePendingInteractions</span>(<span class="params">root, expirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// This is called when work is scheduled on a root.</span></span><br><span class="line">  <span class="comment">// It associates the current interactions with the newly-scheduled expiration.</span></span><br><span class="line">  <span class="comment">// They will be restored when that expiration is later committed.</span></span><br><span class="line">  <span class="keyword">if</span> (!enableSchedulerTracing) &#123; <span class="comment">// enableSchedulerTracing = true</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  scheduleInteractions(root, expirationTime, __interactionsRef.current); <span class="comment">// __interactionsRef.current = Set[]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中的<code>__interactionsRef</code>初始值是null，但何时更改了新值完全没发现。。。最一开始调用<code>createElement</code>的时候就已经是此处看到的值了。。。</p>
<ol start="7">
<li>scheduleInteractions</li>
</ol>
<p>首次渲染，不进入任何分支</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleInteractions</span>(<span class="params">root, expirationTime, interactions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!enableSchedulerTracing) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (interactions.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> pendingInteractionMap = root.pendingInteractionMap_old;</span><br><span class="line">    <span class="keyword">const</span> pendingInteractions = pendingInteractionMap.get(expirationTime);</span><br><span class="line">    <span class="keyword">if</span> (pendingInteractions != <span class="literal">null</span>) &#123;</span><br><span class="line">      interactions.forEach(<span class="function"><span class="params">interaction</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!pendingInteractions.has(interaction)) &#123;</span><br><span class="line">          <span class="comment">// Update the pending async work count for previously unscheduled interaction.</span></span><br><span class="line">          interaction.__count++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pendingInteractions.add(interaction);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      pendingInteractionMap.set(expirationTime, <span class="keyword">new</span> <span class="built_in">Set</span>(interactions));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update the pending async work count for the current interactions.</span></span><br><span class="line">      interactions.forEach(<span class="function"><span class="params">interaction</span> =&gt;</span> &#123;</span><br><span class="line">        interaction.__count++;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> subscriber = __subscriberRef.current;</span><br><span class="line">    <span class="keyword">if</span> (subscriber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> threadID = computeThreadID(root, expirationTime);</span><br><span class="line">      subscriber.onWorkScheduled(interactions, threadID);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>performSyncWorkOnRoot</li>
</ol>
<p>首次渲染走同步流程</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is the entry point for synchronous tasks that don't go</span></span><br><span class="line"><span class="comment">// through Scheduler</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performSynliuchengcWorkOnRoot</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">  invariant(</span><br><span class="line">    (executionContext &amp; (RenderContext | CommitContext)) === NoContext,</span><br><span class="line">    <span class="string">'Should not already be working.'</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  flushPassiveEffects(); <span class="comment">// 首次渲染内部不会进入分支，直接跳出</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> lastExpiredTime = root.lastExpiredTime; <span class="comment">// 首次渲染NoWork</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (lastExpiredTime !== NoWork) &#123;</span><br><span class="line">    <span class="comment">// There's expired work on this root. Check if we have a partial tree</span></span><br><span class="line">    <span class="comment">// that we can reuse.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      root === workInProgressRoot &amp;&amp;</span><br><span class="line">      renderExpirationTime &gt;= lastExpiredTime</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// There's a partial tree with equal or greater than priority than the</span></span><br><span class="line">      <span class="comment">// expired level. Finish rendering it before rendering the rest of the</span></span><br><span class="line">      <span class="comment">// expired work.</span></span><br><span class="line">      expirationTime = renderExpirationTime;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Start a fresh tree.</span></span><br><span class="line">      expirationTime = lastExpiredTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// There's no expired work. This must be a new, synchronous render.</span></span><br><span class="line">    expirationTime = Sync; <span class="comment">// 首次渲染 MAX_SIGNED_31_BIT_INT 1073741823</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> exitStatus = renderRootSync(root, expirationTime);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (root.tag !== LegacyRoot &amp;&amp; exitStatus === RootErrored) &#123;</span><br><span class="line">    executionContext |= RetryAfterError;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If an error occurred during hydration,</span></span><br><span class="line">    <span class="comment">// discard server response and fall back to client side render.</span></span><br><span class="line">    <span class="keyword">if</span> (root.hydrate) &#123;</span><br><span class="line">      root.hydrate = <span class="literal">false</span>;</span><br><span class="line">      clearContainer(root.containerInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If something threw an error, try rendering one more time. We'll</span></span><br><span class="line">    <span class="comment">// render synchronously to block concurrent data mutations, and we'll</span></span><br><span class="line">    <span class="comment">// render at Idle (or lower) so that all pending updates are included.</span></span><br><span class="line">    <span class="comment">// If it still fails after the second attempt, we'll give up and commit</span></span><br><span class="line">    <span class="comment">// the resulting tree.</span></span><br><span class="line">    expirationTime = expirationTime &gt; Idle ? Idle : expirationTime;</span><br><span class="line">    exitStatus = renderRootSync(root, expirationTime);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (exitStatus === RootFatalErrored) &#123;</span><br><span class="line">    <span class="keyword">const</span> fatalError = workInProgressRootFatalError;</span><br><span class="line">    prepareFreshStack(root, expirationTime);</span><br><span class="line">    markRootSuspendedAtTime(root, expirationTime);</span><br><span class="line">    ensureRootIsScheduled(root);</span><br><span class="line">    <span class="keyword">throw</span> fatalError;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We now have a consistent tree. Because this is a sync render, we</span></span><br><span class="line">  <span class="comment">// will commit it even if something suspended.</span></span><br><span class="line">  <span class="keyword">const</span> finishedWork: Fiber = (root.current.alternate: any);</span><br><span class="line">  root.finishedWork = finishedWork;</span><br><span class="line">  root.finishedExpirationTime = expirationTime;</span><br><span class="line">  root.nextKnownPendingLevel = getRemainingExpirationTime(finishedWork);</span><br><span class="line">  commitRoot(root);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before exiting, make sure there's a callback scheduled for the next</span></span><br><span class="line">  <span class="comment">// pending level.</span></span><br><span class="line">  ensureRootIsScheduled(root);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="9">
<li>renderRootSync</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首次渲染过程中，处理过executionContext的地方位于unbatchedUpdates中</span></span><br><span class="line"><span class="comment">// 经过如下步骤：</span></span><br><span class="line"><span class="comment">// const prevExecutionContext = executionContext;</span></span><br><span class="line"><span class="comment">// executionContext &amp;= ~BatchedContext;</span></span><br><span class="line"><span class="comment">// executionContext |= LegacyUnbatchedContext;</span></span><br><span class="line"><span class="comment">// 此时的executionContext中加入了LegacyUnbatchedContext，所以值为0b0001000，也就是8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const RenderContext = 0b0010000;</span></span><br><span class="line"><span class="comment">// let renderExpirationTime: ExpirationTime = NoWork;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRootSync</span>(<span class="params">root, expirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext; <span class="comment">// LegacyUnbatchedContext = 0b0001000</span></span><br><span class="line">  executionContext |= RenderContext; <span class="comment">// RenderContext | LegacyUnbatchedContext = 0b0011000</span></span><br><span class="line">  <span class="keyword">const</span> prevDispatcher = pushDispatcher(root); <span class="comment">// 首次渲染此处的返回值见下方</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 每太明白下面的注释</span></span><br><span class="line">  <span class="comment">// If the root or expiration time have changed, throw out the existing stack</span></span><br><span class="line">  <span class="comment">// and prepare a fresh one. Otherwise we'll continue where we left off.</span></span><br><span class="line">  <span class="keyword">if</span> (root !== workInProgressRoot || expirationTime !== renderExpirationTime) &#123; <span class="comment">// 首次渲染会进入该分支</span></span><br><span class="line">    prepareFreshStack(root, expirationTime);</span><br><span class="line">    startWorkOnPendingInteractions(root, expirationTime);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prevInteractions = pushInteractions(root);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      workLoopSync();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">      handleError(root, thrownValue);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">  resetContextDependencies();</span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    popInteractions(((prevInteractions: any): <span class="built_in">Set</span>&lt;Interaction&gt;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  executionContext = prevExecutionContext;</span><br><span class="line">  popDispatcher(prevDispatcher);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is a sync render, so we should have finished the whole tree.</span></span><br><span class="line">    invariant(</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      <span class="string">'Cannot commit an incomplete root. This error is likely caused by a '</span> +</span><br><span class="line">        <span class="string">'bug in React. Please file an issue.'</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set this to null to indicate there's no in-progress render.</span></span><br><span class="line">  workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgressRootExitStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="10">
<li>pushDispatcher</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Keeps track of the current dispatcher.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> ReactCurrentDispatcher = &#123;</span><br><span class="line">  current: (<span class="literal">null</span>: <span class="literal">null</span> | Dispatcher),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ContextOnlyDispatcher = &#123;</span><br><span class="line">  readContext,</span><br><span class="line">  useCallback: throwInvalidHookError,</span><br><span class="line">  useContext: throwInvalidHookError,</span><br><span class="line">  useEffect: throwInvalidHookError,</span><br><span class="line">  useImperativeHandle: throwInvalidHookError,</span><br><span class="line">  useLayoutEffect: throwInvalidHookError,</span><br><span class="line">  useMemo: throwInvalidHookError,</span><br><span class="line">  useReducer: throwInvalidHookError,</span><br><span class="line">  useRef: throwInvalidHookError,</span><br><span class="line">  useState: throwInvalidHookError,</span><br><span class="line">  useDebugValue: throwInvalidHookError,</span><br><span class="line">  useResponder: throwInvalidHookError,</span><br><span class="line">  useDeferredValue: throwInvalidHookError,</span><br><span class="line">  useTransition: throwInvalidHookError,</span><br><span class="line">  useMutableSource: throwInvalidHookError,</span><br><span class="line">  useOpaqueIdentifier: throwInvalidHookError,</span><br><span class="line"></span><br><span class="line">  unstable_isNewReconciler: enableNewReconciler,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushDispatcher</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevDispatcher = ReactCurrentDispatcher.current;</span><br><span class="line">  ReactCurrentDispatcher.current = ContextOnlyDispatcher;</span><br><span class="line">  <span class="keyword">if</span> (prevDispatcher === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// The React isomorphic package does not include a default dispatcher.</span></span><br><span class="line">    <span class="comment">// Instead the first renderer will lazily attach one, in order to give</span></span><br><span class="line">    <span class="comment">// nicer error messages.</span></span><br><span class="line">    <span class="keyword">return</span> ContextOnlyDispatcher; <span class="comment">// 这里返回ContextOnlyDispatcher（感觉像是和Hook相关的）</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> prevDispatcher;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="11">
<li>prepareFreshStack</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// export const noTimeout = -1;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // The root we're working on</span></span><br><span class="line"><span class="comment">// let workInProgressRoot: FiberRoot | null = null;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // The fiber we're working on</span></span><br><span class="line"><span class="comment">// let workInProgress: Fiber | null = null;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const RootIncomplete = 0;</span></span><br><span class="line"><span class="comment">// // Whether to root completed, errored, suspended, etc.</span></span><br><span class="line"><span class="comment">// let workInProgressRootExitStatus: RootExitStatus = RootIncomplete;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // A fatal error, if one is thrown</span></span><br><span class="line"><span class="comment">// let workInProgressRootFatalError: mixed = null;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // Most recent event time among processed updates during this render.</span></span><br><span class="line"><span class="comment">// // This is conceptually a time stamp but expressed in terms of an ExpirationTime</span></span><br><span class="line"><span class="comment">// // because we deal mostly with expiration times in the hot path, so this avoids</span></span><br><span class="line"><span class="comment">// // the conversion happening in the hot path.</span></span><br><span class="line"><span class="comment">// let workInProgressRootLatestProcessedExpirationTime: ExpirationTime = Sync;</span></span><br><span class="line"><span class="comment">// let workInProgressRootLatestSuspenseTimeout: ExpirationTime = Sync;</span></span><br><span class="line"><span class="comment">// let workInProgressRootCanSuspendUsingConfig: null | SuspenseConfig = null;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // The work left over by components that were visited during this render. Only</span></span><br><span class="line"><span class="comment">// // includes unprocessed updates, not work in bailed out children.</span></span><br><span class="line"><span class="comment">// let workInProgressRootNextUnprocessedUpdateTime: ExpirationTime = NoWork;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // If we're pinged while rendering we don't always restart immediately.</span></span><br><span class="line"><span class="comment">// // This flag determines if it might be worthwhile to restart if an opportunity</span></span><br><span class="line"><span class="comment">// // happens latere.</span></span><br><span class="line"><span class="comment">// let workInProgressRootHasPendingPing: boolean = false;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // Marks the need to reschedule pending interactions at these expiration times</span></span><br><span class="line"><span class="comment">// // during the commit phase. This enables them to be traced across components</span></span><br><span class="line"><span class="comment">// // that spawn new work during render. E.g. hidden boundaries, suspended SSR</span></span><br><span class="line"><span class="comment">// // hydration or SuspenseList.</span></span><br><span class="line"><span class="comment">// let spawnedWorkDuringRender: null | Array&lt;ExpirationTime&gt; = null;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prepareFreshStack</span>(<span class="params">root, expirationTime</span>) </span>&#123;</span><br><span class="line">  root.finishedWork = <span class="literal">null</span>;</span><br><span class="line">  root.finishedExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> timeoutHandle = root.timeoutHandle; <span class="comment">// 首次渲染时 -1</span></span><br><span class="line">  <span class="keyword">if</span> (timeoutHandle !== noTimeout) &#123; <span class="comment">// 首次渲染不进入该分支</span></span><br><span class="line">    <span class="comment">// The root previous suspended and scheduled a timeout to commit a fallback</span></span><br><span class="line">    <span class="comment">// state. Now that we have additional work, cancel the timeout.</span></span><br><span class="line">    root.timeoutHandle = noTimeout;</span><br><span class="line">    <span class="comment">// $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above</span></span><br><span class="line">    cancelTimeout(timeoutHandle);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there's a suspended level at lower priority.</span></span><br><span class="line">  <span class="keyword">const</span> lastSuspendedTime = root.lastSuspendedTime; <span class="comment">// 0</span></span><br><span class="line">  <span class="keyword">if</span> (lastSuspendedTime !== NoWork &amp;&amp; lastSuspendedTime &lt; expirationTime) &#123; <span class="comment">// 首次渲染不进入该分支</span></span><br><span class="line">    <span class="keyword">const</span> lastPingedTime = root.lastPingedTime;</span><br><span class="line">    <span class="comment">// Make sure the suspended level is marked as pinged so that we return back</span></span><br><span class="line">    <span class="comment">// to it later, in case the render we're about to start gets aborted.</span></span><br><span class="line">    <span class="comment">// Generally we only reach this path via a ping, but we shouldn't assume</span></span><br><span class="line">    <span class="comment">// that will always be the case.</span></span><br><span class="line">    <span class="comment">// Note: This is defensive coding to prevent a pending commit from</span></span><br><span class="line">    <span class="comment">// being dropped without being rescheduled. It shouldn't be necessary.</span></span><br><span class="line">    <span class="keyword">if</span> (lastPingedTime === NoWork || lastPingedTime &gt; lastSuspendedTime) &#123;</span><br><span class="line">      root.lastPingedTime = lastSuspendedTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (workInProgress !== <span class="literal">null</span>) &#123; <span class="comment">// 首次渲染不进入该分支</span></span><br><span class="line">    <span class="keyword">let</span> interruptedWork = workInProgress.return;</span><br><span class="line">    <span class="keyword">while</span> (interruptedWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">      unwindInterruptedWork(interruptedWork);</span><br><span class="line">      interruptedWork = interruptedWork.return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  workInProgressRoot = root;</span><br><span class="line">  workInProgress = createWorkInProgress(root.current, <span class="literal">null</span>);</span><br><span class="line">  renderExpirationTime = expirationTime;</span><br><span class="line">  workInProgressRootExitStatus = RootIncomplete;</span><br><span class="line">  workInProgressRootFatalError = <span class="literal">null</span>;</span><br><span class="line">  workInProgressRootLatestProcessedExpirationTime = Sync;</span><br><span class="line">  workInProgressRootLatestSuspenseTimeout = Sync;</span><br><span class="line">  workInProgressRootCanSuspendUsingConfig = <span class="literal">null</span>;</span><br><span class="line">  workInProgressRootNextUnprocessedUpdateTime = NoWork;</span><br><span class="line">  workInProgressRootHasPendingPing = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    spawnedWorkDuringRender = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="12">
<li>createWorkInProgress</li>
</ol>
<p>首次渲染时的调用：<code>createWorkInProgress(root.current, null);</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此时的current</span></span><br><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span>,</span><br><span class="line">  actualStartTime: <span class="number">-1</span>,</span><br><span class="line">  alternate: <span class="literal">null</span>,</span><br><span class="line">  child: <span class="literal">null</span>,</span><br><span class="line">  childExpirationTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span>,</span><br><span class="line">  effectTag: NoEffect, <span class="comment">// 0</span></span><br><span class="line">  elementType: <span class="literal">null</span>,</span><br><span class="line">  expirationTime: NoWork, <span class="comment">// 0</span></span><br><span class="line">  firstEffect: <span class="literal">null</span>,</span><br><span class="line">  index: <span class="number">0</span>,</span><br><span class="line">  key: <span class="literal">null</span>,</span><br><span class="line">  lastEffect: <span class="literal">null</span>,</span><br><span class="line">  memoizedProps: <span class="literal">null</span>,</span><br><span class="line">  memoizedState: <span class="literal">null</span>,</span><br><span class="line">  mode: NoMode, <span class="comment">// 0</span></span><br><span class="line">  nextEffect: <span class="literal">null</span>,</span><br><span class="line">  pendingProps: <span class="literal">null</span>,</span><br><span class="line">  ref: <span class="literal">null</span>,</span><br><span class="line">  <span class="keyword">return</span>: <span class="literal">null</span>,</span><br><span class="line">  setBaseDuration: <span class="number">0</span>,</span><br><span class="line">  sibling: <span class="literal">null</span>,</span><br><span class="line">  stateNode: container,</span><br><span class="line">  tag: HostRoot, <span class="comment">// 3</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span>,</span><br><span class="line">  type: <span class="literal">null</span>,</span><br><span class="line">  updateQueue: &#123;</span><br><span class="line">    baseState: <span class="literal">null</span>,</span><br><span class="line">    effects: <span class="literal">null</span>,</span><br><span class="line">    firstBaseUpdate: <span class="literal">null</span>,</span><br><span class="line">    lastBaseUpdate: <span class="literal">null</span>,</span><br><span class="line">    shared: &#123;</span><br><span class="line">      pending: <span class="literal">null</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// This is used to create an alternate fiber to do work on.</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createWorkInProgress</span>(<span class="params">current: Fiber, pendingProps: any</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> workInProgress = current.alternate; <span class="comment">// 首次渲染 null</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgress === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We use a double buffering pooling technique because we know that we'll</span></span><br><span class="line">    <span class="comment">// only ever need at most two versions of a tree. We pool the "other" unused</span></span><br><span class="line">    <span class="comment">// node that we're free to reuse. This is lazily created to avoid allocating</span></span><br><span class="line">    <span class="comment">// extra objects for things that are never updated. It also allow us to</span></span><br><span class="line">    <span class="comment">// reclaim the extra memory if needed.</span></span><br><span class="line">    workInProgress = createFiber(</span><br><span class="line">      current.tag,</span><br><span class="line">      pendingProps,</span><br><span class="line">      current.key,</span><br><span class="line">      current.mode,</span><br><span class="line">    );</span><br><span class="line">    workInProgress.elementType = current.elementType;</span><br><span class="line">    workInProgress.type = current.type;</span><br><span class="line">    workInProgress.stateNode = current.stateNode;</span><br><span class="line">    <span class="comment">// 上面的操作相当于半深拷贝了一个root对应的Fiber为workInProgress</span></span><br><span class="line">    <span class="comment">// 然后通过Fiber的alternate属性将current和workInProgress两个Fiber相互引用</span></span><br><span class="line">    workInProgress.alternate = current; </span><br><span class="line">    current.alternate = workInProgress;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress.pendingProps = pendingProps;</span><br><span class="line">    <span class="comment">// Needed because Blocks store data on type.</span></span><br><span class="line">    workInProgress.type = current.type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We already have an alternate.</span></span><br><span class="line">    <span class="comment">// Reset the effect tag.</span></span><br><span class="line">    workInProgress.effectTag = NoEffect;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The effect list is no longer valid.</span></span><br><span class="line">    workInProgress.nextEffect = <span class="literal">null</span>;</span><br><span class="line">    workInProgress.firstEffect = <span class="literal">null</span>;</span><br><span class="line">    workInProgress.lastEffect = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      <span class="comment">// We intentionally reset, rather than copy, actualDuration &amp; actualStartTime.</span></span><br><span class="line">      <span class="comment">// This prevents time from endlessly accumulating in new commits.</span></span><br><span class="line">      <span class="comment">// This has the downside of resetting values for different priority renders,</span></span><br><span class="line">      <span class="comment">// But works for yielding (the common case) and should support resuming.</span></span><br><span class="line">      workInProgress.actualDuration = <span class="number">0</span>;</span><br><span class="line">      workInProgress.actualStartTime = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  workInProgress.childExpirationTime = current.childExpirationTime;</span><br><span class="line">  workInProgress.expirationTime = current.expirationTime;</span><br><span class="line"></span><br><span class="line">  workInProgress.child = current.child;</span><br><span class="line">  workInProgress.memoizedProps = current.memoizedProps;</span><br><span class="line">  workInProgress.memoizedState = current.memoizedState;</span><br><span class="line">  workInProgress.updateQueue = current.updateQueue;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clone the dependencies object. This is mutated during the render phase, so</span></span><br><span class="line">  <span class="comment">// it cannot be shared with the current fiber.</span></span><br><span class="line">  <span class="keyword">const</span> currentDependencies = current.dependencies_old;</span><br><span class="line">  workInProgress.dependencies_old =</span><br><span class="line">    currentDependencies === <span class="literal">null</span></span><br><span class="line">      ? <span class="literal">null</span></span><br><span class="line">      : &#123;</span><br><span class="line">          expirationTime: currentDependencies.expirationTime,</span><br><span class="line">          firstContext: currentDependencies.firstContext,</span><br><span class="line">          responders: currentDependencies.responders,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// These will be overridden during the parent's reconciliation</span></span><br><span class="line">  workInProgress.sibling = current.sibling;</span><br><span class="line">  workInProgress.index = current.index;</span><br><span class="line">  workInProgress.ref = current.ref;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">    workInProgress.selfBaseDuration = current.selfBaseDuration;</span><br><span class="line">    workInProgress.treeBaseDuration = current.treeBaseDuration;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="13">
<li>schedulePendingInteractions</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">schedulePendingInteractions</span>(<span class="params">root, expirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// This is called when work is scheduled on a root.</span></span><br><span class="line">  <span class="comment">// It associates the current interactions with the newly-scheduled expiration.</span></span><br><span class="line">  <span class="comment">// They will be restored when that expiration is later committed.</span></span><br><span class="line">  <span class="keyword">if</span> (!enableSchedulerTracing) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  scheduleInteractions(root, expirationTime, __interactionsRef.current);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="14">
<li>scheduleInteractions</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleInteractions</span>(<span class="params">root, expirationTime, interactions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!enableSchedulerTracing) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (interactions.size &gt; <span class="number">0</span>) &#123; <span class="comment">// 首次渲染不会进入该分支</span></span><br><span class="line">    <span class="keyword">const</span> pendingInteractionMap = root.pendingInteractionMap_old;</span><br><span class="line">    <span class="keyword">const</span> pendingInteractions = pendingInteractionMap.get(expirationTime);</span><br><span class="line">    <span class="keyword">if</span> (pendingInteractions != <span class="literal">null</span>) &#123;</span><br><span class="line">      interactions.forEach(<span class="function"><span class="params">interaction</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!pendingInteractions.has(interaction)) &#123;</span><br><span class="line">          <span class="comment">// Update the pending async work count for previously unscheduled interaction.</span></span><br><span class="line">          interaction.__count++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pendingInteractions.add(interaction);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      pendingInteractionMap.set(expirationTime, <span class="keyword">new</span> <span class="built_in">Set</span>(interactions));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update the pending async work count for the current interactions.</span></span><br><span class="line">      interactions.forEach(<span class="function"><span class="params">interaction</span> =&gt;</span> &#123;</span><br><span class="line">        interaction.__count++;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> subscriber = __subscriberRef.current;</span><br><span class="line">    <span class="keyword">if</span> (subscriber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> threadID = computeThreadID(root, expirationTime);</span><br><span class="line">      subscriber.onWorkScheduled(interactions, threadID);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="15">
<li>pushInteractions</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushInteractions</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevInteractions: <span class="built_in">Set</span>&lt;Interaction&gt; | <span class="literal">null</span> = __interactionsRef.current;</span><br><span class="line">    __interactionsRef.current = root.memoizedInteractions;</span><br><span class="line">    <span class="keyword">return</span> prevInteractions;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="16">
<li>workLoopSync</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The work loop is an extremely hot path. Tell Closure not to inline it.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoopSync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    performUnitOfWork(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="17">
<li>performUnitOfWork</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// renderExpirationTime的值在执行prepareFreshStack函数时被赋予了新值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoMode = <span class="number">0b00000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> StrictMode = <span class="number">0b00001</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> BlockingMode = <span class="number">0b00010</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ConcurrentMode = <span class="number">0b00100</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ProfileMode = <span class="number">0b01000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DebugTracingMode = <span class="number">0b10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The current, flushed, state of this fiber is the alternate. Ideally</span></span><br><span class="line">  <span class="comment">// nothing should rely on this, but relying on it here means that we don't</span></span><br><span class="line">  <span class="comment">// need an additional field on the work in progress.</span></span><br><span class="line">  <span class="keyword">const</span> current = unitOfWork.alternate;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> next;</span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; (unitOfWork.mode &amp; ProfileMode) !== NoMode) &#123;</span><br><span class="line">    startProfilerTimer(unitOfWork);</span><br><span class="line">    next = beginWork(current, unitOfWork, renderExpirationTime);</span><br><span class="line">    stopProfilerTimerIfRunningAndRecordDelta(unitOfWork, <span class="literal">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// 首次渲染进入该分支</span></span><br><span class="line">    next = beginWork(current, unitOfWork, renderExpirationTime);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unitOfWork.memoizedProps = unitOfWork.pendingProps;</span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If this doesn't spawn new work, complete the current work.</span></span><br><span class="line">    completeUnitOfWork(unitOfWork);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress = next;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="18">
<li>beginWork</li>
</ol>
<p>这个函数也太长了吧。。。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FunctionComponent = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ClassComponent = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IndeterminateComponent = <span class="number">2</span>; <span class="comment">// Before we know whether it is function or class</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostRoot = <span class="number">3</span>; <span class="comment">// Root of a host tree. Could be nested inside another node.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostPortal = <span class="number">4</span>; <span class="comment">// A subtree. Could be an entry point to a different renderer.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostComponent = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HostText = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Fragment = <span class="number">7</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Mode = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ContextConsumer = <span class="number">9</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ContextProvider = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ForwardRef = <span class="number">11</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Profiler = <span class="number">12</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SuspenseComponent = <span class="number">13</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> MemoComponent = <span class="number">14</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SimpleMemoComponent = <span class="number">15</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LazyComponent = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IncompleteClassComponent = <span class="number">17</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DehydratedFragment = <span class="number">18</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SuspenseListComponent = <span class="number">19</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FundamentalComponent = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ScopeComponent = <span class="number">21</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Block = <span class="number">22</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> OffscreenComponent = <span class="number">23</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LegacyHiddenComponent = <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 首次expirationTime为0</span></span><br><span class="line">  <span class="keyword">const</span> updateExpirationTime = workInProgress.expirationTime;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldProps = current.memoizedProps;</span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.pendingProps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      oldProps !== newProps ||</span><br><span class="line">      hasLegacyContextChanged() ||</span><br><span class="line">      <span class="comment">// Force a re-render if the implementation changed due to hot reload:</span></span><br><span class="line">      (__DEV__ ? workInProgress.type !== current.type : <span class="literal">false</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// If props or context changed, mark the fiber as having performed work.</span></span><br><span class="line">      <span class="comment">// This may be unset if the props are determined to be equal later (memo).</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123; <span class="comment">// updateExpirationTime = renderExpirationTime = 1073741823</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">      <span class="comment">// This fiber does not have any pending work. Bailout without entering</span></span><br><span class="line">      <span class="comment">// the begin phase. There's still some bookkeeping we that needs to be done</span></span><br><span class="line">      <span class="comment">// in this optimized path, mostly pushing stuff onto the stack.</span></span><br><span class="line">      <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> HostRoot:</span><br><span class="line">          pushHostRootContext(workInProgress);</span><br><span class="line">          resetHydrationState();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HostComponent:</span><br><span class="line">          pushHostContext(workInProgress);</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            workInProgress.mode &amp; ConcurrentMode &amp;&amp;</span><br><span class="line">            renderExpirationTime !== Never &amp;&amp;</span><br><span class="line">            shouldDeprioritizeSubtree(workInProgress.type, newProps)</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">              markSpawnedWork(Never);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Schedule this fiber to re-render at offscreen priority. Then bailout.</span></span><br><span class="line">            workInProgress.expirationTime = workInProgress.childExpirationTime = Never;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">          <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">            pushLegacyContextProvider(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostPortal:</span><br><span class="line">          pushHostContainer(</span><br><span class="line">            workInProgress,</span><br><span class="line">            workInProgress.stateNode.containerInfo,</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ContextProvider: &#123;</span><br><span class="line">          <span class="keyword">const</span> newValue = workInProgress.memoizedProps.value;</span><br><span class="line">          pushProvider(workInProgress, newValue);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> Profiler:</span><br><span class="line">          <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">            <span class="comment">// Profiler should only call onRender when one of its descendants actually rendered.</span></span><br><span class="line">            <span class="keyword">const</span> hasChildWork =</span><br><span class="line">              workInProgress.childExpirationTime &gt;= renderExpirationTime;</span><br><span class="line">            <span class="keyword">if</span> (hasChildWork) &#123;</span><br><span class="line">              workInProgress.effectTag |= Update;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Reset effect durations for the next eventual effect phase.</span></span><br><span class="line">            <span class="comment">// These are reset during render to allow the DevTools commit hook a chance to read them,</span></span><br><span class="line">            <span class="keyword">const</span> stateNode = workInProgress.stateNode;</span><br><span class="line">            stateNode.effectDuration = <span class="number">0</span>;</span><br><span class="line">            stateNode.passiveEffectDuration = <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> state: SuspenseState | <span class="literal">null</span> = workInProgress.memoizedState;</span><br><span class="line">          <span class="keyword">if</span> (state !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (enableSuspenseServerRenderer) &#123;</span><br><span class="line">              <span class="keyword">if</span> (state.dehydrated !== <span class="literal">null</span>) &#123;</span><br><span class="line">                pushSuspenseContext(</span><br><span class="line">                  workInProgress,</span><br><span class="line">                  setDefaultShallowSuspenseContext(suspenseStackCursor.current),</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// We know that this component will suspend again because if it has</span></span><br><span class="line">                <span class="comment">// been unsuspended it has committed as a resolved Suspense component.</span></span><br><span class="line">                <span class="comment">// If it needs to be retried, it should have work scheduled on it.</span></span><br><span class="line">                workInProgress.effectTag |= DidCapture;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this boundary is currently timed out, we need to decide</span></span><br><span class="line">            <span class="comment">// whether to retry the primary children, or to skip over it and</span></span><br><span class="line">            <span class="comment">// go straight to the fallback. Check the priority of the primary</span></span><br><span class="line">            <span class="comment">// child fragment.</span></span><br><span class="line">            <span class="keyword">const</span> primaryChildFragment: Fiber = (workInProgress.child: any);</span><br><span class="line">            <span class="keyword">const</span> primaryChildExpirationTime =</span><br><span class="line">              primaryChildFragment.childExpirationTime;</span><br><span class="line">            <span class="keyword">if</span> (primaryChildExpirationTime &gt;= renderExpirationTime) &#123;</span><br><span class="line">              <span class="comment">// The primary children have pending work. Use the normal path</span></span><br><span class="line">              <span class="comment">// to attempt to render the primary children again.</span></span><br><span class="line">              <span class="keyword">return</span> updateSuspenseComponent(</span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">              );</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// The primary child fragment does not have pending work marked</span></span><br><span class="line">              <span class="comment">// on it...</span></span><br><span class="line"></span><br><span class="line">              <span class="comment">// ...usually. There's an unfortunate edge case where the fragment</span></span><br><span class="line">              <span class="comment">// fiber is not part of the return path of the children, so when</span></span><br><span class="line">              <span class="comment">// an update happens, the fragment doesn't get marked during</span></span><br><span class="line">              <span class="comment">// setState. This is something we should consider addressing when</span></span><br><span class="line">              <span class="comment">// we refactor the Fiber data structure. (There's a test with more</span></span><br><span class="line">              <span class="comment">// details; to find it, comment out the following block and see</span></span><br><span class="line">              <span class="comment">// which one fails.)</span></span><br><span class="line">              <span class="comment">//</span></span><br><span class="line">              <span class="comment">// As a workaround, we need to recompute the `childExpirationTime`</span></span><br><span class="line">              <span class="comment">// by bubbling it up from the next level of children. This is</span></span><br><span class="line">              <span class="comment">// based on similar logic in `resetChildExpirationTime`.</span></span><br><span class="line">              <span class="keyword">let</span> primaryChild = primaryChildFragment.child;</span><br><span class="line">              <span class="keyword">while</span> (primaryChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> childUpdateExpirationTime = primaryChild.expirationTime;</span><br><span class="line">                <span class="keyword">const</span> childChildExpirationTime =</span><br><span class="line">                  primaryChild.childExpirationTime;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                  childUpdateExpirationTime &gt;= renderExpirationTime ||</span><br><span class="line">                  childChildExpirationTime &gt;= renderExpirationTime</span><br><span class="line">                ) &#123;</span><br><span class="line">                  <span class="comment">// Found a child with an update with sufficient priority.</span></span><br><span class="line">                  <span class="comment">// Use the normal path to render the primary children again.</span></span><br><span class="line">                  <span class="keyword">return</span> updateSuspenseComponent(</span><br><span class="line">                    current,</span><br><span class="line">                    workInProgress,</span><br><span class="line">                    renderExpirationTime,</span><br><span class="line">                  );</span><br><span class="line">                &#125;</span><br><span class="line">                primaryChild = primaryChild.sibling;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              pushSuspenseContext(</span><br><span class="line">                workInProgress,</span><br><span class="line">                setDefaultShallowSuspenseContext(suspenseStackCursor.current),</span><br><span class="line">              );</span><br><span class="line">              <span class="comment">// The primary children do not have pending work with sufficient</span></span><br><span class="line">              <span class="comment">// priority. Bailout.</span></span><br><span class="line">              <span class="keyword">const</span> child = bailoutOnAlreadyFinishedWork(</span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">              );</span><br><span class="line">              <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// The fallback children have pending work. Skip over the</span></span><br><span class="line">                <span class="comment">// primary children and work on the fallback.</span></span><br><span class="line">                <span class="keyword">return</span> child.sibling;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pushSuspenseContext(</span><br><span class="line">              workInProgress,</span><br><span class="line">              setDefaultShallowSuspenseContext(suspenseStackCursor.current),</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> didSuspendBefore =</span><br><span class="line">            (current.effectTag &amp; DidCapture) !== NoEffect;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> hasChildWork =</span><br><span class="line">            workInProgress.childExpirationTime &gt;= renderExpirationTime;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (didSuspendBefore) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasChildWork) &#123;</span><br><span class="line">              <span class="comment">// If something was in fallback state last time, and we have all the</span></span><br><span class="line">              <span class="comment">// same children then we're still in progressive loading state.</span></span><br><span class="line">              <span class="comment">// Something might get unblocked by state updates or retries in the</span></span><br><span class="line">              <span class="comment">// tree which will affect the tail. So we need to use the normal</span></span><br><span class="line">              <span class="comment">// path to compute the correct tail.</span></span><br><span class="line">              <span class="keyword">return</span> updateSuspenseListComponent(</span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">              );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If none of the children had any work, that means that none of</span></span><br><span class="line">            <span class="comment">// them got retried so they'll still be blocked in the same way</span></span><br><span class="line">            <span class="comment">// as before. We can fast bail out.</span></span><br><span class="line">            workInProgress.effectTag |= DidCapture;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// If nothing suspended before and we're rendering the same children,</span></span><br><span class="line">          <span class="comment">// then the tail doesn't matter. Anything new that suspends will work</span></span><br><span class="line">          <span class="comment">// in the "together" mode, so we can continue from the state we had.</span></span><br><span class="line">          <span class="keyword">const</span> renderState = workInProgress.memoizedState;</span><br><span class="line">          <span class="keyword">if</span> (renderState !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Reset to the "together" mode in case we've started a different</span></span><br><span class="line">            <span class="comment">// update in the past but didn't complete it.</span></span><br><span class="line">            renderState.rendering = <span class="literal">null</span>;</span><br><span class="line">            renderState.tail = <span class="literal">null</span>;</span><br><span class="line">            renderState.lastEffect = <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          pushSuspenseContext(workInProgress, suspenseStackCursor.current);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (hasChildWork) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If none of the children had any work, that means that none of</span></span><br><span class="line">            <span class="comment">// them got retried so they'll still be blocked in the same way</span></span><br><span class="line">            <span class="comment">// as before. We can fast bail out.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// An update was scheduled on this fiber, but there are no new props</span></span><br><span class="line">      <span class="comment">// nor legacy context. Set this to false. If an update queue or context</span></span><br><span class="line">      <span class="comment">// consumer produces a changed value, it will set this to true. Otherwise,</span></span><br><span class="line">      <span class="comment">// the component will assume the children have not changed and bail out.</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span>; <span class="comment">// 首次渲染直接到这里</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before entering the begin phase, clear pending update priority.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This assumes that we're about to evaluate the component and process</span></span><br><span class="line">  <span class="comment">// the update queue. However, there's an exception: SimpleMemoComponent</span></span><br><span class="line">  <span class="comment">// sometimes bails out later in the begin phase. This indicates that we should</span></span><br><span class="line">  <span class="comment">// move this assignment out of the common path and into each branch.</span></span><br><span class="line">  workInProgress.expirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> IndeterminateComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span> mountIndeterminateComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        workInProgress.type,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> LazyComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> elementType = workInProgress.elementType;</span><br><span class="line">      <span class="keyword">return</span> mountLazyComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        elementType,</span><br><span class="line">        updateExpirationTime,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateFunctionComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot: <span class="comment">// 首次渲染第一次进入这个分支</span></span><br><span class="line">      <span class="keyword">return</span> updateHostRoot(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">      <span class="keyword">return</span> updateHostComponent(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> HostText:</span><br><span class="line">      <span class="keyword">return</span> updateHostText(current, workInProgress);</span><br><span class="line">    <span class="keyword">case</span> SuspenseComponent:</span><br><span class="line">      <span class="keyword">return</span> updateSuspenseComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">      <span class="keyword">return</span> updatePortalComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> ForwardRef: &#123;</span><br><span class="line">      <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === type</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(type, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateForwardRef(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        type,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Fragment:</span><br><span class="line">      <span class="keyword">return</span> updateFragment(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> Mode:</span><br><span class="line">      <span class="keyword">return</span> updateMode(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> Profiler:</span><br><span class="line">      <span class="keyword">return</span> updateProfiler(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> ContextProvider:</span><br><span class="line">      <span class="keyword">return</span> updateContextProvider(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> ContextConsumer:</span><br><span class="line">      <span class="keyword">return</span> updateContextConsumer(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> MemoComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="comment">// Resolve outer props first, then resolve inner props.</span></span><br><span class="line">      <span class="keyword">let</span> resolvedProps = resolveDefaultProps(type, unresolvedProps);</span><br><span class="line">      resolvedProps = resolveDefaultProps(type.type, resolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateMemoComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        type,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        updateExpirationTime,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span> updateSimpleMemoComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        workInProgress.type,</span><br><span class="line">        workInProgress.pendingProps,</span><br><span class="line">        updateExpirationTime,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> mountIncompleteClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span> updateSuspenseListComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> FundamentalComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableFundamentalAPI) &#123;</span><br><span class="line">        <span class="keyword">return</span> updateFundamentalComponent(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ScopeComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">        <span class="keyword">return</span> updateScopeComponent(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Block: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableBlocksAPI) &#123;</span><br><span class="line">        <span class="keyword">const</span> block = workInProgress.type;</span><br><span class="line">        <span class="keyword">const</span> props = workInProgress.pendingProps;</span><br><span class="line">        <span class="keyword">return</span> updateBlock(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          block,</span><br><span class="line">          props,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  invariant(</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">'Unknown unit of work tag (%s). This error is likely caused by a bug in '</span> +</span><br><span class="line">      <span class="string">'React. Please file an issue.'</span>,</span><br><span class="line">    workInProgress.tag,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>=================================================================</p>
<p><em>注意：由于判断失误。。。首次渲染不会调用19~26号函数。。。</em></p>
<ol start="19">
<li>pushHostRootContext</li>
</ol>
<p>首次渲染时，处理root对应的fiber时会调用这个函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushHostRootContext</span>(<span class="params">workInProgress</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = (workInProgress.stateNode: FiberRoot);</span><br><span class="line">  <span class="keyword">if</span> (root.pendingContext) &#123; <span class="comment">// root.pengingContext = null</span></span><br><span class="line">    pushTopLevelContextObject(</span><br><span class="line">      workInProgress,</span><br><span class="line">      root.pendingContext,</span><br><span class="line">      root.pendingContext !== root.context,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (root.context) &#123; <span class="comment">// root.context = &#123;&#125;</span></span><br><span class="line">    <span class="comment">// Should always be set</span></span><br><span class="line">    pushTopLevelContextObject(workInProgress, root.context, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  pushHostContainer(workInProgress, root.containerInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="20">
<li>pushTopLevelContextObject</li>
</ol>
<p>首次渲染的调用： <code>pushTopLevelContextObject(workInProgress, root.context, false);</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushTopLevelContextObject</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  context: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  didChange: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (disableLegacyContext) &#123; <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    invariant(</span><br><span class="line">      contextStackCursor.current === emptyContextObject,</span><br><span class="line">      <span class="string">'Unexpected context found on stack. '</span> +</span><br><span class="line">        <span class="string">'This error is likely caused by a bug in React. Please file an issue.'</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// contextStackCursor = &#123; current: &#123;&#125; &#125;</span></span><br><span class="line">    <span class="comment">// context = &#123;&#125;</span></span><br><span class="line">    <span class="comment">// 首次渲染执行完这个函数的结果是</span></span><br><span class="line">    <span class="comment">// index = 0</span></span><br><span class="line">    <span class="comment">// valueStack = [&#123;&#125;]</span></span><br><span class="line">    <span class="comment">// contextStackCursor = &#123; current: &#123;&#125; &#125; current的值变为新的空对象</span></span><br><span class="line">    push(contextStackCursor, context, fiber);</span><br><span class="line">    <span class="comment">// didPerformWorkStackCursor = &#123; current: false &#125;</span></span><br><span class="line">    <span class="comment">// didChange = false</span></span><br><span class="line">    <span class="comment">// 就结果而言没有变化</span></span><br><span class="line">    push(didPerformWorkStackCursor, didChange, fiber);</span><br><span class="line">    <span class="comment">// 上面两个函数执行完的结果：</span></span><br><span class="line">    <span class="comment">// index = 1</span></span><br><span class="line">    <span class="comment">// valueStack = [&#123;&#125;, false]</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="21">
<li>push</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index = -1</span></span><br><span class="line"><span class="comment">// valueStack = []</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">push</span>&lt;<span class="title">T</span>&gt;(<span class="params">cursor: StackCursor&lt;T&gt;, value: T, fiber: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  index++;</span><br><span class="line"></span><br><span class="line">  valueStack[index] = cursor.current;</span><br><span class="line"></span><br><span class="line">  cursor.current = value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="22">
<li>pushHostContainer</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行下面指令之前的相关变量值</span></span><br><span class="line"><span class="comment">// index = 1</span></span><br><span class="line"><span class="comment">// valueStack = [&#123;&#125;, false]</span></span><br><span class="line"><span class="comment">// 分别是：contextStackCursor和didPerformWorkStackCursor</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const NO_CONTEXT: NoContextT = (&#123;&#125;: any);</span></span><br><span class="line"><span class="comment">// const rootInstanceStackCursor: StackCursor&lt;</span></span><br><span class="line"><span class="comment">//   Container | NoContextT,</span></span><br><span class="line"><span class="comment">// &gt; = createCursor(NO_CONTEXT);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const contextStackCursor: StackCursor&lt;HostContext | NoContextT&gt; = createCursor(</span></span><br><span class="line"><span class="comment">//   NO_CONTEXT,</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"><span class="comment">// const contextFiberStackCursor: StackCursor&lt;Fiber | NoContextT&gt; = createCursor(</span></span><br><span class="line"><span class="comment">//   NO_CONTEXT,</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushHostContainer</span>(<span class="params">fiber: Fiber, nextRootInstance: Container</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Push current root instance onto the stack;</span></span><br><span class="line">  <span class="comment">// This allows us to reset root when portals are popped.</span></span><br><span class="line">  <span class="comment">// index = 2</span></span><br><span class="line">  <span class="comment">// valueStack = [&#123;&#125;, false, &#123;&#125;]</span></span><br><span class="line">  <span class="comment">// rootInstanceStackCursor = &#123; current: container &#125;</span></span><br><span class="line">  push(rootInstanceStackCursor, nextRootInstance, fiber);</span><br><span class="line">  <span class="comment">// Track the context and the Fiber that provided it.</span></span><br><span class="line">  <span class="comment">// This enables us to pop only Fibers that provide unique contexts.</span></span><br><span class="line">  <span class="comment">// index = 3</span></span><br><span class="line">  <span class="comment">// valueStack = [&#123;&#125;, false, &#123;&#125;, &#123;&#125;]</span></span><br><span class="line">  <span class="comment">// contextFiberStackCursor = &#123; current: workInProgress &#125;</span></span><br><span class="line">  push(contextFiberStackCursor, fiber, fiber);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Finally, we need to push the host context to the stack.</span></span><br><span class="line">  <span class="comment">// However, we can't just call getRootHostContext() and push it because</span></span><br><span class="line">  <span class="comment">// we'd have a different number of entries on the stack depending on</span></span><br><span class="line">  <span class="comment">// whether getRootHostContext() throws somewhere in renderer code or not.</span></span><br><span class="line">  <span class="comment">// So we push an empty value first. This lets us safely unwind on errors.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// index = 4</span></span><br><span class="line">  <span class="comment">// valueStack = [&#123;&#125;, false, &#123;&#125;, &#123;&#125;, &#123;&#125;]</span></span><br><span class="line">  <span class="comment">// contextStackCursor = &#123; current: &#123;&#125; &#125;</span></span><br><span class="line">  push(contextStackCursor, NO_CONTEXT, fiber);</span><br><span class="line">  <span class="keyword">const</span> nextRootContext = getRootHostContext(nextRootInstance); <span class="comment">// 计算得到：http://www.w3.org/1999/xhtml</span></span><br><span class="line">  <span class="comment">// Now that we know this function doesn't throw, replace it.</span></span><br><span class="line">  <span class="comment">// index = 3</span></span><br><span class="line">  <span class="comment">// valueStack = [&#123;&#125;, false, &#123;&#125;, &#123;&#125;, null]</span></span><br><span class="line">  <span class="comment">// contextStackCursor = &#123; current: &#123;&#125; &#125;</span></span><br><span class="line">  pop(contextStackCursor, fiber);</span><br><span class="line">  <span class="comment">// index = 4</span></span><br><span class="line">  <span class="comment">// valueStack = [&#123;&#125;, false, &#123;&#125;, &#123;&#125;, &#123;&#125; ]</span></span><br><span class="line">  <span class="comment">// contextStackCursor = &#123; current: "http://www.w3.org/1999/xhtml" &#125;</span></span><br><span class="line">  push(contextStackCursor, nextRootContext, fiber);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="23">
<li>getRootHostContext</li>
</ol>
<p>这是进入react内部第一次遇到直接操纵dom的地方</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRootHostContext</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  rootContainerInstance: Container,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">HostContext</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> type;</span><br><span class="line">  <span class="keyword">let</span> namespace;</span><br><span class="line">  <span class="keyword">const</span> nodeType = rootContainerInstance.nodeType; <span class="comment">// 1 ELEMENT_NODE （首次渲染）</span></span><br><span class="line">  <span class="keyword">switch</span> (nodeType) &#123;</span><br><span class="line">    <span class="keyword">case</span> DOCUMENT_NODE:</span><br><span class="line">    <span class="keyword">case</span> DOCUMENT_FRAGMENT_NODE: &#123;</span><br><span class="line">      type = nodeType === DOCUMENT_NODE ? <span class="string">'#document'</span> : <span class="string">'#fragment'</span>;</span><br><span class="line">      <span class="keyword">const</span> root = (rootContainerInstance: any).documentElement;</span><br><span class="line">      namespace = root ? root.namespaceURI : getChildNamespace(<span class="literal">null</span>, <span class="string">''</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>: &#123; <span class="comment">// 首次渲染走这个分支</span></span><br><span class="line">      <span class="keyword">const</span> container: any =</span><br><span class="line">        nodeType === COMMENT_NODE</span><br><span class="line">          ? rootContainerInstance.parentNode</span><br><span class="line">          : rootContainerInstance;</span><br><span class="line">      <span class="keyword">const</span> ownNamespace = container.namespaceURI || <span class="literal">null</span>; <span class="comment">// http://www.w3.org/1999/xhtml</span></span><br><span class="line">      type = container.tagName; <span class="comment">// 'DIV'</span></span><br><span class="line">      namespace = getChildNamespace(ownNamespace, type); <span class="comment">// http://www.w3.org/1999/xhtml</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> namespace;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="24">
<li>getChildNamespace</li>
</ol>
<p>完全没看懂这个函数。。。为啥要绕一圈。。。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HTML_NAMESPACE = <span class="string">'http://www.w3.org/1999/xhtml'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getChildNamespace</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentNamespace: string | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  type: string,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parentNamespace == <span class="literal">null</span> || parentNamespace === HTML_NAMESPACE) &#123;</span><br><span class="line">    <span class="comment">// No (or default) parent namespace: potential entry point.</span></span><br><span class="line">    <span class="keyword">return</span> getIntrinsicNamespace(type);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (parentNamespace === SVG_NAMESPACE &amp;&amp; type === <span class="string">'foreignObject'</span>) &#123;</span><br><span class="line">    <span class="comment">// We're leaving SVG.</span></span><br><span class="line">    <span class="keyword">return</span> HTML_NAMESPACE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// By default, pass namespace below.</span></span><br><span class="line">  <span class="keyword">return</span> parentNamespace;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="25">
<li>pop</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pop</span>&lt;<span class="title">T</span>&gt;(<span class="params">cursor: StackCursor&lt;T&gt;, fiber: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cursor.current = valueStack[index];</span><br><span class="line"></span><br><span class="line">  valueStack[index] = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  index--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="26">
<li>bailoutOnAlreadyFinishedWork</li>
</ol>
<p>此处调用： <code>return bailoutOnAlreadyFinishedWork(
        current,
        workInProgress,
        renderExpirationTime,
      );</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bailoutOnAlreadyFinishedWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Reuse previous dependencies</span></span><br><span class="line">    workInProgress.dependencies_old = current.dependencies_old;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">    <span class="comment">// Don't update "base" render times for bailouts.</span></span><br><span class="line">    stopProfilerTimerIfRunning(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> updateExpirationTime = workInProgress.expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (updateExpirationTime !== NoWork) &#123;</span><br><span class="line">    markUnprocessedUpdateTime(updateExpirationTime);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if the children have any pending work.</span></span><br><span class="line">  <span class="keyword">const</span> childExpirationTime = workInProgress.childExpirationTime;</span><br><span class="line">  <span class="keyword">if</span> (childExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">    <span class="comment">// The children don't have any work either. We can skip them.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Once we add back resuming, we should check if the children are</span></span><br><span class="line">    <span class="comment">// a work-in-progress set. If so, we need to transfer their effects.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// This fiber doesn't have work, but its subtree does. Clone the child</span></span><br><span class="line">    <span class="comment">// fibers and continue.</span></span><br><span class="line">    cloneChildFibers(current, workInProgress);</span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>==================================================================================</p>
<ol start="27">
<li>updateHostRoot</li>
</ol>
<p>此刻的各个属性值:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">updateQueue: &#123;</span><br><span class="line">  effects: <span class="literal">null</span>,</span><br><span class="line">  firstBaseUpdate: <span class="literal">null</span>,</span><br><span class="line">  lastBaseUpdate: <span class="literal">null</span>,</span><br><span class="line">  shared: &#123;</span><br><span class="line">    pending: <span class="literal">null</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  element: &#123;</span><br><span class="line">    $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element),</span><br><span class="line">    key: <span class="literal">null</span>,</span><br><span class="line">    ref: <span class="literal">null</span>,</span><br><span class="line">    type: <span class="built_in">Symbol</span>(react.strict_mode)</span><br><span class="line">    _owner: <span class="literal">null</span>,</span><br><span class="line">    props: &#123;</span><br><span class="line">      children: &#123;</span><br><span class="line">        $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element),</span><br><span class="line">        key: <span class="literal">null</span>,</span><br><span class="line">        props: &#123;&#125;,</span><br><span class="line">        ref: <span class="literal">null</span>,</span><br><span class="line">        type: App(),</span><br><span class="line">        _owner: <span class="literal">null</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pendingProps: <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">memoizedState: &#123;</span><br><span class="line">  element: &#123;</span><br><span class="line">    $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element),</span><br><span class="line">    key: <span class="literal">null</span>,</span><br><span class="line">    ref: <span class="literal">null</span>,</span><br><span class="line">    type: <span class="built_in">Symbol</span>(react.strict_mode)</span><br><span class="line">    _owner: <span class="literal">null</span>,</span><br><span class="line">    props: &#123;</span><br><span class="line">      children: &#123;</span><br><span class="line">        $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element),</span><br><span class="line">        key: <span class="literal">null</span>,</span><br><span class="line">        props: &#123;&#125;,</span><br><span class="line">        ref: <span class="literal">null</span>,</span><br><span class="line">        type: App(),</span><br><span class="line">        _owner: <span class="literal">null</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHostRoot</span>(<span class="params">current, workInProgress, renderExpirationTime</span>) </span>&#123;</span><br><span class="line">  pushHostRootContext(workInProgress); <span class="comment">// 见上</span></span><br><span class="line">  <span class="keyword">const</span> updateQueue = workInProgress.updateQueue;</span><br><span class="line">  <span class="keyword">const</span> nextProps = workInProgress.pendingProps;</span><br><span class="line">  <span class="keyword">const</span> prevState = workInProgress.memoizedState;</span><br><span class="line">  <span class="keyword">const</span> prevChildren = prevState !== <span class="literal">null</span> ? prevState.element : <span class="literal">null</span>; <span class="comment">// null</span></span><br><span class="line">  cloneUpdateQueue(current, workInProgress);</span><br><span class="line">  processUpdateQueue(workInProgress, nextProps, <span class="literal">null</span>, renderExpirationTime);</span><br><span class="line">  <span class="keyword">const</span> nextState = workInProgress.memoizedState;</span><br><span class="line">  <span class="comment">// Caution: React DevTools currently depends on this property</span></span><br><span class="line">  <span class="comment">// being called "element".</span></span><br><span class="line">  <span class="keyword">const</span> nextChildren = nextState.element;</span><br><span class="line">  <span class="keyword">if</span> (nextChildren === prevChildren) &#123;</span><br><span class="line">    <span class="comment">// If the state is the same as before, that's a bailout because we had</span></span><br><span class="line">    <span class="comment">// no work that expires at this time.</span></span><br><span class="line">    resetHydrationState();</span><br><span class="line">    <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> root: FiberRoot = workInProgress.stateNode;</span><br><span class="line">  <span class="keyword">if</span> (root.hydrate &amp;&amp; enterHydrationState(workInProgress)) &#123;</span><br><span class="line">    <span class="comment">// If we don't have any current children this might be the first pass.</span></span><br><span class="line">    <span class="comment">// We always try to hydrate. If this isn't a hydration pass there won't</span></span><br><span class="line">    <span class="comment">// be any children to hydrate which is effectively the same thing as</span></span><br><span class="line">    <span class="comment">// not hydrating.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (supportsHydration) &#123;</span><br><span class="line">      <span class="keyword">const</span> mutableSourceEagerHydrationData =</span><br><span class="line">        root.mutableSourceEagerHydrationData;</span><br><span class="line">      <span class="keyword">if</span> (mutableSourceEagerHydrationData != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; mutableSourceEagerHydrationData.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> mutableSource = ((mutableSourceEagerHydrationData[</span><br><span class="line">            i</span><br><span class="line">          ]: any): MutableSource&lt;any&gt;);</span><br><span class="line">          <span class="keyword">const</span> version = mutableSourceEagerHydrationData[i + <span class="number">1</span>];</span><br><span class="line">          setWorkInProgressVersion(mutableSource, version);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = mountChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">    workInProgress.child = child;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> node = child;</span><br><span class="line">    <span class="keyword">while</span> (node) &#123;</span><br><span class="line">      <span class="comment">// Mark each child as hydrating. This is a fast path to know whether this</span></span><br><span class="line">      <span class="comment">// tree is part of a hydrating tree. This is used to determine if a child</span></span><br><span class="line">      <span class="comment">// node has fully mounted yet, and for scheduling event replaying.</span></span><br><span class="line">      <span class="comment">// Conceptually this is similar to Placement in that a new subtree is</span></span><br><span class="line">      <span class="comment">// inserted into the React tree here. It just happens to not need DOM</span></span><br><span class="line">      <span class="comment">// mutations because it already exists.</span></span><br><span class="line">      node.effectTag = (node.effectTag &amp; ~Placement) | Hydrating;</span><br><span class="line">      node = node.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Otherwise reset hydration state in case we aborted and resumed another</span></span><br><span class="line">    <span class="comment">// root.</span></span><br><span class="line">    reconcileChildren(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">    resetHydrationState();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="28">
<li>cloneUpdateQueue</li>
</ol>
<p>这个函数是将current的updateQueue浅拷贝给workInProgress的updateQueue</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cloneUpdateQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Clone the update queue from current. Unless it's already a clone.</span></span><br><span class="line">  <span class="keyword">const</span> queue: UpdateQueue&lt;State&gt; = (workInProgress.updateQueue: any);</span><br><span class="line">  <span class="keyword">const</span> currentQueue: UpdateQueue&lt;State&gt; = (current.updateQueue: any);</span><br><span class="line">  <span class="keyword">if</span> (queue === currentQueue) &#123;</span><br><span class="line">    <span class="keyword">const</span> clone: UpdateQueue&lt;State&gt; = &#123;</span><br><span class="line">      baseState: currentQueue.baseState,</span><br><span class="line">      firstBaseUpdate: currentQueue.firstBaseUpdate,</span><br><span class="line">      lastBaseUpdate: currentQueue.lastBaseUpdate,</span><br><span class="line">      shared: currentQueue.shared,</span><br><span class="line">      effects: currentQueue.effects,</span><br><span class="line">    &#125;;</span><br><span class="line">    workInProgress.updateQueue = clone;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="29">
<li>processUpdateQueue</li>
</ol>
<p>此处调用：processUpdateQueue(workInProgress, nextProps, null, renderExpirationTime);</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Global state that is reset at the beginning of calling `processUpdateQueue`.</span></span><br><span class="line"><span class="comment">// It should only be read right after calling `processUpdateQueue`, via</span></span><br><span class="line"><span class="comment">// `checkHasForceUpdateAfterProcessing`.</span></span><br><span class="line"><span class="keyword">let</span> hasForceUpdate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">queue.shared.pending = &#123;</span><br><span class="line">  callback: <span class="literal">null</span>,</span><br><span class="line">  expirationTime: <span class="number">1073741823</span>,</span><br><span class="line">  next: pending, <span class="comment">// next引用另一个pending，此处是它所在的pending</span></span><br><span class="line">  suspenseConfig: <span class="literal">null</span>,</span><br><span class="line">  tag: <span class="number">0</span>,</span><br><span class="line">  payload: &#123;</span><br><span class="line">    element: &#123;</span><br><span class="line">      $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element),</span><br><span class="line">      key: <span class="literal">null</span>,</span><br><span class="line">      ref: <span class="literal">null</span>,</span><br><span class="line">      type: <span class="built_in">Symbol</span>(react.strict_mode),</span><br><span class="line">      _owner: <span class="literal">null</span>,</span><br><span class="line">      props: &#123;</span><br><span class="line">        children: &#123;</span><br><span class="line">          $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element),</span><br><span class="line">          key: <span class="literal">null</span>,</span><br><span class="line">          props: &#123;&#125;,</span><br><span class="line">          ref: <span class="literal">null</span>,</span><br><span class="line">          type: App(),</span><br><span class="line">          _owner: <span class="literal">null</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">queue: &#123;</span><br><span class="line">  baseState: <span class="literal">null</span>,</span><br><span class="line">  effects: <span class="literal">null</span>,</span><br><span class="line">  firstBaseUpdate: <span class="literal">null</span>,</span><br><span class="line">  lastBaseUpdate: <span class="literal">null</span>,</span><br><span class="line">  shared: 见上</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The work left over by components that were visited during this render. Only</span></span><br><span class="line"><span class="comment">// includes unprocessed updates, not work in bailed out children.</span></span><br><span class="line"><span class="keyword">let</span> workInProgressRootNextUnprocessedUpdateTime: ExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markUnprocessedUpdateTime</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (expirationTime &gt; workInProgressRootNextUnprocessedUpdateTime) &#123;</span><br><span class="line">    workInProgressRootNextUnprocessedUpdateTime = expirationTime;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">processUpdateQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  props: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  instance: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This is always non-null on a ClassComponent or HostRoot</span></span><br><span class="line">  <span class="keyword">const</span> queue: UpdateQueue&lt;State&gt; = (workInProgress.updateQueue: any);</span><br><span class="line"></span><br><span class="line">  hasForceUpdate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> firstBaseUpdate = queue.firstBaseUpdate; <span class="comment">// null</span></span><br><span class="line">  <span class="keyword">let</span> lastBaseUpdate = queue.lastBaseUpdate; <span class="comment">// null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there are pending updates. If so, transfer them to the base queue.</span></span><br><span class="line">  <span class="keyword">let</span> pendingQueue = queue.shared.pending;</span><br><span class="line">  <span class="keyword">if</span> (pendingQueue !== <span class="literal">null</span>) &#123; </span><br><span class="line">    queue.shared.pending = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The pending queue is circular. Disconnect the pointer between first</span></span><br><span class="line">    <span class="comment">// and last so that it's non-circular.</span></span><br><span class="line">    <span class="keyword">const</span> lastPendingUpdate = pendingQueue;</span><br><span class="line">    <span class="keyword">const</span> firstPendingUpdate = lastPendingUpdate.next;</span><br><span class="line">    <span class="comment">// lastPendingUpdate === firstPendingUpdate   true</span></span><br><span class="line">    lastPendingUpdate.next = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// Append pending updates to base queue</span></span><br><span class="line">    <span class="keyword">if</span> (lastBaseUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">      firstBaseUpdate = firstPendingUpdate;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      lastBaseUpdate.next = firstPendingUpdate;</span><br><span class="line">    &#125;</span><br><span class="line">    lastBaseUpdate = lastPendingUpdate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there's a current queue, and it's different from the base queue, then</span></span><br><span class="line">    <span class="comment">// we need to transfer the updates to that queue, too. Because the base</span></span><br><span class="line">    <span class="comment">// queue is a singly-linked list with no cycles, we can append to both</span></span><br><span class="line">    <span class="comment">// lists and take advantage of structural sharing.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Pass `current` as argument</span></span><br><span class="line">    <span class="keyword">const</span> current = workInProgress.alternate;</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This is always non-null on a ClassComponent or HostRoot</span></span><br><span class="line">      <span class="keyword">const</span> currentQueue: UpdateQueue&lt;State&gt; = (current.updateQueue: any);</span><br><span class="line">      <span class="comment">// currentQueue = &#123;</span></span><br><span class="line">      <span class="comment">//   baseState: null,</span></span><br><span class="line">      <span class="comment">//   effects: null,</span></span><br><span class="line">      <span class="comment">//   firstBaseUpdate: null,</span></span><br><span class="line">      <span class="comment">//   lastBaseUpdate: null,</span></span><br><span class="line">      <span class="comment">//   shared: &#123;</span></span><br><span class="line">      <span class="comment">//     pending: null,</span></span><br><span class="line">      <span class="comment">//   &#125;,</span></span><br><span class="line">      <span class="comment">// &#125;</span></span><br><span class="line">      <span class="keyword">const</span> currentLastBaseUpdate = currentQueue.lastBaseUpdate;</span><br><span class="line">      <span class="keyword">if</span> (currentLastBaseUpdate !== lastBaseUpdate) &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentLastBaseUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">          currentQueue.firstBaseUpdate = firstPendingUpdate;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          currentLastBaseUpdate.next = firstPendingUpdate;</span><br><span class="line">        &#125;</span><br><span class="line">        currentQueue.lastBaseUpdate = lastPendingUpdate;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// These values may change as we process the queue.</span></span><br><span class="line">  <span class="keyword">if</span> (firstBaseUpdate !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Iterate through the list of updates to compute the result.</span></span><br><span class="line">    <span class="keyword">let</span> newState = queue.baseState;</span><br><span class="line">    <span class="keyword">let</span> newExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newBaseState = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> newFirstBaseUpdate = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> newLastBaseUpdate = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> update = firstBaseUpdate;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> updateExpirationTime = update.expirationTime;</span><br><span class="line">      <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">        <span class="comment">// Priority is insufficient. Skip this update. If this is the first</span></span><br><span class="line">        <span class="comment">// skipped update, the previous update/state is the new base</span></span><br><span class="line">        <span class="comment">// update/state.</span></span><br><span class="line">        <span class="keyword">const</span> clone: Update&lt;State&gt; = &#123;</span><br><span class="line">          expirationTime: update.expirationTime,</span><br><span class="line">          suspenseConfig: update.suspenseConfig,</span><br><span class="line"></span><br><span class="line">          tag: update.tag,</span><br><span class="line">          payload: update.payload,</span><br><span class="line">          callback: update.callback,</span><br><span class="line"></span><br><span class="line">          next: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (newLastBaseUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">          newFirstBaseUpdate = newLastBaseUpdate = clone;</span><br><span class="line">          newBaseState = newState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          newLastBaseUpdate = newLastBaseUpdate.next = clone;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Update the remaining priority in the queue.</span></span><br><span class="line">        <span class="keyword">if</span> (updateExpirationTime &gt; newExpirationTime) &#123;</span><br><span class="line">          newExpirationTime = updateExpirationTime;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This update does have sufficient priority.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newLastBaseUpdate !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> clone: Update&lt;State&gt; = &#123;</span><br><span class="line">            expirationTime: Sync, <span class="comment">// This update is going to be committed so we never want uncommit it.</span></span><br><span class="line">            suspenseConfig: update.suspenseConfig,</span><br><span class="line"></span><br><span class="line">            tag: update.tag,</span><br><span class="line">            payload: update.payload,</span><br><span class="line">            callback: update.callback,</span><br><span class="line"></span><br><span class="line">            next: <span class="literal">null</span>,</span><br><span class="line">          &#125;;</span><br><span class="line">          newLastBaseUpdate = newLastBaseUpdate.next = clone;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mark the event time of this update as relevant to this render pass.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This should ideally use the true event time of this update rather than</span></span><br><span class="line">        <span class="comment">// its priority which is a derived and not reverseable value.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> We should skip this update if it was already committed but currently</span></span><br><span class="line">        <span class="comment">// we have no way of detecting the difference between a committed and suspended</span></span><br><span class="line">        <span class="comment">// update here.</span></span><br><span class="line">        <span class="comment">// 首次渲染第一次什么都没干</span></span><br><span class="line">        markRenderEventTimeAndConfig(</span><br><span class="line">          updateExpirationTime,</span><br><span class="line">          update.suspenseConfig,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process this update.</span></span><br><span class="line">        newState = getStateFromUpdate(</span><br><span class="line">          workInProgress,</span><br><span class="line">          queue,</span><br><span class="line">          update,</span><br><span class="line">          newState,</span><br><span class="line">          props,</span><br><span class="line">          instance,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">const</span> callback = update.callback;</span><br><span class="line">        <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">          workInProgress.effectTag |= Callback;</span><br><span class="line">          <span class="keyword">const</span> effects = queue.effects;</span><br><span class="line">          <span class="keyword">if</span> (effects === <span class="literal">null</span>) &#123;</span><br><span class="line">            queue.effects = [update];</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            effects.push(update);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      update = update.next;</span><br><span class="line">      <span class="keyword">if</span> (update === <span class="literal">null</span>) &#123;</span><br><span class="line">        pendingQueue = queue.shared.pending;</span><br><span class="line">        <span class="keyword">if</span> (pendingQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// An update was scheduled from inside a reducer. Add the new</span></span><br><span class="line">          <span class="comment">// pending updates to the end of the list and keep processing.</span></span><br><span class="line">          <span class="keyword">const</span> lastPendingUpdate = pendingQueue;</span><br><span class="line">          <span class="comment">// Intentionally unsound. Pending updates form a circular list, but we</span></span><br><span class="line">          <span class="comment">// unravel them when transferring them to the base queue.</span></span><br><span class="line">          <span class="keyword">const</span> firstPendingUpdate = ((lastPendingUpdate.next: any): Update&lt;State&gt;);</span><br><span class="line">          lastPendingUpdate.next = <span class="literal">null</span>;</span><br><span class="line">          update = firstPendingUpdate;</span><br><span class="line">          queue.lastBaseUpdate = lastPendingUpdate;</span><br><span class="line">          queue.shared.pending = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newLastBaseUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">      newBaseState = newState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    queue.baseState = ((newBaseState: any): State);</span><br><span class="line">    queue.firstBaseUpdate = newFirstBaseUpdate;</span><br><span class="line">    queue.lastBaseUpdate = newLastBaseUpdate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the remaining expiration time to be whatever is remaining in the queue.</span></span><br><span class="line">    <span class="comment">// This should be fine because the only two other things that contribute to</span></span><br><span class="line">    <span class="comment">// expiration time are props and context. We're already in the middle of the</span></span><br><span class="line">    <span class="comment">// begin phase by the time we start processing the queue, so we've already</span></span><br><span class="line">    <span class="comment">// dealt with the props. Context in components that specify</span></span><br><span class="line">    <span class="comment">// shouldComponentUpdate is tricky; but we'll have to account for</span></span><br><span class="line">    <span class="comment">// that regardless.</span></span><br><span class="line">    markUnprocessedUpdateTime(newExpirationTime);</span><br><span class="line">    workInProgress.expirationTime = newExpirationTime;</span><br><span class="line">    workInProgress.memoizedState = newState;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="30">
<li>markRenderEventTimeAndConfig</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Most recent event time among processed updates during this render.</span></span><br><span class="line"><span class="comment">// This is conceptually a time stamp but expressed in terms of an ExpirationTime</span></span><br><span class="line"><span class="comment">// because we deal mostly with expiration times in the hot path, so this avoids</span></span><br><span class="line"><span class="comment">// the conversion happening in the hot path.</span></span><br><span class="line"><span class="keyword">let</span> workInProgressRootLatestProcessedExpirationTime: ExpirationTime = Sync;</span><br><span class="line"><span class="comment">// Idle is slightly higher priority than Never. It must completely finish in</span></span><br><span class="line"><span class="comment">// order to be consistent.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Idle = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">markRenderEventTimeAndConfig</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime, <span class="regexp">//</span> <span class="number">1073741823</span></span></span></span><br><span class="line"><span class="function"><span class="params">  suspenseConfig: null | SuspenseConfig, <span class="regexp">//</span> null</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    expirationTime &lt; workInProgressRootLatestProcessedExpirationTime &amp;&amp;</span><br><span class="line">    expirationTime &gt; Idle</span><br><span class="line">  ) &#123;</span><br><span class="line">    workInProgressRootLatestProcessedExpirationTime = expirationTime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (suspenseConfig !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      expirationTime &lt; workInProgressRootLatestSuspenseTimeout &amp;&amp;</span><br><span class="line">      expirationTime &gt; Idle</span><br><span class="line">    ) &#123;</span><br><span class="line">      workInProgressRootLatestSuspenseTimeout = expirationTime;</span><br><span class="line">      <span class="comment">// Most of the time we only have one config and getting wrong is not bad.</span></span><br><span class="line">      workInProgressRootCanSuspendUsingConfig = suspenseConfig;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="31">
<li>getStateFromUpdate</li>
</ol>
<p>此处调用：getStateFromUpdate(workInProgress, workInProgress.updateQueue, firstPendingUpdate, null, null, null)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> UpdateState = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ReplaceState = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ForceUpdate = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> CaptureUpdate = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getStateFromUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  queue: UpdateQueue&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: Update&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  prevState: State,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextProps: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  instance: any,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (update.tag) &#123; <span class="comment">// 0</span></span><br><span class="line">    <span class="keyword">case</span> ReplaceState: &#123;</span><br><span class="line">      <span class="keyword">const</span> payload = update.payload;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> payload === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="comment">// Updater function</span></span><br><span class="line">        <span class="keyword">const</span> nextState = payload.call(instance, prevState, nextProps);</span><br><span class="line">        <span class="keyword">return</span> nextState;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// State object</span></span><br><span class="line">      <span class="keyword">return</span> payload;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> CaptureUpdate: &#123;</span><br><span class="line">      workInProgress.effectTag =</span><br><span class="line">        (workInProgress.effectTag &amp; ~ShouldCapture) | DidCapture;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Intentional fallthrough</span></span><br><span class="line">    <span class="keyword">case</span> UpdateState: &#123;</span><br><span class="line">      <span class="comment">// 首次渲染第一次</span></span><br><span class="line">      <span class="comment">// payload = &#123;</span></span><br><span class="line">      <span class="comment">//   $$typeof: Symbol(react.element)</span></span><br><span class="line">      <span class="comment">//   key: null,</span></span><br><span class="line">      <span class="comment">//   props: &#123;</span></span><br><span class="line">      <span class="comment">//     children: &#123;</span></span><br><span class="line">      <span class="comment">//       $$typeof: Symbol(react.element),</span></span><br><span class="line">      <span class="comment">//       key: null,</span></span><br><span class="line">      <span class="comment">//       props: &#123;&#125;,</span></span><br><span class="line">      <span class="comment">//       ref: null,</span></span><br><span class="line">      <span class="comment">//       type: f App(),</span></span><br><span class="line">      <span class="comment">//       _owner: null</span></span><br><span class="line">      <span class="comment">//     &#125;</span></span><br><span class="line">      <span class="comment">//   &#125;</span></span><br><span class="line">      <span class="comment">//   ref: null,</span></span><br><span class="line">      <span class="comment">//   type: Symbol(react.strict_mode)</span></span><br><span class="line">      <span class="comment">//   _owner: null</span></span><br><span class="line">      <span class="comment">// &#125;</span></span><br><span class="line">      <span class="keyword">const</span> payload = update.payload;</span><br><span class="line">      <span class="keyword">let</span> partialState;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> payload === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="comment">// Updater function</span></span><br><span class="line">        partialState = payload.call(instance, prevState, nextProps);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Partial state object</span></span><br><span class="line">        partialState = payload;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (partialState === <span class="literal">null</span> || partialState === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="comment">// Null and undefined are treated as no-ops.</span></span><br><span class="line">        <span class="keyword">return</span> prevState;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Merge the partial state and the previous state.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, prevState, partialState); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ForceUpdate: &#123;</span><br><span class="line">      hasForceUpdate = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">return</span> prevState;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> prevState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="32">
<li>reconcileChildren</li>
</ol>
<p>此处调用： <code>reconcileChildren(
      current,
      workInProgress,
      nextChildren,
      renderExpirationTime,
    );</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextChildren: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If this is a fresh new component that hasn't been rendered yet, we</span></span><br><span class="line">    <span class="comment">// won't update its child set by applying minimal side-effects. Instead,</span></span><br><span class="line">    <span class="comment">// we will add them all to the child before it gets rendered. That means</span></span><br><span class="line">    <span class="comment">// we can optimize this reconciliation pass by not tracking side-effects.</span></span><br><span class="line">    workInProgress.child = mountChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// If the current child is the same as the work in progress, it means that</span></span><br><span class="line">    <span class="comment">// we haven't yet started any work on these children. Therefore, we use</span></span><br><span class="line">    <span class="comment">// the clone algorithm to create a copy of all the current children.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we had any progressed work already, that is invalid at this point so</span></span><br><span class="line">    <span class="comment">// let's throw it out.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================进入下面这个函数时的各个参数值==================</span></span><br><span class="line">    <span class="comment">// child: null</span></span><br><span class="line">    <span class="comment">// nextChildren: &#123;</span></span><br><span class="line">    <span class="comment">//   $$typeof: Symbol(react.element)</span></span><br><span class="line">    <span class="comment">//   key: null</span></span><br><span class="line">    <span class="comment">//   props: &#123;</span></span><br><span class="line">    <span class="comment">//     children: &#123;</span></span><br><span class="line">    <span class="comment">//       $$typeof: Symbol(react.element)</span></span><br><span class="line">    <span class="comment">//       key: null</span></span><br><span class="line">    <span class="comment">//       props: &#123;&#125;</span></span><br><span class="line">    <span class="comment">//       ref: null</span></span><br><span class="line">    <span class="comment">//       type: ƒ App()</span></span><br><span class="line">    <span class="comment">//       _owner: null</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//   &#125;</span></span><br><span class="line">    <span class="comment">//   ref: null</span></span><br><span class="line">    <span class="comment">//   type: Symbol(react.strict_mode)</span></span><br><span class="line">    <span class="comment">//   _owner: null</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// renderExpirationTime: 1073741823</span></span><br><span class="line">    <span class="comment">// ===========================================================================</span></span><br><span class="line">    workInProgress.child = reconcileChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      current.child,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="33">
<li>reconcileChildFibers</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nextChildren: &#123;</span></span><br><span class="line"><span class="comment">//   $$typeof: Symbol(react.element),</span></span><br><span class="line"><span class="comment">//   key: null,</span></span><br><span class="line"><span class="comment">//   ref: null,</span></span><br><span class="line"><span class="comment">//   type: Symbol(react.strict_mode)</span></span><br><span class="line"><span class="comment">//   _owner: null,</span></span><br><span class="line"><span class="comment">//   props: &#123;</span></span><br><span class="line"><span class="comment">//     children: &#123;</span></span><br><span class="line"><span class="comment">//       $$typeof: Symbol(react.element),</span></span><br><span class="line"><span class="comment">//       key: null,</span></span><br><span class="line"><span class="comment">//       props: &#123;&#125;,</span></span><br><span class="line"><span class="comment">//       ref: null,</span></span><br><span class="line"><span class="comment">//       type: App(),</span></span><br><span class="line"><span class="comment">//       _owner: null,</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//   &#125;,</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REACT_ELEMENT_TYPE = symbolFor('react.element');</span></span><br><span class="line"><span class="comment">// shouldTrackSideEffects = true;</span></span><br><span class="line"><span class="comment">// export const Placement =  0b00000000000010;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">placeSingleChild</span>(<span class="params">newFiber: Fiber</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This is simpler for the single child case. We only need to do a</span></span><br><span class="line">  <span class="comment">// placement for inserting new children.</span></span><br><span class="line">  <span class="keyword">if</span> (shouldTrackSideEffects &amp;&amp; newFiber.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">    newFiber.effectTag = Placement;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> newFiber;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = element.key;</span><br><span class="line">  <span class="keyword">let</span> child = currentFirstChild;</span><br><span class="line">  <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> If key === null and child.key === null, then this only applies to</span></span><br><span class="line">    <span class="comment">// the first item in the list.</span></span><br><span class="line">    <span class="keyword">if</span> (child.key === key) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (child.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> Fragment: &#123;</span><br><span class="line">          <span class="keyword">if</span> (element.type === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">            deleteRemainingChildren(returnFiber, child.sibling);</span><br><span class="line">            <span class="keyword">const</span> existing = useFiber(child, element.props.children);</span><br><span class="line">            existing.return = returnFiber;</span><br><span class="line">            <span class="keyword">return</span> existing;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> Block:</span><br><span class="line">          <span class="keyword">if</span> (enableBlocksAPI) &#123;</span><br><span class="line">            <span class="keyword">let</span> type = element.type;</span><br><span class="line">            <span class="keyword">if</span> (type.$$<span class="keyword">typeof</span> === REACT_LAZY_TYPE) &#123;</span><br><span class="line">              type = resolveLazyType(type);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (type.$$<span class="keyword">typeof</span> === REACT_BLOCK_TYPE) &#123;</span><br><span class="line">              <span class="comment">// The new Block might not be initialized yet. We need to initialize</span></span><br><span class="line">              <span class="comment">// it in case initializing it turns out it would match.</span></span><br><span class="line">              <span class="keyword">if</span> (</span><br><span class="line">                ((type: any): BlockComponent&lt;any, any&gt;)._render ===</span><br><span class="line">                (child.type: BlockComponent&lt;any, any&gt;)._render</span><br><span class="line">              ) &#123;</span><br><span class="line">                deleteRemainingChildren(returnFiber, child.sibling);</span><br><span class="line">                <span class="keyword">const</span> existing = useFiber(child, element.props);</span><br><span class="line">                existing.type = type;</span><br><span class="line">                existing.return = returnFiber;</span><br><span class="line">                <span class="keyword">return</span> existing;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="comment">// We intentionally fallthrough here if enableBlocksAPI is not on.</span></span><br><span class="line">        <span class="comment">// eslint-disable-next-lined no-fallthrough</span></span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            child.elementType === element.type ||</span><br><span class="line">            <span class="comment">// Keep this check inline so it only runs on the false path:</span></span><br><span class="line">            (__DEV__</span><br><span class="line">              ? isCompatibleFamilyForHotReloading(child, element)</span><br><span class="line">              : <span class="literal">false</span>)</span><br><span class="line">          ) &#123;</span><br><span class="line">            deleteRemainingChildren(returnFiber, child.sibling);</span><br><span class="line">            <span class="keyword">const</span> existing = useFiber(child, element.props);</span><br><span class="line">            existing.ref = coerceRef(returnFiber, child, element);</span><br><span class="line">            existing.return = returnFiber;</span><br><span class="line">            <span class="keyword">return</span> existing;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Didn't match.</span></span><br><span class="line">      deleteRemainingChildren(returnFiber, child);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      deleteChild(returnFiber, child);</span><br><span class="line">    &#125;</span><br><span class="line">    child = child.sibling;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (element.type === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">    <span class="keyword">const</span> created = createFiberFromFragment(</span><br><span class="line">      element.props.children,</span><br><span class="line">      returnFiber.mode,</span><br><span class="line">      expirationTime,</span><br><span class="line">      element.key,</span><br><span class="line">    );</span><br><span class="line">    created.return = returnFiber;</span><br><span class="line">    <span class="keyword">return</span> created;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 进入这个分支</span></span><br><span class="line">    <span class="keyword">const</span> created = createFiberFromElement(</span><br><span class="line">      element,</span><br><span class="line">      returnFiber.mode,</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">    created.ref = coerceRef(returnFiber, currentFirstChild, element);</span><br><span class="line">    created.return = returnFiber;</span><br><span class="line">    <span class="keyword">return</span> created;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This API will tag the children with the side-effect of the reconciliation</span></span><br><span class="line"><span class="comment">// itself. They will be added to the side-effect list as we pass through the</span></span><br><span class="line"><span class="comment">// children and the parent.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This function is not recursive.</span></span><br><span class="line">  <span class="comment">// If the top level item is an array, we treat it as a set of children,</span></span><br><span class="line">  <span class="comment">// not as a fragment. Nested arrays on the other hand will be treated as</span></span><br><span class="line">  <span class="comment">// fragment nodes. Recursion happens at the normal flow.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Handle top level unkeyed fragments as if they were arrays.</span></span><br><span class="line">  <span class="comment">// This leads to an ambiguity between &lt;&gt;&#123;[...]&#125;&lt;/&gt; and &lt;&gt;...&lt;/&gt;.</span></span><br><span class="line">  <span class="comment">// We treat the ambiguous cases above the same.</span></span><br><span class="line">  <span class="keyword">const</span> isUnkeyedTopLevelFragment =</span><br><span class="line">    <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">    newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">    newChild.key === <span class="literal">null</span>; <span class="comment">// false</span></span><br><span class="line">  <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">    newChild = newChild.props.children;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Handle object types</span></span><br><span class="line">  <span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp; newChild !== <span class="literal">null</span>; <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (newChild.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">        <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">          reconcileSingleElement(</span><br><span class="line">            returnFiber,</span><br><span class="line">            currentFirstChild,</span><br><span class="line">            newChild,</span><br><span class="line">            expirationTime,</span><br><span class="line">          ),</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">case</span> REACT_PORTAL_TYPE:</span><br><span class="line">        <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">          reconcileSinglePortal(</span><br><span class="line">            returnFiber,</span><br><span class="line">            currentFirstChild,</span><br><span class="line">            newChild,</span><br><span class="line">            expirationTime,</span><br><span class="line">          ),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'string'</span> || <span class="keyword">typeof</span> newChild === <span class="string">'number'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">      reconcileSingleTextNode(</span><br><span class="line">        returnFiber,</span><br><span class="line">        currentFirstChild,</span><br><span class="line">        <span class="string">''</span> + newChild,</span><br><span class="line">        expirationTime,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isArray(newChild)) &#123;</span><br><span class="line">    <span class="keyword">return</span> reconcileChildrenArray(</span><br><span class="line">      returnFiber,</span><br><span class="line">      currentFirstChild,</span><br><span class="line">      newChild,</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getIteratorFn(newChild)) &#123;</span><br><span class="line">    <span class="keyword">return</span> reconcileChildrenIterator(</span><br><span class="line">      returnFiber,</span><br><span class="line">      currentFirstChild,</span><br><span class="line">      newChild,</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">    throwOnInvalidObjectType(returnFiber, newChild);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'undefined'</span> &amp;&amp; !isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">    <span class="comment">// If the new child is undefined, and the return fiber is a composite</span></span><br><span class="line">    <span class="comment">// component, throw an error. If Fiber return types are disabled,</span></span><br><span class="line">    <span class="comment">// we already threw above.</span></span><br><span class="line">    <span class="keyword">switch</span> (returnFiber.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Intentionally fall through to the next case, which handles both</span></span><br><span class="line">      <span class="comment">// functions and classes</span></span><br><span class="line">      <span class="comment">// eslint-disable-next-lined no-fallthrough</span></span><br><span class="line">      <span class="keyword">case</span> FunctionComponent: &#123;</span><br><span class="line">        <span class="keyword">const</span> Component = returnFiber.type;</span><br><span class="line">        invariant(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">'%s(...): Nothing was returned from render. This usually means a '</span> +</span><br><span class="line">            <span class="string">'return statement is missing. Or, to render nothing, '</span> +</span><br><span class="line">            <span class="string">'return null.'</span>,</span><br><span class="line">          Component.displayName || Component.name || <span class="string">'Component'</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remaining cases are all treated as empty.</span></span><br><span class="line">  <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="34">
<li>createFiberFromElement</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFiberFromElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> owner = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">const</span> type = element.type;</span><br><span class="line">  <span class="keyword">const</span> key = element.key;</span><br><span class="line">  <span class="keyword">const</span> pendingProps = element.props;</span><br><span class="line">  <span class="keyword">const</span> fiber = createFiberFromTypeAndProps(</span><br><span class="line">    type,</span><br><span class="line">    key,</span><br><span class="line">    pendingProps,</span><br><span class="line">    owner,</span><br><span class="line">    mode,</span><br><span class="line">    expirationTime,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> fiber;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="35">
<li>createFiberFromTypeAndProps</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// type: Symbol(react.strict_mode)</span></span><br><span class="line"><span class="comment">// key: null,</span></span><br><span class="line"><span class="comment">// pendingProps: &#123;</span></span><br><span class="line"><span class="comment">//   children: &#123;</span></span><br><span class="line"><span class="comment">//     $$typeof: Symbol(react.element)</span></span><br><span class="line"><span class="comment">//     key: null</span></span><br><span class="line"><span class="comment">//     props: &#123;&#125;</span></span><br><span class="line"><span class="comment">//     ref: null</span></span><br><span class="line"><span class="comment">//     type: ƒ App()</span></span><br><span class="line"><span class="comment">//     _owner: null</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// owner: null</span></span><br><span class="line"><span class="comment">// mode: 0</span></span><br><span class="line"><span class="comment">// expirationTime: 1073741823</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoMode = <span class="number">0b00000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> StrictMode = <span class="number">0b00001</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IndeterminateComponent = <span class="number">2</span>; <span class="comment">// Before we know whether it is function or class</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFiberFromTypeAndProps</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  type: any, <span class="regexp">//</span> React$ElementType</span></span></span><br><span class="line"><span class="function"><span class="params">  key: null | string,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  owner: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> fiberTag = IndeterminateComponent; <span class="comment">// 2</span></span><br><span class="line">  <span class="comment">// The resolved type is set if we know what the final type will be. I.e. it's not lazy.</span></span><br><span class="line">  <span class="keyword">let</span> resolvedType = type; <span class="comment">// Symbol(react.strict_mode)</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (shouldConstruct(type)) &#123;</span><br><span class="line">      fiberTag = ClassComponent;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'string'</span>) &#123;</span><br><span class="line">    fiberTag = HostComponent;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    getTag: <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> REACT_FRAGMENT_TYPE:</span><br><span class="line">        <span class="keyword">return</span> createFiberFromFragment(</span><br><span class="line">          pendingProps.children,</span><br><span class="line">          mode,</span><br><span class="line">          expirationTime,</span><br><span class="line">          key,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">case</span> REACT_DEBUG_TRACING_MODE_TYPE:</span><br><span class="line">        fiberTag = Mode;</span><br><span class="line">        mode |= DebugTracingMode;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> REACT_STRICT_MODE_TYPE: <span class="comment">// 进入这个分支</span></span><br><span class="line">        fiberTag = Mode; <span class="comment">// 8</span></span><br><span class="line">        mode |= StrictMode; <span class="comment">// 0b00001</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> REACT_PROFILER_TYPE:</span><br><span class="line">        <span class="keyword">return</span> createFiberFromProfiler(pendingProps, mode, expirationTime, key);</span><br><span class="line">      <span class="keyword">case</span> REACT_SUSPENSE_TYPE:</span><br><span class="line">        <span class="keyword">return</span> createFiberFromSuspense(pendingProps, mode, expirationTime, key);</span><br><span class="line">      <span class="keyword">case</span> REACT_SUSPENSE_LIST_TYPE:</span><br><span class="line">        <span class="keyword">return</span> createFiberFromSuspenseList(</span><br><span class="line">          pendingProps,</span><br><span class="line">          mode,</span><br><span class="line">          expirationTime,</span><br><span class="line">          key,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">default</span>: &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'object'</span> &amp;&amp; type !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">switch</span> (type.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> REACT_PROVIDER_TYPE:</span><br><span class="line">              fiberTag = ContextProvider;</span><br><span class="line">              <span class="keyword">break</span> getTag;</span><br><span class="line">            <span class="keyword">case</span> REACT_CONTEXT_TYPE:</span><br><span class="line">              <span class="comment">// This is a consumer</span></span><br><span class="line">              fiberTag = ContextConsumer;</span><br><span class="line">              <span class="keyword">break</span> getTag;</span><br><span class="line">            <span class="keyword">case</span> REACT_FORWARD_REF_TYPE:</span><br><span class="line">              fiberTag = ForwardRef;</span><br><span class="line">              <span class="keyword">break</span> getTag;</span><br><span class="line">            <span class="keyword">case</span> REACT_MEMO_TYPE:</span><br><span class="line">              fiberTag = MemoComponent;</span><br><span class="line">              <span class="keyword">break</span> getTag;</span><br><span class="line">            <span class="keyword">case</span> REACT_LAZY_TYPE:</span><br><span class="line">              fiberTag = LazyComponent;</span><br><span class="line">              resolvedType = <span class="literal">null</span>;</span><br><span class="line">              <span class="keyword">break</span> getTag;</span><br><span class="line">            <span class="keyword">case</span> REACT_BLOCK_TYPE:</span><br><span class="line">              fiberTag = Block;</span><br><span class="line">              <span class="keyword">break</span> getTag;</span><br><span class="line">            <span class="keyword">case</span> REACT_FUNDAMENTAL_TYPE:</span><br><span class="line">              <span class="keyword">if</span> (enableFundamentalAPI) &#123;</span><br><span class="line">                <span class="keyword">return</span> createFiberFromFundamental(</span><br><span class="line">                  type,</span><br><span class="line">                  pendingProps,</span><br><span class="line">                  mode,</span><br><span class="line">                  expirationTime,</span><br><span class="line">                  key,</span><br><span class="line">                );</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> REACT_SCOPE_TYPE:</span><br><span class="line">              <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">                <span class="keyword">return</span> createFiberFromScope(</span><br><span class="line">                  type,</span><br><span class="line">                  pendingProps,</span><br><span class="line">                  mode,</span><br><span class="line">                  expirationTime,</span><br><span class="line">                  key,</span><br><span class="line">                );</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> info = <span class="string">''</span>;</span><br><span class="line">        invariant(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">'Element type is invalid: expected a string (for built-in '</span> +</span><br><span class="line">            <span class="string">'components) or a class/function (for composite components) '</span> +</span><br><span class="line">            <span class="string">'but got: %s.%s'</span>,</span><br><span class="line">          type == <span class="literal">null</span> ? type : <span class="keyword">typeof</span> type,</span><br><span class="line">          info,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fiber = createFiber(fiberTag, pendingProps, key, mode); <span class="comment">// createFiber(8, &#123;</span></span><br><span class="line">    <span class="comment">// children: &#123;</span></span><br><span class="line">    <span class="comment">//   $$typeof: Symbol(react.element)</span></span><br><span class="line">    <span class="comment">//   key: null</span></span><br><span class="line">    <span class="comment">//   props: &#123;&#125;</span></span><br><span class="line">    <span class="comment">//   ref: null</span></span><br><span class="line">    <span class="comment">//   type: ƒ App()</span></span><br><span class="line">    <span class="comment">//   _owner: null</span></span><br><span class="line">    <span class="comment">//   &#125;</span></span><br><span class="line">    <span class="comment">// &#125;, null, 0b00001)</span></span><br><span class="line">  fiber.elementType = type;</span><br><span class="line">  fiber.type = resolvedType;</span><br><span class="line">  fiber.expirationTime = expirationTime;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fiber;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="36">
<li>coerceRef</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">coerceRef</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber, <span class="regexp">//</span> </span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null, <span class="regexp">//</span> null</span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> mixedRef = element.ref; <span class="comment">// null</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    mixedRef !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> mixedRef !== <span class="string">'function'</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> mixedRef !== <span class="string">'object'</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (element._owner) &#123;</span><br><span class="line">      <span class="keyword">const</span> owner: ?Fiber = (element._owner: any);</span><br><span class="line">      <span class="keyword">let</span> inst;</span><br><span class="line">      <span class="keyword">if</span> (owner) &#123;</span><br><span class="line">        <span class="keyword">const</span> ownerFiber = ((owner: any): Fiber);</span><br><span class="line">        invariant(</span><br><span class="line">          ownerFiber.tag === ClassComponent,</span><br><span class="line">          <span class="string">'Function components cannot have string refs. '</span> +</span><br><span class="line">            <span class="string">'We recommend using useRef() instead. '</span> +</span><br><span class="line">            <span class="string">'Learn more about using refs safely here: '</span> +</span><br><span class="line">            <span class="string">'https://fb.me/react-strict-mode-string-ref'</span>,</span><br><span class="line">        );</span><br><span class="line">        inst = ownerFiber.stateNode;</span><br><span class="line">      &#125;</span><br><span class="line">      invariant(</span><br><span class="line">        inst,</span><br><span class="line">        <span class="string">'Missing owner for string ref %s. This error is likely caused by a '</span> +</span><br><span class="line">          <span class="string">'bug in React. Please file an issue.'</span>,</span><br><span class="line">        mixedRef,</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">const</span> stringRef = <span class="string">''</span> + mixedRef;</span><br><span class="line">      <span class="comment">// Check if previous string ref matches new string ref</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        current !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        current.ref !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> current.ref === <span class="string">'function'</span> &amp;&amp;</span><br><span class="line">        current.ref._stringRef === stringRef</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">return</span> current.ref;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> ref = <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> refs = inst.refs;</span><br><span class="line">        <span class="keyword">if</span> (refs === emptyRefsObject) &#123;</span><br><span class="line">          <span class="comment">// This is a lazy pooled frozen object, so we need to initialize.</span></span><br><span class="line">          refs = inst.refs = &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (value === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">delete</span> refs[stringRef];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          refs[stringRef] = value;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      ref._stringRef = stringRef;</span><br><span class="line">      <span class="keyword">return</span> ref;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      invariant(</span><br><span class="line">        <span class="keyword">typeof</span> mixedRef === <span class="string">'string'</span>,</span><br><span class="line">        <span class="string">'Expected ref to be a function, a string, an object returned by React.createRef(), or null.'</span>,</span><br><span class="line">      );</span><br><span class="line">      invariant(</span><br><span class="line">        element._owner,</span><br><span class="line">        <span class="string">'Element ref was specified as a string (%s) but no owner was set. This could happen for one of'</span> +</span><br><span class="line">          <span class="string">' the following reasons:\n'</span> +</span><br><span class="line">          <span class="string">'1. You may be adding a ref to a function component\n'</span> +</span><br><span class="line">          <span class="string">"2. You may be adding a ref to a component that was not created inside a component's render method\n"</span> +</span><br><span class="line">          <span class="string">'3. You have multiple copies of React loaded\n'</span> +</span><br><span class="line">          <span class="string">'See https://fb.me/react-refs-must-have-owner for more information.'</span>,</span><br><span class="line">        mixedRef,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> mixedRef;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="37">
<li>updateMode</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateMode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> nextChildren = workInProgress.pendingProps.children;</span><br><span class="line">  reconcileChildren(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    nextChildren,</span><br><span class="line">    renderExpirationTime,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="38">
<li>mountIndeterminateComponent</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> disableLegacyContext = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUnmaskedContext</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  didPushOwnContextIfProvider: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (disableLegacyContext) &#123;</span><br><span class="line">    <span class="keyword">return</span> emptyContextObject;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (didPushOwnContextIfProvider &amp;&amp; isContextProvider(Component)) &#123;</span><br><span class="line">      <span class="comment">// If the fiber is a context provider itself, when we read its context</span></span><br><span class="line">      <span class="comment">// we may have already pushed its own child context on the stack. A context</span></span><br><span class="line">      <span class="comment">// provider should not "see" its own child context. Therefore we read the</span></span><br><span class="line">      <span class="comment">// previous (parent) context instead for a context provider.</span></span><br><span class="line">      <span class="keyword">return</span> previousContext;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> contextStackCursor.current;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMaskedContext</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  unmaskedContext: Object,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (disableLegacyContext) &#123;</span><br><span class="line">    <span class="keyword">return</span> emptyContextObject;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">    <span class="keyword">const</span> contextTypes = type.contextTypes;</span><br><span class="line">    <span class="keyword">if</span> (!contextTypes) &#123;</span><br><span class="line">      <span class="keyword">return</span> emptyContextObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Avoid recreating masked context unless unmasked context has changed.</span></span><br><span class="line">    <span class="comment">// Failing to do this will result in unnecessary calls to componentWillReceiveProps.</span></span><br><span class="line">    <span class="comment">// This may trigger infinite loops if componentWillReceiveProps calls setState.</span></span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.stateNode;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      instance &amp;&amp;</span><br><span class="line">      instance.__reactInternalMemoizedUnmaskedChildContext === unmaskedContext</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span> instance.__reactInternalMemoizedMaskedChildContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> context = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> contextTypes) &#123;</span><br><span class="line">      context[key] = unmaskedContext[key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">const</span> name = getComponentName(type) || <span class="string">'Unknown'</span>;</span><br><span class="line">      checkPropTypes(contextTypes, context, <span class="string">'context'</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cache unmasked context so we can avoid recreating masked context unless necessary.</span></span><br><span class="line">    <span class="comment">// Context is created before the class component is instantiated so check for instance.</span></span><br><span class="line">    <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">      cacheContext(workInProgress, unmaskedContext, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Don't change these two values. They're used by React Dev Tools.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoEffect = <span class="comment">/*                 */</span> <span class="number">0b00000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PerformedWork = <span class="comment">/*            */</span> <span class="number">0b00000000000001</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountIndeterminateComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  _current,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (_current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// An indeterminate component only mounts if it suspended inside a non-</span></span><br><span class="line">    <span class="comment">// concurrent tree, in an inconsistent state. We want to treat it like</span></span><br><span class="line">    <span class="comment">// a new mount, even though an empty version of it already committed.</span></span><br><span class="line">    <span class="comment">// Disconnect the alternate pointers.</span></span><br><span class="line">    _current.alternate = <span class="literal">null</span>;</span><br><span class="line">    workInProgress.alternate = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">    workInProgress.effectTag |= Placement;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> props = workInProgress.pendingProps;</span><br><span class="line">  <span class="keyword">let</span> context;</span><br><span class="line">  <span class="keyword">if</span> (!disableLegacyContext) &#123;</span><br><span class="line">    <span class="keyword">const</span> unmaskedContext = getUnmaskedContext(</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">    );</span><br><span class="line">    context = getMaskedContext(workInProgress, unmaskedContext); <span class="comment">// &#123;&#125;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  prepareToReadContext(workInProgress, renderExpirationTime);</span><br><span class="line">  <span class="keyword">let</span> value;</span><br><span class="line"></span><br><span class="line">  value = renderWithHooks(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    workInProgress,</span><br><span class="line">    Component,</span><br><span class="line">    props,</span><br><span class="line">    context,</span><br><span class="line">    renderExpirationTime,</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// React DevTools reads this flag.</span></span><br><span class="line">  workInProgress.effectTag |= PerformedWork;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="comment">// Run these checks in production only if the flag is off.</span></span><br><span class="line">    <span class="comment">// Eventually we'll delete this branch altogether.</span></span><br><span class="line">    !disableModulePatternComponents &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> value === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">    value !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> value.render === <span class="string">'function'</span> &amp;&amp;</span><br><span class="line">    value.$$<span class="keyword">typeof</span> === <span class="literal">undefined</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// Proceed under the assumption that this is a class instance</span></span><br><span class="line">    workInProgress.tag = ClassComponent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Throw out any hooks that were used.</span></span><br><span class="line">    workInProgress.memoizedState = <span class="literal">null</span>;</span><br><span class="line">    workInProgress.updateQueue = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Push context providers early to prevent context stack mismatches.</span></span><br><span class="line">    <span class="comment">// During mounting we don't know the child context yet as the instance doesn't exist.</span></span><br><span class="line">    <span class="comment">// We will invalidate the child context in finishClassComponent() right after rendering.</span></span><br><span class="line">    <span class="keyword">let</span> hasContext = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">      hasContext = <span class="literal">true</span>;</span><br><span class="line">      pushLegacyContextProvider(workInProgress);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      hasContext = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    workInProgress.memoizedState =</span><br><span class="line">      value.state !== <span class="literal">null</span> &amp;&amp; value.state !== <span class="literal">undefined</span> ? value.state : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    initializeUpdateQueue(workInProgress);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> getDerivedStateFromProps = Component.getDerivedStateFromProps;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">'function'</span>) &#123;</span><br><span class="line">      applyDerivedStateFromProps(</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        getDerivedStateFromProps,</span><br><span class="line">        props,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    adoptClassInstance(workInProgress, value);</span><br><span class="line">    mountClassInstance(workInProgress, Component, props, renderExpirationTime);</span><br><span class="line">    <span class="keyword">return</span> finishClassComponent(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      hasContext,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Proceed under the assumption that this is a function component</span></span><br><span class="line">    workInProgress.tag = FunctionComponent;</span><br><span class="line">    reconcileChildren(<span class="literal">null</span>, workInProgress, value, renderExpirationTime);</span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="39">
<li>renderWithHooks</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// These are set right before calling the component.</span></span><br><span class="line"><span class="keyword">let</span> renderExpirationTime: ExpirationTime = NoWork;</span><br><span class="line"><span class="comment">// The work-in-progress fiber. I've named it differently to distinguish it from</span></span><br><span class="line"><span class="comment">// the work-in-progress hook.</span></span><br><span class="line"><span class="keyword">let</span> currentlyRenderingFiber: Fiber = (<span class="literal">null</span>: any);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Where an update was scheduled only during the current render pass. This</span></span><br><span class="line"><span class="comment">// gets reset after each attempt.</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Maybe there's some way to consolidate this with</span></span><br><span class="line"><span class="comment">// `didScheduleRenderPhaseUpdate`. Or with `numberOfReRenders`.</span></span><br><span class="line"><span class="keyword">let</span> didScheduleRenderPhaseUpdateDuringThisPass: boolean = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hooks are stored as a linked list on the fiber's memoizedState field. The</span></span><br><span class="line"><span class="comment">// current hook list is the list that belongs to the current fiber. The</span></span><br><span class="line"><span class="comment">// work-in-progress hook list is a new list that will be added to the</span></span><br><span class="line"><span class="comment">// work-in-progress fiber.</span></span><br><span class="line"><span class="keyword">let</span> currentHook: Hook | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> workInProgressHook: Hook | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderWithHooks</span>&lt;<span class="title">Props</span>, <span class="title">SecondArg</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component: (p: Props, arg: SecondArg</span>) =&gt; <span class="title">any</span>,</span></span><br><span class="line"><span class="function">  <span class="title">props</span>: <span class="title">Props</span>,</span></span><br><span class="line"><span class="function">  <span class="title">secondArg</span>: <span class="title">SecondArg</span>,</span></span><br><span class="line"><span class="function">  <span class="title">nextRenderExpirationTime</span>: <span class="title">ExpirationTime</span>,</span></span><br><span class="line"><span class="function">): <span class="title">any</span> </span>&#123;</span><br><span class="line">  renderExpirationTime = nextRenderExpirationTime;</span><br><span class="line">  currentlyRenderingFiber = workInProgress;</span><br><span class="line"></span><br><span class="line">  workInProgress.memoizedState = <span class="literal">null</span>;</span><br><span class="line">  workInProgress.updateQueue = <span class="literal">null</span>;</span><br><span class="line">  workInProgress.expirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The following should have already been reset</span></span><br><span class="line">  <span class="comment">// currentHook = null;</span></span><br><span class="line">  <span class="comment">// workInProgressHook = null;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// didScheduleRenderPhaseUpdate = false;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO Warn if no hooks are used at all during mount, then some are used during update.</span></span><br><span class="line">  <span class="comment">// Currently we will identify the update render as a mount because memoizedState === null.</span></span><br><span class="line">  <span class="comment">// This is tricky because it's valid for certain types of components (e.g. React.lazy)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Using memoizedState to differentiate between mount/update only works if at least one stateful hook is used.</span></span><br><span class="line">  <span class="comment">// Non-stateful hooks (e.g. context) don't get added to memoizedState,</span></span><br><span class="line">  <span class="comment">// so memoizedState would be null during updates and mounts.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ReactCurrentDispatcher用来Keeps track of the current dispatcher.</span></span><br><span class="line">    ReactCurrentDispatcher.current =</span><br><span class="line">      current === <span class="literal">null</span> || current.memoizedState === <span class="literal">null</span></span><br><span class="line">        ? HooksDispatcherOnMount</span><br><span class="line">        : HooksDispatcherOnUpdate;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> children = Component(props, secondArg);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there was a render phase update</span></span><br><span class="line">  <span class="keyword">if</span> (didScheduleRenderPhaseUpdateDuringThisPass) &#123;</span><br><span class="line">    <span class="comment">// Keep rendering in a loop for as long as render phase updates continue to</span></span><br><span class="line">    <span class="comment">// be scheduled. Use a counter to prevent infinite loops.</span></span><br><span class="line">    <span class="keyword">let</span> numberOfReRenders: number = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      didScheduleRenderPhaseUpdateDuringThisPass = <span class="literal">false</span>;</span><br><span class="line">      invariant(</span><br><span class="line">        numberOfReRenders &lt; RE_RENDER_LIMIT,</span><br><span class="line">        <span class="string">'Too many re-renders. React limits the number of renders to prevent '</span> +</span><br><span class="line">          <span class="string">'an infinite loop.'</span>,</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      numberOfReRenders += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Start over from the beginning of the list</span></span><br><span class="line">      currentHook = <span class="literal">null</span>;</span><br><span class="line">      workInProgressHook = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">      workInProgress.updateQueue = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">      ReactCurrentDispatcher.current = __DEV__</span><br><span class="line">        ? HooksDispatcherOnRerenderInDEV</span><br><span class="line">        : HooksDispatcherOnRerender;</span><br><span class="line"></span><br><span class="line">      children = Component(props, secondArg);</span><br><span class="line">    &#125; <span class="keyword">while</span> (didScheduleRenderPhaseUpdateDuringThisPass);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We can assume the previous dispatcher is always this one, since we set it</span></span><br><span class="line">  <span class="comment">// at the beginning of the render phase and there's no re-entrancy.</span></span><br><span class="line">  ReactCurrentDispatcher.current = ContextOnlyDispatcher;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This check uses currentHook so that it works the same in DEV and prod bundles.</span></span><br><span class="line">  <span class="comment">// hookTypesDev could catch more cases (e.g. context) but only in DEV bundles.</span></span><br><span class="line">  <span class="keyword">const</span> didRenderTooFewHooks =</span><br><span class="line">    currentHook !== <span class="literal">null</span> &amp;&amp; currentHook.next !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  renderExpirationTime = NoWork;</span><br><span class="line">  currentlyRenderingFiber = (<span class="literal">null</span>: any);</span><br><span class="line"></span><br><span class="line">  currentHook = <span class="literal">null</span>;</span><br><span class="line">  workInProgressHook = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  didScheduleRenderPhaseUpdate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  invariant(</span><br><span class="line">    !didRenderTooFewHooks,</span><br><span class="line">    <span class="string">'Rendered fewer hooks than expected. This may be caused by an accidental '</span> +</span><br><span class="line">      <span class="string">'early return statement.'</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> children;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="40">
<li>updateHostComponent</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rootInstanceStackCursor.current = div#root</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushHostContext</span>(<span class="params">fiber: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> rootInstance: Container = requiredContext( <span class="comment">// div#root</span></span><br><span class="line">    rootInstanceStackCursor.current,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> context: HostContext = requiredContext(contextStackCursor.current);</span><br><span class="line">  <span class="keyword">const</span> nextContext = getChildHostContext(context, fiber.type, rootInstance);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Don't push this Fiber's context unless it's unique.</span></span><br><span class="line">  <span class="keyword">if</span> (context === nextContext) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Track the context and the Fiber that provided it.</span></span><br><span class="line">  <span class="comment">// This enables us to pop only Fibers that provide unique contexts.</span></span><br><span class="line">  push(contextFiberStackCursor, fiber, fiber);</span><br><span class="line">  push(contextStackCursor, nextContext, fiber);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHostComponent</span>(<span class="params">current, workInProgress, renderExpirationTime</span>) </span>&#123;</span><br><span class="line">  pushHostContext(workInProgress);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    tryToClaimNextHydratableInstance(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">  <span class="keyword">const</span> nextProps = workInProgress.pendingProps;</span><br><span class="line">  <span class="keyword">const</span> prevProps = current !== <span class="literal">null</span> ? current.memoizedProps : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> nextChildren = nextProps.children;</span><br><span class="line">  <span class="keyword">const</span> isDirectTextChild = shouldSetTextContent(type, nextProps);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isDirectTextChild) &#123;</span><br><span class="line">    <span class="comment">// We special case a direct text child of a host node. This is a common</span></span><br><span class="line">    <span class="comment">// case. We won't handle it as a reified child. We will instead handle</span></span><br><span class="line">    <span class="comment">// this in the host environment that also has access to this prop. That</span></span><br><span class="line">    <span class="comment">// avoids allocating another HostText fiber and traversing it.</span></span><br><span class="line">    nextChildren = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevProps !== <span class="literal">null</span> &amp;&amp; shouldSetTextContent(type, prevProps)) &#123;</span><br><span class="line">    <span class="comment">// If we're switching from a direct text child to a normal child, or to</span></span><br><span class="line">    <span class="comment">// empty, we need to schedule the text content to be reset.</span></span><br><span class="line">    workInProgress.effectTag |= ContentReset;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  markRef(current, workInProgress);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check the host config to see if the children are offscreen/hidden.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    workInProgress.mode &amp; ConcurrentMode &amp;&amp;</span><br><span class="line">    renderExpirationTime !== Never &amp;&amp;</span><br><span class="line">    shouldDeprioritizeSubtree(type, nextProps)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">      markSpawnedWork(Never);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Schedule this fiber to re-render at offscreen priority. Then bailout.</span></span><br><span class="line">    workInProgress.expirationTime = workInProgress.childExpirationTime = Never;</span><br><span class="line">    <span class="comment">// We should never render the children of a dehydrated boundary until we</span></span><br><span class="line">    <span class="comment">// upgrade it. We return null instead of bailoutOnAlreadyFinishedWork.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reconcileChildren(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    nextChildren,</span><br><span class="line">    renderExpirationTime,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="41">
<li>reconsileChildrenArray</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildrenArray</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  newChildren: Array&lt;*&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This algorithm can't optimize by searching from both ends since we</span></span><br><span class="line">  <span class="comment">// don't have backpointers on fibers. I'm trying to see how far we can get</span></span><br><span class="line">  <span class="comment">// with that model. If it ends up not being worth the tradeoffs, we can</span></span><br><span class="line">  <span class="comment">// add it later.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Even with a two ended optimization, we'd want to optimize for the case</span></span><br><span class="line">  <span class="comment">// where there are few changes and brute force the comparison instead of</span></span><br><span class="line">  <span class="comment">// going for the Map. It'd like to explore hitting that path first in</span></span><br><span class="line">  <span class="comment">// forward-only mode and only go for the Map once we notice that we need</span></span><br><span class="line">  <span class="comment">// lots of look ahead. This doesn't handle reversal as well as two ended</span></span><br><span class="line">  <span class="comment">// search but that's unusual. Besides, for the two ended optimization to</span></span><br><span class="line">  <span class="comment">// work on Iterables, we'd need to copy the whole set.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// In this first iteration, we'll just live with hitting the bad case</span></span><br><span class="line">  <span class="comment">// (adding everything to a Map) in for every insert/move.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// If you change this code, also update reconcileChildrenIterator() which</span></span><br><span class="line">  <span class="comment">// uses the same algorithm.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> resultingFirstChild: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> previousNewFiber: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> oldFiber = currentFirstChild;</span><br><span class="line">  <span class="keyword">let</span> lastPlacedIndex = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> newIdx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> nextOldFiber = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (; oldFiber !== <span class="literal">null</span> &amp;&amp; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldFiber.index &gt; newIdx) &#123;</span><br><span class="line">      nextOldFiber = oldFiber;</span><br><span class="line">      oldFiber = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nextOldFiber = oldFiber.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> newFiber = updateSlot(</span><br><span class="line">      returnFiber,</span><br><span class="line">      oldFiber,</span><br><span class="line">      newChildren[newIdx],</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> This breaks on empty slots like null children. That's</span></span><br><span class="line">      <span class="comment">// unfortunate because it triggers the slow path all the time. We need</span></span><br><span class="line">      <span class="comment">// a better way to communicate whether this was a miss or null,</span></span><br><span class="line">      <span class="comment">// boolean, undefined, etc.</span></span><br><span class="line">      <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        oldFiber = nextOldFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldFiber &amp;&amp; newFiber.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We matched the slot, but we didn't reuse the existing fiber, so we</span></span><br><span class="line">        <span class="comment">// need to delete the existing child.</span></span><br><span class="line">        deleteChild(returnFiber, oldFiber);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">    <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">      resultingFirstChild = newFiber;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Defer siblings if we're not at the right index for this slot.</span></span><br><span class="line">      <span class="comment">// I.e. if we had null values before, then we want to defer this</span></span><br><span class="line">      <span class="comment">// for each null value. However, we also don't want to call updateSlot</span></span><br><span class="line">      <span class="comment">// with the previous one.</span></span><br><span class="line">      previousNewFiber.sibling = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line">    previousNewFiber = newFiber;</span><br><span class="line">    oldFiber = nextOldFiber;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newIdx === newChildren.length) &#123;</span><br><span class="line">    <span class="comment">// We've reached the end of the new children. We can delete the rest.</span></span><br><span class="line">    deleteRemainingChildren(returnFiber, oldFiber);</span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If we don't have any more existing children we can choose a fast path</span></span><br><span class="line">    <span class="comment">// since the rest will all be insertions.</span></span><br><span class="line">    <span class="keyword">for</span> (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">      <span class="keyword">const</span> newFiber = createChild(</span><br><span class="line">        returnFiber,</span><br><span class="line">        newChildren[newIdx],</span><br><span class="line">        expirationTime,</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">      <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">        resultingFirstChild = newFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        previousNewFiber.sibling = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      previousNewFiber = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add all children to a key map for quick lookups.</span></span><br><span class="line">  <span class="keyword">const</span> existingChildren = mapRemainingChildren(returnFiber, oldFiber);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Keep scanning and use the map to restore deleted items as moves.</span></span><br><span class="line">  <span class="keyword">for</span> (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">    <span class="keyword">const</span> newFiber = updateFromMap(</span><br><span class="line">      existingChildren,</span><br><span class="line">      returnFiber,</span><br><span class="line">      newIdx,</span><br><span class="line">      newChildren[newIdx],</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (newFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">        <span class="keyword">if</span> (newFiber.alternate !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// The new fiber is a work in progress, but if there exists a</span></span><br><span class="line">          <span class="comment">// current, that means that we reused the fiber. We need to delete</span></span><br><span class="line">          <span class="comment">// it from the child list so that we don't add it to the deletion</span></span><br><span class="line">          <span class="comment">// list.</span></span><br><span class="line">          existingChildren.delete(</span><br><span class="line">            newFiber.key === <span class="literal">null</span> ? newIdx : newFiber.key,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">      <span class="comment">// 通过下面两个分支代码创建数组组件元素的兄弟节点关系</span></span><br><span class="line">      <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        resultingFirstChild = newFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        previousNewFiber.sibling = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      previousNewFiber = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">    <span class="comment">// Any existing children that weren't consumed above were deleted. We need</span></span><br><span class="line">    <span class="comment">// to add them to the deletion list.</span></span><br><span class="line">    existingChildren.forEach(<span class="function"><span class="params">child</span> =&gt;</span> deleteChild(returnFiber, child));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="42">
<li>createChild</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createChild</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'string'</span> || <span class="keyword">typeof</span> newChild === <span class="string">'number'</span>) &#123;</span><br><span class="line">    <span class="comment">// Text nodes don't have keys. If the previous node is implicitly keyed</span></span><br><span class="line">    <span class="comment">// we can continue to replace it without aborting even if it is not a text</span></span><br><span class="line">    <span class="comment">// node.</span></span><br><span class="line">    <span class="keyword">const</span> created = createFiberFromText(</span><br><span class="line">      <span class="string">''</span> + newChild,</span><br><span class="line">      returnFiber.mode,</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">    created.return = returnFiber;</span><br><span class="line">    <span class="keyword">return</span> created;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp; newChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (newChild.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> REACT_ELEMENT_TYPE: &#123;</span><br><span class="line">        <span class="keyword">const</span> created = createFiberFromElement(</span><br><span class="line">          newChild,</span><br><span class="line">          returnFiber.mode,</span><br><span class="line">          expirationTime,</span><br><span class="line">        );</span><br><span class="line">        created.ref = coerceRef(returnFiber, <span class="literal">null</span>, newChild);</span><br><span class="line">        created.return = returnFiber;</span><br><span class="line">        <span class="keyword">return</span> created;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> REACT_PORTAL_TYPE: &#123;</span><br><span class="line">        <span class="keyword">const</span> created = createFiberFromPortal(</span><br><span class="line">          newChild,</span><br><span class="line">          returnFiber.mode,</span><br><span class="line">          expirationTime,</span><br><span class="line">        );</span><br><span class="line">        created.return = returnFiber;</span><br><span class="line">        <span class="keyword">return</span> created;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isArray(newChild) || getIteratorFn(newChild)) &#123;</span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromFragment(</span><br><span class="line">        newChild,</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        expirationTime,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">      );</span><br><span class="line">      created.return = returnFiber;</span><br><span class="line">      <span class="keyword">return</span> created;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    throwOnInvalidObjectType(returnFiber, newChild);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="43">
<li>placeChild</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">placeChild</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  newFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  lastPlacedIndex: number,</span></span></span><br><span class="line"><span class="function"><span class="params">  newIndex: number,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  newFiber.index = newIndex;</span><br><span class="line">  <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">    <span class="comment">// Noop.</span></span><br><span class="line">    <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> current = newFiber.alternate;</span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldIndex = current.index;</span><br><span class="line">    <span class="keyword">if</span> (oldIndex &lt; lastPlacedIndex) &#123;</span><br><span class="line">      <span class="comment">// This is a move.</span></span><br><span class="line">      newFiber.effectTag = Placement;</span><br><span class="line">      <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This item can stay in place.</span></span><br><span class="line">      <span class="keyword">return</span> oldIndex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// This is an insertion.</span></span><br><span class="line">    newFiber.effectTag = Placement;</span><br><span class="line">    <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="44">
<li>deleteRemainingChildren</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteRemainingChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">    <span class="comment">// Noop.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> For the shouldClone case, this could be micro-optimized a bit by</span></span><br><span class="line">  <span class="comment">// assuming that after the first child we've already added everything.</span></span><br><span class="line">  <span class="keyword">let</span> childToDelete = currentFirstChild;</span><br><span class="line">  <span class="keyword">while</span> (childToDelete !== <span class="literal">null</span>) &#123;</span><br><span class="line">    deleteChild(returnFiber, childToDelete);</span><br><span class="line">    childToDelete = childToDelete.sibling;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="45">
<li>completeUnitOfWork</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Attempt to complete the current unit of work, then move to the next</span></span><br><span class="line">  <span class="comment">// sibling. If there are no more siblings, return to the parent fiber.</span></span><br><span class="line">  <span class="keyword">let</span> completedWork = unitOfWork;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// The current, flushed, state of this fiber is the alternate. Ideally</span></span><br><span class="line">    <span class="comment">// nothing should rely on this, but relying on it here means that we don't</span></span><br><span class="line">    <span class="comment">// need an additional field on the work in progress.</span></span><br><span class="line">    <span class="keyword">const</span> current = completedWork.alternate;</span><br><span class="line">    <span class="keyword">const</span> returnFiber = completedWork.return;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if the work completed or if something threw.</span></span><br><span class="line">    <span class="keyword">if</span> ((completedWork.effectTag &amp; Incomplete) === NoEffect) &#123;</span><br><span class="line">      setCurrentDebugFiberInDEV(completedWork);</span><br><span class="line">      <span class="keyword">let</span> next;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        !enableProfilerTimer ||</span><br><span class="line">        (completedWork.mode &amp; ProfileMode) === NoMode</span><br><span class="line">      ) &#123;</span><br><span class="line">        next = completeWork(current, completedWork, renderExpirationTime);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        startProfilerTimer(completedWork);</span><br><span class="line">        next = completeWork(current, completedWork, renderExpirationTime);</span><br><span class="line">        <span class="comment">// Update render duration assuming we didn't error.</span></span><br><span class="line">        stopProfilerTimerIfRunningAndRecordDelta(completedWork, <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      resetCurrentDebugFiberInDEV();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Completing this fiber spawned new work. Work on that next.</span></span><br><span class="line">        workInProgress = next;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      resetChildExpirationTime(completedWork);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        returnFiber !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// Do not append effects to parents if a sibling failed to complete</span></span><br><span class="line">        (returnFiber.effectTag &amp; Incomplete) === NoEffect</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Append all the effects of the subtree and this fiber onto the effect</span></span><br><span class="line">        <span class="comment">// list of the parent. The completion order of the children affects the</span></span><br><span class="line">        <span class="comment">// side-effect order.</span></span><br><span class="line">        <span class="keyword">if</span> (returnFiber.firstEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">          returnFiber.firstEffect = completedWork.firstEffect;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (completedWork.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (returnFiber.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">            returnFiber.lastEffect.nextEffect = completedWork.firstEffect;</span><br><span class="line">          &#125;</span><br><span class="line">          returnFiber.lastEffect = completedWork.lastEffect;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If this fiber had side-effects, we append it AFTER the children's</span></span><br><span class="line">        <span class="comment">// side-effects. We can perform certain side-effects earlier if needed,</span></span><br><span class="line">        <span class="comment">// by doing multiple passes over the effect list. We don't want to</span></span><br><span class="line">        <span class="comment">// schedule our own side-effect on our own list because if end up</span></span><br><span class="line">        <span class="comment">// reusing children we'll schedule this effect onto itself since we're</span></span><br><span class="line">        <span class="comment">// at the end.</span></span><br><span class="line">        <span class="keyword">const</span> effectTag = completedWork.effectTag;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Skip both NoWork and PerformedWork tags when creating the effect</span></span><br><span class="line">        <span class="comment">// list. PerformedWork effect is read by React DevTools but shouldn't be</span></span><br><span class="line">        <span class="comment">// committed.</span></span><br><span class="line">        <span class="keyword">if</span> (effectTag &gt; PerformedWork) &#123;</span><br><span class="line">          <span class="keyword">if</span> (returnFiber.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">            returnFiber.lastEffect.nextEffect = completedWork;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            returnFiber.firstEffect = completedWork;</span><br><span class="line">          &#125;</span><br><span class="line">          returnFiber.lastEffect = completedWork;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This fiber did not complete because something threw. Pop values off</span></span><br><span class="line">      <span class="comment">// the stack without entering the complete phase. If this is a boundary,</span></span><br><span class="line">      <span class="comment">// capture values if possible.</span></span><br><span class="line">      <span class="keyword">const</span> next = unwindWork(completedWork, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Because this fiber did not complete, don't reset its expiration time.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If completing this work spawned new work, do that next. We'll come</span></span><br><span class="line">        <span class="comment">// back here again.</span></span><br><span class="line">        <span class="comment">// Since we're restarting, remove anything that is not a host effect</span></span><br><span class="line">        <span class="comment">// from the effect tag.</span></span><br><span class="line">        next.effectTag &amp;= HostEffectMask;</span><br><span class="line">        workInProgress = next;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        enableProfilerTimer &amp;&amp;</span><br><span class="line">        (completedWork.mode &amp; ProfileMode) !== NoMode</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Record the render duration for the fiber that errored.</span></span><br><span class="line">        stopProfilerTimerIfRunningAndRecordDelta(completedWork, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Include the time spent working on failed children before continuing.</span></span><br><span class="line">        <span class="keyword">let</span> actualDuration = completedWork.actualDuration;</span><br><span class="line">        <span class="keyword">let</span> child = completedWork.child;</span><br><span class="line">        <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">          actualDuration += child.actualDuration;</span><br><span class="line">          child = child.sibling;</span><br><span class="line">        &#125;</span><br><span class="line">        completedWork.actualDuration = actualDuration;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Mark the parent fiber as incomplete and clear its effect list.</span></span><br><span class="line">        returnFiber.firstEffect = returnFiber.lastEffect = <span class="literal">null</span>;</span><br><span class="line">        returnFiber.effectTag |= Incomplete;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> siblingFiber = completedWork.sibling;</span><br><span class="line">    <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">      workInProgress = siblingFiber;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise, return to the parent</span></span><br><span class="line">    completedWork = returnFiber;</span><br><span class="line">    <span class="comment">// Update the next thing we're working on in case something throws.</span></span><br><span class="line">    workInProgress = completedWork;</span><br><span class="line">  &#125; <span class="keyword">while</span> (completedWork !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We've reached the root.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRootExitStatus === RootIncomplete) &#123;</span><br><span class="line">    workInProgressRootExitStatus = RootCompleted;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="46">
<li>completeWork</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> newProps = workInProgress.pendingProps;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> IndeterminateComponent:</span><br><span class="line">    <span class="keyword">case</span> LazyComponent:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent:</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> Fragment:</span><br><span class="line">    <span class="keyword">case</span> Mode:</span><br><span class="line">    <span class="keyword">case</span> Profiler:</span><br><span class="line">    <span class="keyword">case</span> ContextConsumer:</span><br><span class="line">    <span class="keyword">case</span> MemoComponent:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">        popLegacyContext(workInProgress);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">      popHostContainer(workInProgress);</span><br><span class="line">      popTopLevelLegacyContextObject(workInProgress);</span><br><span class="line">      resetMutableSourceWorkInProgressVersions();</span><br><span class="line">      <span class="keyword">const</span> fiberRoot = (workInProgress.stateNode: FiberRoot);</span><br><span class="line">      <span class="keyword">if</span> (fiberRoot.pendingContext) &#123;</span><br><span class="line">        fiberRoot.context = fiberRoot.pendingContext;</span><br><span class="line">        fiberRoot.pendingContext = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (current === <span class="literal">null</span> || current.child === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If we hydrated, pop so that we can delete any remaining children</span></span><br><span class="line">        <span class="comment">// that weren't hydrated.</span></span><br><span class="line">        <span class="keyword">const</span> wasHydrated = popHydrationState(workInProgress);</span><br><span class="line">        <span class="keyword">if</span> (wasHydrated) &#123;</span><br><span class="line">          <span class="comment">// If we hydrated, then we'll need to schedule an update for</span></span><br><span class="line">          <span class="comment">// the commit side-effects on the root.</span></span><br><span class="line">          markUpdate(workInProgress);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!fiberRoot.hydrate) &#123;</span><br><span class="line">          <span class="comment">// Schedule an effect to clear this container at the start of the next commit.</span></span><br><span class="line">          <span class="comment">// This handles the case of React rendering into a container with previous children.</span></span><br><span class="line">          <span class="comment">// It's also safe to do for updates too, because current.child would only be null</span></span><br><span class="line">          <span class="comment">// if the previous render was null (so the the container would already be empty).</span></span><br><span class="line">          workInProgress.effectTag |= Snapshot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      updateHostContainer(workInProgress);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">      popHostContext(workInProgress);</span><br><span class="line">      <span class="keyword">const</span> rootContainerInstance = getRootHostContainer();</span><br><span class="line">      <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">      <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; workInProgress.stateNode != <span class="literal">null</span>) &#123;</span><br><span class="line">        updateHostComponent(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          type,</span><br><span class="line">          newProps,</span><br><span class="line">          rootContainerInstance,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (enableDeprecatedFlareAPI) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevListeners = current.memoizedProps.DEPRECATED_flareListeners;</span><br><span class="line">          <span class="keyword">const</span> nextListeners = newProps.DEPRECATED_flareListeners;</span><br><span class="line">          <span class="keyword">if</span> (prevListeners !== nextListeners) &#123;</span><br><span class="line">            markUpdate(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.ref !== workInProgress.ref) &#123;</span><br><span class="line">          markRef(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!newProps) &#123;</span><br><span class="line">          invariant(</span><br><span class="line">            workInProgress.stateNode !== <span class="literal">null</span>,</span><br><span class="line">            <span class="string">'We must have new props for new mounts. This error is likely '</span> +</span><br><span class="line">              <span class="string">'caused by a bug in React. Please file an issue.'</span>,</span><br><span class="line">          );</span><br><span class="line">          <span class="comment">// This can happen when we abort work.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> currentHostContext = getHostContext();</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Move createInstance to beginWork and keep it on a context</span></span><br><span class="line">        <span class="comment">// "stack" as the parent. Then append children as we go in beginWork</span></span><br><span class="line">        <span class="comment">// or completeWork depending on whether we want to add them top-&gt;down or</span></span><br><span class="line">        <span class="comment">// bottom-&gt;up. Top-&gt;down is faster in IE11.</span></span><br><span class="line">        <span class="keyword">const</span> wasHydrated = popHydrationState(workInProgress);</span><br><span class="line">        <span class="keyword">if</span> (wasHydrated) &#123;</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> Move this and createInstance step into the beginPhase</span></span><br><span class="line">          <span class="comment">// to consolidate.</span></span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            prepareToHydrateHostInstance(</span><br><span class="line">              workInProgress,</span><br><span class="line">              rootContainerInstance,</span><br><span class="line">              currentHostContext,</span><br><span class="line">            )</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="comment">// If changes to the hydrated node need to be applied at the</span></span><br><span class="line">            <span class="comment">// commit-phase we mark this as such.</span></span><br><span class="line">            markUpdate(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (enableDeprecatedFlareAPI) &#123;</span><br><span class="line">            <span class="keyword">const</span> listeners = newProps.DEPRECATED_flareListeners;</span><br><span class="line">            <span class="keyword">if</span> (listeners != <span class="literal">null</span>) &#123;</span><br><span class="line">              updateDeprecatedEventListeners(</span><br><span class="line">                listeners,</span><br><span class="line">                workInProgress,</span><br><span class="line">                rootContainerInstance,</span><br><span class="line">              );</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> instance = createInstance(</span><br><span class="line">            type,</span><br><span class="line">            newProps,</span><br><span class="line">            rootContainerInstance,</span><br><span class="line">            currentHostContext,</span><br><span class="line">            workInProgress,</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">          appendAllChildren(instance, workInProgress, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// This needs to be set before we mount Flare event listeners</span></span><br><span class="line">          workInProgress.stateNode = instance;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (enableDeprecatedFlareAPI) &#123;</span><br><span class="line">            <span class="keyword">const</span> listeners = newProps.DEPRECATED_flareListeners;</span><br><span class="line">            <span class="keyword">if</span> (listeners != <span class="literal">null</span>) &#123;</span><br><span class="line">              updateDeprecatedEventListeners(</span><br><span class="line">                listeners,</span><br><span class="line">                workInProgress,</span><br><span class="line">                rootContainerInstance,</span><br><span class="line">              );</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Certain renderers require commit-time effects for initial mount.</span></span><br><span class="line">          <span class="comment">// (eg DOM renderer supports auto-focus for certain elements).</span></span><br><span class="line">          <span class="comment">// Make sure such renderers get scheduled for later work.</span></span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            finalizeInitialChildren(</span><br><span class="line">              instance,</span><br><span class="line">              type,</span><br><span class="line">              newProps,</span><br><span class="line">              rootContainerInstance,</span><br><span class="line">              currentHostContext,</span><br><span class="line">            )</span><br><span class="line">          ) &#123;</span><br><span class="line">            markUpdate(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInProgress.ref !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// If there is a ref on a host node we need to schedule a callback</span></span><br><span class="line">          markRef(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostText: &#123;</span><br><span class="line">      <span class="keyword">const</span> newText = newProps;</span><br><span class="line">      <span class="keyword">if</span> (current &amp;&amp; workInProgress.stateNode != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> oldText = current.memoizedProps;</span><br><span class="line">        <span class="comment">// If we have an alternate, that means this is an update and we need</span></span><br><span class="line">        <span class="comment">// to schedule a side-effect to do the updates.</span></span><br><span class="line">        updateHostText(current, workInProgress, oldText, newText);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> newText !== <span class="string">'string'</span>) &#123;</span><br><span class="line">          invariant(</span><br><span class="line">            workInProgress.stateNode !== <span class="literal">null</span>,</span><br><span class="line">            <span class="string">'We must have new props for new mounts. This error is likely '</span> +</span><br><span class="line">              <span class="string">'caused by a bug in React. Please file an issue.'</span>,</span><br><span class="line">          );</span><br><span class="line">          <span class="comment">// This can happen when we abort work.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> rootContainerInstance = getRootHostContainer();</span><br><span class="line">        <span class="keyword">const</span> currentHostContext = getHostContext();</span><br><span class="line">        <span class="keyword">const</span> wasHydrated = popHydrationState(workInProgress);</span><br><span class="line">        <span class="keyword">if</span> (wasHydrated) &#123;</span><br><span class="line">          <span class="keyword">if</span> (prepareToHydrateHostTextInstance(workInProgress)) &#123;</span><br><span class="line">            markUpdate(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          workInProgress.stateNode = createTextInstance(</span><br><span class="line">            newText,</span><br><span class="line">            rootContainerInstance,</span><br><span class="line">            currentHostContext,</span><br><span class="line">            workInProgress,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">      popSuspenseContext(workInProgress);</span><br><span class="line">      <span class="keyword">const</span> nextState: <span class="literal">null</span> | SuspenseState = workInProgress.memoizedState;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (enableSuspenseServerRenderer) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextState !== <span class="literal">null</span> &amp;&amp; nextState.dehydrated !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> wasHydrated = popHydrationState(workInProgress);</span><br><span class="line">            invariant(</span><br><span class="line">              wasHydrated,</span><br><span class="line">              <span class="string">'A dehydrated suspense component was completed without a hydrated node. '</span> +</span><br><span class="line">                <span class="string">'This is probably a bug in React.'</span>,</span><br><span class="line">            );</span><br><span class="line">            prepareToHydrateHostSuspenseInstance(workInProgress);</span><br><span class="line">            <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">              markSpawnedWork(Never);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// We should never have been in a hydration state if we didn't have a current.</span></span><br><span class="line">            <span class="comment">// However, in some of those paths, we might have reentered a hydration state</span></span><br><span class="line">            <span class="comment">// and then we might be inside a hydration state. In that case, we'll need to exit out of it.</span></span><br><span class="line">            resetHydrationState();</span><br><span class="line">            <span class="keyword">if</span> ((workInProgress.effectTag &amp; DidCapture) === NoEffect) &#123;</span><br><span class="line">              <span class="comment">// This boundary did not suspend so it's now hydrated and unsuspended.</span></span><br><span class="line">              workInProgress.memoizedState = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If nothing suspended, we need to schedule an effect to mark this boundary</span></span><br><span class="line">            <span class="comment">// as having hydrated so events know that they're free to be invoked.</span></span><br><span class="line">            <span class="comment">// It's also a signal to replay events and the suspense callback.</span></span><br><span class="line">            <span class="comment">// If something suspended, schedule an effect to attach retry listeners.</span></span><br><span class="line">            <span class="comment">// So we might as well always mark this.</span></span><br><span class="line">            workInProgress.effectTag |= Update;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((workInProgress.effectTag &amp; DidCapture) !== NoEffect) &#123;</span><br><span class="line">        <span class="comment">// Something suspended. Re-render with the fallback children.</span></span><br><span class="line">        workInProgress.expirationTime = renderExpirationTime;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          enableProfilerTimer &amp;&amp;</span><br><span class="line">          (workInProgress.mode &amp; ProfileMode) !== NoMode</span><br><span class="line">        ) &#123;</span><br><span class="line">          transferActualDuration(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Do not reset the effect list.</span></span><br><span class="line">        <span class="keyword">return</span> workInProgress;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> nextDidTimeout = nextState !== <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">let</span> prevDidTimeout = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (workInProgress.memoizedProps.fallback !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          popHydrationState(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> prevState: <span class="literal">null</span> | SuspenseState = current.memoizedState;</span><br><span class="line">        prevDidTimeout = prevState !== <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!nextDidTimeout &amp;&amp; prevState !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// We just switched from the fallback to the normal children.</span></span><br><span class="line">          <span class="comment">// Delete the fallback.</span></span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> Would it be better to store the fallback fragment on</span></span><br><span class="line">          <span class="comment">// the stateNode during the begin phase?</span></span><br><span class="line">          <span class="keyword">const</span> currentFallbackChild: Fiber | <span class="literal">null</span> = (current.child: any)</span><br><span class="line">            .sibling;</span><br><span class="line">          <span class="keyword">if</span> (currentFallbackChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Deletions go at the beginning of the return fiber's effect list</span></span><br><span class="line">            <span class="keyword">const</span> first = workInProgress.firstEffect;</span><br><span class="line">            <span class="keyword">if</span> (first !== <span class="literal">null</span>) &#123;</span><br><span class="line">              workInProgress.firstEffect = currentFallbackChild;</span><br><span class="line">              currentFallbackChild.nextEffect = first;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              workInProgress.firstEffect = workInProgress.lastEffect = currentFallbackChild;</span><br><span class="line">              currentFallbackChild.nextEffect = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            currentFallbackChild.effectTag = Deletion;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (nextDidTimeout &amp;&amp; !prevDidTimeout) &#123;</span><br><span class="line">        <span class="comment">// If this subtreee is running in blocking mode we can suspend,</span></span><br><span class="line">        <span class="comment">// otherwise we won't suspend.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This will still suspend a synchronous tree if anything</span></span><br><span class="line">        <span class="comment">// in the concurrent tree already suspended during this render.</span></span><br><span class="line">        <span class="comment">// This is a known bug.</span></span><br><span class="line">        <span class="keyword">if</span> ((workInProgress.mode &amp; BlockingMode) !== NoMode) &#123;</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> Move this back to throwException because this is too late</span></span><br><span class="line">          <span class="comment">// if this is a large tree which is common for initial loads. We</span></span><br><span class="line">          <span class="comment">// don't know if we should restart a render or not until we get</span></span><br><span class="line">          <span class="comment">// this marker, and this is too late.</span></span><br><span class="line">          <span class="comment">// If this render already had a ping or lower pri updates,</span></span><br><span class="line">          <span class="comment">// and this is the first time we know we're going to suspend we</span></span><br><span class="line">          <span class="comment">// should be able to immediately restart from within throwException.</span></span><br><span class="line">          <span class="keyword">const</span> hasInvisibleChildContext =</span><br><span class="line">            current === <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            workInProgress.memoizedProps.unstable_avoidThisFallback !== <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            hasInvisibleChildContext ||</span><br><span class="line">            hasSuspenseContext(</span><br><span class="line">              suspenseStackCursor.current,</span><br><span class="line">              (InvisibleParentSuspenseContext: SuspenseContext),</span><br><span class="line">            )</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="comment">// If this was in an invisible tree or a new render, then showing</span></span><br><span class="line">            <span class="comment">// this boundary is ok.</span></span><br><span class="line">            renderDidSuspend();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Otherwise, we're going to have to hide content so we should</span></span><br><span class="line">            <span class="comment">// suspend for longer if possible.</span></span><br><span class="line">            renderDidSuspendDelayIfPossible();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (supportsPersistence) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Only schedule updates if not prevDidTimeout.</span></span><br><span class="line">        <span class="keyword">if</span> (nextDidTimeout) &#123;</span><br><span class="line">          <span class="comment">// If this boundary just timed out, schedule an effect to attach a</span></span><br><span class="line">          <span class="comment">// retry listener to the promise. This flag is also used to hide the</span></span><br><span class="line">          <span class="comment">// primary children.</span></span><br><span class="line">          workInProgress.effectTag |= Update;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Only schedule updates if these values are non equal, i.e. it changed.</span></span><br><span class="line">        <span class="keyword">if</span> (nextDidTimeout || prevDidTimeout) &#123;</span><br><span class="line">          <span class="comment">// If this boundary just timed out, schedule an effect to attach a</span></span><br><span class="line">          <span class="comment">// retry listener to the promise. This flag is also used to hide the</span></span><br><span class="line">          <span class="comment">// primary children. In mutation mode, we also need the flag to</span></span><br><span class="line">          <span class="comment">// *unhide* children that were previously hidden, so check if this</span></span><br><span class="line">          <span class="comment">// is currently timed out, too.</span></span><br><span class="line">          workInProgress.effectTag |= Update;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        enableSuspenseCallback &amp;&amp;</span><br><span class="line">        workInProgress.updateQueue !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        workInProgress.memoizedProps.suspenseCallback != <span class="literal">null</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Always notify the callback</span></span><br><span class="line">        workInProgress.effectTag |= Update;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">      popHostContainer(workInProgress);</span><br><span class="line">      updateHostContainer(workInProgress);</span><br><span class="line">      <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">        preparePortalMount(workInProgress.stateNode.containerInfo);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">case</span> ContextProvider:</span><br><span class="line">      <span class="comment">// Pop provider fiber</span></span><br><span class="line">      popProvider(workInProgress);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent: &#123;</span><br><span class="line">      <span class="comment">// Same as class component case. I put it down here so that the tags are</span></span><br><span class="line">      <span class="comment">// sequential to ensure this switch is compiled to a jump table.</span></span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">        popLegacyContext(workInProgress);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">      popSuspenseContext(workInProgress);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> renderState: <span class="literal">null</span> | SuspenseListRenderState =</span><br><span class="line">        workInProgress.memoizedState;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (renderState === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We're running in the default, "independent" mode.</span></span><br><span class="line">        <span class="comment">// We don't do anything in this mode.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> didSuspendAlready =</span><br><span class="line">        (workInProgress.effectTag &amp; DidCapture) !== NoEffect;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> renderedTail = renderState.rendering;</span><br><span class="line">      <span class="keyword">if</span> (renderedTail === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We just rendered the head.</span></span><br><span class="line">        <span class="keyword">if</span> (!didSuspendAlready) &#123;</span><br><span class="line">          <span class="comment">// This is the first pass. We need to figure out if anything is still</span></span><br><span class="line">          <span class="comment">// suspended in the rendered set.</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">// If new content unsuspended, but there's still some content that</span></span><br><span class="line">          <span class="comment">// didn't. Then we need to do a second pass that forces everything</span></span><br><span class="line">          <span class="comment">// to keep showing their fallbacks.</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">// We might be suspended if something in this render pass suspended, or</span></span><br><span class="line">          <span class="comment">// something in the previous committed pass suspended. Otherwise,</span></span><br><span class="line">          <span class="comment">// there's no chance so we can skip the expensive call to</span></span><br><span class="line">          <span class="comment">// findFirstSuspended.</span></span><br><span class="line">          <span class="keyword">const</span> cannotBeSuspended =</span><br><span class="line">            renderHasNotSuspendedYet() &amp;&amp;</span><br><span class="line">            (current === <span class="literal">null</span> || (current.effectTag &amp; DidCapture) === NoEffect);</span><br><span class="line">          <span class="keyword">if</span> (!cannotBeSuspended) &#123;</span><br><span class="line">            <span class="keyword">let</span> row = workInProgress.child;</span><br><span class="line">            <span class="keyword">while</span> (row !== <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">const</span> suspended = findFirstSuspended(row);</span><br><span class="line">              <span class="keyword">if</span> (suspended !== <span class="literal">null</span>) &#123;</span><br><span class="line">                didSuspendAlready = <span class="literal">true</span>;</span><br><span class="line">                workInProgress.effectTag |= DidCapture;</span><br><span class="line">                cutOffTailIfNeeded(renderState, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If this is a newly suspended tree, it might not get committed as</span></span><br><span class="line">                <span class="comment">// part of the second pass. In that case nothing will subscribe to</span></span><br><span class="line">                <span class="comment">// its thennables. Instead, we'll transfer its thennables to the</span></span><br><span class="line">                <span class="comment">// SuspenseList so that it can retry if they resolve.</span></span><br><span class="line">                <span class="comment">// There might be multiple of these in the list but since we're</span></span><br><span class="line">                <span class="comment">// going to wait for all of them anyway, it doesn't really matter</span></span><br><span class="line">                <span class="comment">// which ones gets to ping. In theory we could get clever and keep</span></span><br><span class="line">                <span class="comment">// track of how many dependencies remain but it gets tricky because</span></span><br><span class="line">                <span class="comment">// in the meantime, we can add/remove/change items and dependencies.</span></span><br><span class="line">                <span class="comment">// We might bail out of the loop before finding any but that</span></span><br><span class="line">                <span class="comment">// doesn't matter since that means that the other boundaries that</span></span><br><span class="line">                <span class="comment">// we did find already has their listeners attached.</span></span><br><span class="line">                <span class="keyword">const</span> newThennables = suspended.updateQueue;</span><br><span class="line">                <span class="keyword">if</span> (newThennables !== <span class="literal">null</span>) &#123;</span><br><span class="line">                  workInProgress.updateQueue = newThennables;</span><br><span class="line">                  workInProgress.effectTag |= Update;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Rerender the whole list, but this time, we'll force fallbacks</span></span><br><span class="line">                <span class="comment">// to stay in place.</span></span><br><span class="line">                <span class="comment">// Reset the effect list before doing the second pass since that's now invalid.</span></span><br><span class="line">                <span class="keyword">if</span> (renderState.lastEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">                  workInProgress.firstEffect = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                workInProgress.lastEffect = renderState.lastEffect;</span><br><span class="line">                <span class="comment">// Reset the child fibers to their original state.</span></span><br><span class="line">                resetChildFibers(workInProgress, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Set up the Suspense Context to force suspense and immediately</span></span><br><span class="line">                <span class="comment">// rerender the children.</span></span><br><span class="line">                pushSuspenseContext(</span><br><span class="line">                  workInProgress,</span><br><span class="line">                  setShallowSuspenseContext(</span><br><span class="line">                    suspenseStackCursor.current,</span><br><span class="line">                    ForceSuspenseFallback,</span><br><span class="line">                  ),</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">              &#125;</span><br><span class="line">              row = row.sibling;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          cutOffTailIfNeeded(renderState, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Next we're going to render the tail.</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Append the rendered row to the child list.</span></span><br><span class="line">        <span class="keyword">if</span> (!didSuspendAlready) &#123;</span><br><span class="line">          <span class="keyword">const</span> suspended = findFirstSuspended(renderedTail);</span><br><span class="line">          <span class="keyword">if</span> (suspended !== <span class="literal">null</span>) &#123;</span><br><span class="line">            workInProgress.effectTag |= DidCapture;</span><br><span class="line">            didSuspendAlready = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ensure we transfer the update queue to the parent so that it doesn't</span></span><br><span class="line">            <span class="comment">// get lost if this row ends up dropped during a second pass.</span></span><br><span class="line">            <span class="keyword">const</span> newThennables = suspended.updateQueue;</span><br><span class="line">            <span class="keyword">if</span> (newThennables !== <span class="literal">null</span>) &#123;</span><br><span class="line">              workInProgress.updateQueue = newThennables;</span><br><span class="line">              workInProgress.effectTag |= Update;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cutOffTailIfNeeded(renderState, <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// This might have been modified.</span></span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">              renderState.tail === <span class="literal">null</span> &amp;&amp;</span><br><span class="line">              renderState.tailMode === <span class="string">'hidden'</span> &amp;&amp;</span><br><span class="line">              !renderedTail.alternate &amp;&amp;</span><br><span class="line">              !getIsHydrating() <span class="comment">// We don't cut it if we're hydrating.</span></span><br><span class="line">            ) &#123;</span><br><span class="line">              <span class="comment">// We need to delete the row we just rendered.</span></span><br><span class="line">              <span class="comment">// Reset the effect list to what it was before we rendered this</span></span><br><span class="line">              <span class="comment">// child. The nested children have already appended themselves.</span></span><br><span class="line">              <span class="keyword">const</span> lastEffect = (workInProgress.lastEffect =</span><br><span class="line">                renderState.lastEffect);</span><br><span class="line">              <span class="comment">// Remove any effects that were appended after this point.</span></span><br><span class="line">              <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">                lastEffect.nextEffect = <span class="literal">null</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// We're done.</span></span><br><span class="line">              <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">            <span class="comment">// The time it took to render last row is greater than time until</span></span><br><span class="line">            <span class="comment">// the expiration.</span></span><br><span class="line">            now() * <span class="number">2</span> - renderState.renderingStartTime &gt;</span><br><span class="line">              renderState.tailExpiration &amp;&amp;</span><br><span class="line">            renderExpirationTime &gt; Never</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="comment">// We have now passed our CPU deadline and we'll just give up further</span></span><br><span class="line">            <span class="comment">// attempts to render the main content and only render fallbacks.</span></span><br><span class="line">            <span class="comment">// The assumption is that this is usually faster.</span></span><br><span class="line">            workInProgress.effectTag |= DidCapture;</span><br><span class="line">            didSuspendAlready = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            cutOffTailIfNeeded(renderState, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Since nothing actually suspended, there will nothing to ping this</span></span><br><span class="line">            <span class="comment">// to get it started back up to attempt the next item. If we can show</span></span><br><span class="line">            <span class="comment">// them, then they really have the same priority as this render.</span></span><br><span class="line">            <span class="comment">// So we'll pick it back up the very next render pass once we've had</span></span><br><span class="line">            <span class="comment">// an opportunity to yield for paint.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> nextPriority = renderExpirationTime - <span class="number">1</span>;</span><br><span class="line">            workInProgress.expirationTime = workInProgress.childExpirationTime = nextPriority;</span><br><span class="line">            <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">              markSpawnedWork(nextPriority);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (renderState.isBackwards) &#123;</span><br><span class="line">          <span class="comment">// The effect list of the backwards tail will have been added</span></span><br><span class="line">          <span class="comment">// to the end. This breaks the guarantee that life-cycles fire in</span></span><br><span class="line">          <span class="comment">// sibling order but that isn't a strong guarantee promised by React.</span></span><br><span class="line">          <span class="comment">// Especially since these might also just pop in during future commits.</span></span><br><span class="line">          <span class="comment">// Append to the beginning of the list.</span></span><br><span class="line">          renderedTail.sibling = workInProgress.child;</span><br><span class="line">          workInProgress.child = renderedTail;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> previousSibling = renderState.last;</span><br><span class="line">          <span class="keyword">if</span> (previousSibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">            previousSibling.sibling = renderedTail;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            workInProgress.child = renderedTail;</span><br><span class="line">          &#125;</span><br><span class="line">          renderState.last = renderedTail;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (renderState.tail !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We still have tail rows to render.</span></span><br><span class="line">        <span class="keyword">if</span> (renderState.tailExpiration === <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// Heuristic for how long we're willing to spend rendering rows</span></span><br><span class="line">          <span class="comment">// until we just give up and show what we have so far.</span></span><br><span class="line">          <span class="keyword">const</span> TAIL_EXPIRATION_TIMEOUT_MS = <span class="number">500</span>;</span><br><span class="line">          renderState.tailExpiration = now() + TAIL_EXPIRATION_TIMEOUT_MS;</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> This is meant to mimic the train model or JND but this</span></span><br><span class="line">          <span class="comment">// is a per component value. It should really be since the start</span></span><br><span class="line">          <span class="comment">// of the total render or last commit. Consider using something like</span></span><br><span class="line">          <span class="comment">// globalMostRecentFallbackTime. That doesn't account for being</span></span><br><span class="line">          <span class="comment">// suspended for part of the time or when it's a new render.</span></span><br><span class="line">          <span class="comment">// It should probably use a global start time value instead.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Pop a row.</span></span><br><span class="line">        <span class="keyword">const</span> next = renderState.tail;</span><br><span class="line">        renderState.rendering = next;</span><br><span class="line">        renderState.tail = next.sibling;</span><br><span class="line">        renderState.lastEffect = workInProgress.lastEffect;</span><br><span class="line">        renderState.renderingStartTime = now();</span><br><span class="line">        next.sibling = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Restore the context.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> We can probably just avoid popping it instead and only</span></span><br><span class="line">        <span class="comment">// setting it the first time we go from not suspended to suspended.</span></span><br><span class="line">        <span class="keyword">let</span> suspenseContext = suspenseStackCursor.current;</span><br><span class="line">        <span class="keyword">if</span> (didSuspendAlready) &#123;</span><br><span class="line">          suspenseContext = setShallowSuspenseContext(</span><br><span class="line">            suspenseContext,</span><br><span class="line">            ForceSuspenseFallback,</span><br><span class="line">          );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          suspenseContext = setDefaultShallowSuspenseContext(suspenseContext);</span><br><span class="line">        &#125;</span><br><span class="line">        pushSuspenseContext(workInProgress, suspenseContext);</span><br><span class="line">        <span class="comment">// Do a pass over the next row.</span></span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> FundamentalComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableFundamentalAPI) &#123;</span><br><span class="line">        <span class="keyword">const</span> fundamentalImpl = workInProgress.type.impl;</span><br><span class="line">        <span class="keyword">let</span> fundamentalInstance: ReactFundamentalComponentInstance&lt;</span><br><span class="line">          any,</span><br><span class="line">          any,</span><br><span class="line">        &gt; | <span class="literal">null</span> = workInProgress.stateNode;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fundamentalInstance === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> getInitialState = fundamentalImpl.getInitialState;</span><br><span class="line">          <span class="keyword">let</span> fundamentalState;</span><br><span class="line">          <span class="keyword">if</span> (getInitialState !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            fundamentalState = getInitialState(newProps);</span><br><span class="line">          &#125;</span><br><span class="line">          fundamentalInstance = workInProgress.stateNode = createFundamentalStateInstance(</span><br><span class="line">            workInProgress,</span><br><span class="line">            newProps,</span><br><span class="line">            fundamentalImpl,</span><br><span class="line">            fundamentalState || &#123;&#125;,</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">const</span> instance = ((getFundamentalComponentInstance(</span><br><span class="line">            fundamentalInstance,</span><br><span class="line">          ): any): Instance);</span><br><span class="line">          fundamentalInstance.instance = instance;</span><br><span class="line">          <span class="keyword">if</span> (fundamentalImpl.reconcileChildren === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          appendAllChildren(instance, workInProgress, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">          mountFundamentalComponent(fundamentalInstance);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// We fire update in commit phase</span></span><br><span class="line">          <span class="keyword">const</span> prevProps = fundamentalInstance.props;</span><br><span class="line">          fundamentalInstance.prevProps = prevProps;</span><br><span class="line">          fundamentalInstance.props = newProps;</span><br><span class="line">          fundamentalInstance.currentFiber = workInProgress;</span><br><span class="line">          <span class="keyword">if</span> (supportsPersistence) &#123;</span><br><span class="line">            <span class="keyword">const</span> instance = cloneFundamentalInstance(fundamentalInstance);</span><br><span class="line">            fundamentalInstance.instance = instance;</span><br><span class="line">            appendAllChildren(instance, workInProgress, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">const</span> shouldUpdate = shouldUpdateFundamentalComponent(</span><br><span class="line">            fundamentalInstance,</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">if</span> (shouldUpdate) &#123;</span><br><span class="line">            markUpdate(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ScopeComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> scopeInstance: ReactScopeInstance = createScopeInstance();</span><br><span class="line">          workInProgress.stateNode = scopeInstance;</span><br><span class="line">          <span class="keyword">if</span> (enableDeprecatedFlareAPI) &#123;</span><br><span class="line">            <span class="keyword">const</span> listeners = newProps.DEPRECATED_flareListeners;</span><br><span class="line">            <span class="keyword">if</span> (listeners != <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">const</span> rootContainerInstance = getRootHostContainer();</span><br><span class="line">              updateDeprecatedEventListeners(</span><br><span class="line">                listeners,</span><br><span class="line">                workInProgress,</span><br><span class="line">                rootContainerInstance,</span><br><span class="line">              );</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          prepareScopeUpdate(scopeInstance, workInProgress);</span><br><span class="line">          <span class="keyword">if</span> (workInProgress.ref !== <span class="literal">null</span>) &#123;</span><br><span class="line">            markRef(workInProgress);</span><br><span class="line">            markUpdate(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (enableDeprecatedFlareAPI) &#123;</span><br><span class="line">            <span class="keyword">const</span> prevListeners =</span><br><span class="line">              current.memoizedProps.DEPRECATED_flareListeners;</span><br><span class="line">            <span class="keyword">const</span> nextListeners = newProps.DEPRECATED_flareListeners;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">              prevListeners !== nextListeners ||</span><br><span class="line">              workInProgress.ref !== <span class="literal">null</span></span><br><span class="line">            ) &#123;</span><br><span class="line">              markUpdate(workInProgress);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (workInProgress.ref !== <span class="literal">null</span>) &#123;</span><br><span class="line">              markUpdate(workInProgress);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (current.ref !== workInProgress.ref) &#123;</span><br><span class="line">            markRef(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Block:</span><br><span class="line">      <span class="keyword">if</span> (enableBlocksAPI) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  invariant(</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">'Unknown unit of work tag (%s). This error is likely caused by a bug in '</span> +</span><br><span class="line">      <span class="string">'React. Please file an issue.'</span>,</span><br><span class="line">    workInProgress.tag,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="47">
<li>createInstance</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  type: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  props: Props,</span></span></span><br><span class="line"><span class="function"><span class="params">  rootContainerInstance: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  hostContext: HostContext,</span></span></span><br><span class="line"><span class="function"><span class="params">  internalInstanceHandle: Object,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Instance</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> parentNamespace: string;</span><br><span class="line">  parentNamespace = ((hostContext: any): HostContextProd);</span><br><span class="line">  <span class="keyword">const</span> domElement: Instance = createElement(</span><br><span class="line">    type,</span><br><span class="line">    props,</span><br><span class="line">    rootContainerInstance,</span><br><span class="line">    parentNamespace,</span><br><span class="line">  );</span><br><span class="line">  precacheFiberNode(internalInstanceHandle, domElement); <span class="comment">// 这是一个带有副作用的函数</span></span><br><span class="line">  updateFiberProps(domElement, props); <span class="comment">// 也是一个带有副作用的函数</span></span><br><span class="line">  <span class="keyword">return</span> domElement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="48">
<li>appendChildren</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">appendAllChildren = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  needsVisibilityToggle: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  isHidden: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// We only have the top Fiber that was created but we need recurse down its</span></span><br><span class="line">  <span class="comment">// children to find all the terminal nodes.</span></span><br><span class="line">  <span class="keyword">let</span> node = workInProgress.child;</span><br><span class="line">  <span class="keyword">while</span> (node !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.tag === HostComponent || node.tag === HostText) &#123;</span><br><span class="line">      appendInitialChild(parent, node.stateNode);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enableFundamentalAPI &amp;&amp; node.tag === FundamentalComponent) &#123;</span><br><span class="line">      appendInitialChild(parent, node.stateNode.instance);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.tag === HostPortal) &#123;</span><br><span class="line">      <span class="comment">// If we have a portal child, then we don't want to traverse</span></span><br><span class="line">      <span class="comment">// down its children. Instead, we'll get insertions from each child in</span></span><br><span class="line">      <span class="comment">// the portal directly.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      node.child.return = node;</span><br><span class="line">      node = node.child;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (node === workInProgress) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.return === <span class="literal">null</span> || node.return === workInProgress) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.return;</span><br><span class="line">    &#125;</span><br><span class="line">    node.sibling.return = node.return;</span><br><span class="line">    node = node.sibling;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="workLoopSync中的循环"><a href="#workLoopSync中的循环" class="headerlink" title="workLoopSync中的循环"></a>workLoopSync中的循环</h3><ol>
<li>container参与的过程</li>
</ol>
<p>函数调用过程：</p>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> beginWork;
  beginWork --> updateHostRoot;
  updateHostRoot --> cloneUpdateQueue;
  updateHostRoot --> processUpdateQueue;
  processUpdateQueue --> markRenderEventTimeAndConfig;
  processUpdateQueue --> getStateFromUpdate;
  updateHostRoot --> reconcileChildren;
  reconcileChildren --> reconcileChildFibers;
  reconcileChildFibers --> placeSingleChild;
  placeSingleChild --> reconcileSingleElement;
  reconcileSingleElement --> createFiberFromElement;
  createFiberFromElement --> createFiberFromTypeAndProps;
  reconcileSingleElement --> coerceRef;</pre>

<p>该过程执行结果：</p>
<p><strong>到这里拿到了最外层组件对应的Fiber对象（performUnitOfWork函数中的next），其实例为：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration:<span class="number">0</span>,</span><br><span class="line">  actualStartTime:<span class="number">-1</span>,</span><br><span class="line">  alternate: <span class="literal">null</span>,</span><br><span class="line">  child: <span class="literal">null</span>,</span><br><span class="line">  childExpirationTime: <span class="number">0</span>,</span><br><span class="line">  dependencies_old: <span class="literal">null</span>,</span><br><span class="line">  effectTag: <span class="number">2</span>,</span><br><span class="line">  elementType: <span class="built_in">Symbol</span>(react.strict_mode),</span><br><span class="line">  expirationTime: <span class="number">1073741823</span>,</span><br><span class="line">  firstEffect: <span class="literal">null</span>,</span><br><span class="line">  index: <span class="number">0</span>,</span><br><span class="line">  key: <span class="literal">null</span>,</span><br><span class="line">  lastEffect: <span class="literal">null</span>,</span><br><span class="line">  memoizedProps: <span class="literal">null</span>,</span><br><span class="line">  memoizedState: <span class="literal">null</span>,</span><br><span class="line">  mode: <span class="number">1</span>,</span><br><span class="line">  nextEffect: <span class="literal">null</span>,</span><br><span class="line">  pendingProps: &#123;</span><br><span class="line">    children: &#123;</span><br><span class="line">      $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element),</span><br><span class="line">      key: <span class="literal">null</span>,</span><br><span class="line">      props: &#123;&#125;,</span><br><span class="line">      ref: <span class="literal">null</span>,</span><br><span class="line">      type: f App(),</span><br><span class="line">      _owner: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  ref: <span class="literal">null</span>,</span><br><span class="line">  <span class="keyword">return</span>: RootFiber,</span><br><span class="line">  selfBaseDuration: <span class="number">0</span>,</span><br><span class="line">  sibling: <span class="literal">null</span>,</span><br><span class="line">  stateNode: <span class="literal">null</span>,</span><br><span class="line">  tag: <span class="number">8</span>,</span><br><span class="line">  treeBaseDuration: <span class="number">0</span>,</span><br><span class="line">  type: <span class="built_in">Symbol</span>(react.strict_mode),</span><br><span class="line">  updateQueue: <span class="literal">null</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>RootFiber：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span>,</span><br><span class="line">  actualStartTime: <span class="number">-1</span>,</span><br><span class="line">  child: <span class="literal">null</span>,</span><br><span class="line">  childExpirationTime: <span class="number">0</span>,</span><br><span class="line">  dependencies_old: <span class="literal">null</span>,</span><br><span class="line">  alternate: ,</span><br><span class="line">  effectTag: <span class="number">0</span>,</span><br><span class="line">  elementType: <span class="literal">null</span>,</span><br><span class="line">  expirationTime: <span class="number">1073741823</span>,</span><br><span class="line">  firstEffect: <span class="literal">null</span>,</span><br><span class="line">  index: <span class="number">0</span>,</span><br><span class="line">  key: <span class="literal">null</span>,</span><br><span class="line">  lastEffect: <span class="literal">null</span>,</span><br><span class="line">  memoizedProps: <span class="literal">null</span>,</span><br><span class="line">  memoizedState: <span class="literal">null</span>,</span><br><span class="line">  mode: <span class="number">0</span>,</span><br><span class="line">  nextEffect: <span class="literal">null</span>,</span><br><span class="line">  pendingProps: <span class="literal">null</span>,</span><br><span class="line">  ref: <span class="literal">null</span>,</span><br><span class="line">  <span class="keyword">return</span>: <span class="literal">null</span>,</span><br><span class="line">  selfBaseDuration: <span class="number">0</span>,</span><br><span class="line">  sibling: <span class="literal">null</span>,</span><br><span class="line">  tag: <span class="number">3</span>,</span><br><span class="line">  treeBaseDuration: <span class="number">0</span>,</span><br><span class="line">  type: <span class="literal">null</span>,</span><br><span class="line">  stateNode: FiberRoot,</span><br><span class="line">  updateQueue: &#123;</span><br><span class="line">    baseState: <span class="literal">null</span>,</span><br><span class="line">    effects: <span class="literal">null</span>,</span><br><span class="line">    shared: &#123; <span class="attr">pending</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">    firstBaseUpdate: &#123;</span><br><span class="line">      callback: <span class="literal">null</span>,</span><br><span class="line">      expirationTime: <span class="number">1073741823</span>,</span><br><span class="line">      next: <span class="literal">null</span>,</span><br><span class="line">      payload: &#123;</span><br><span class="line">        element: &#123;</span><br><span class="line">          $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element),</span><br><span class="line">          key: <span class="literal">null</span>,</span><br><span class="line">          props: &#123;</span><br><span class="line">            children: &#123;</span><br><span class="line">              $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">              key: <span class="literal">null</span></span><br><span class="line">              props: &#123;&#125;</span><br><span class="line">              ref: <span class="literal">null</span></span><br><span class="line">              type: ƒ App()</span><br><span class="line">              _owner: <span class="literal">null</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          ref: <span class="literal">null</span></span><br><span class="line">          type: <span class="built_in">Symbol</span>(react.strict_mode)</span><br><span class="line">          _owner: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      suspenseConfig: <span class="literal">null</span>,</span><br><span class="line">      tag: <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    lastBaseUpdate: &#123;</span><br><span class="line">      callback: <span class="literal">null</span>,</span><br><span class="line">      expirationTime: <span class="number">1073741823</span>,</span><br><span class="line">      next: <span class="literal">null</span>,</span><br><span class="line">      payload: &#123;</span><br><span class="line">        element: &#123;</span><br><span class="line">          $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">          key: <span class="literal">null</span></span><br><span class="line">          props: &#123;</span><br><span class="line">            children: &#123;</span><br><span class="line">              $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">              key: <span class="literal">null</span></span><br><span class="line">              props: &#123;&#125;</span><br><span class="line">              ref: <span class="literal">null</span></span><br><span class="line">              type: ƒ App()</span><br><span class="line">              _owner: <span class="literal">null</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          ref: <span class="literal">null</span></span><br><span class="line">          type: <span class="built_in">Symbol</span>(react.strict_mode)</span><br><span class="line">          _owner: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      suspenseConfig: <span class="literal">null</span>,</span><br><span class="line">      tag: <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>FiberRoot:</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  callbackNode: <span class="literal">null</span></span><br><span class="line">  callbackPriority_old: <span class="number">90</span></span><br><span class="line">  containerInfo: div#root</span><br><span class="line">  context: &#123;&#125;</span><br><span class="line">  current: RootFiber</span><br><span class="line">  finishedExpirationTime: <span class="number">0</span></span><br><span class="line">  finishedWork: <span class="literal">null</span></span><br><span class="line">  firstPendingTime: <span class="number">1073741823</span></span><br><span class="line">  firstSuspendedTime: <span class="number">0</span></span><br><span class="line">  hydrate: <span class="literal">false</span></span><br><span class="line">  interactionThreadID: <span class="number">1</span></span><br><span class="line">  lastExpiredTime: <span class="number">0</span></span><br><span class="line">  lastPendingTime: <span class="number">1073741823</span></span><br><span class="line">  lastPingedTime: <span class="number">0</span></span><br><span class="line">  lastSuspendedTime: <span class="number">0</span></span><br><span class="line">  memoizedInteractions: <span class="built_in">Set</span>(<span class="number">0</span>) &#123;&#125;</span><br><span class="line">  mutableSourceEagerHydrationData: <span class="literal">null</span></span><br><span class="line">  mutableSourceLastPendingUpdateTime: <span class="number">0</span></span><br><span class="line">  nextKnownPendingLevel: <span class="number">0</span></span><br><span class="line">  pendingChildren: <span class="literal">null</span></span><br><span class="line">  pendingContext: <span class="literal">null</span></span><br><span class="line">  pendingInteractionMap_old: <span class="built_in">Map</span>(<span class="number">0</span>) &#123;&#125;</span><br><span class="line">  pingCache: <span class="literal">null</span></span><br><span class="line">  tag: <span class="number">0</span></span><br><span class="line">  timeoutHandle: <span class="number">-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>WorkInProgress:</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: RootFiber</span><br><span class="line">  child: next</span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="literal">null</span></span><br><span class="line">  expirationTime: <span class="number">0</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: <span class="literal">null</span></span><br><span class="line">  memoizedState: &#123;</span><br><span class="line">    element: &#123;</span><br><span class="line">      $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">      key: <span class="literal">null</span></span><br><span class="line">      props: &#123;</span><br><span class="line">        children: &#123;</span><br><span class="line">          $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">          key: <span class="literal">null</span></span><br><span class="line">          props: &#123;&#125;</span><br><span class="line">          ref: <span class="literal">null</span></span><br><span class="line">          type: ƒ App()</span><br><span class="line">          _owner: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ref: <span class="literal">null</span></span><br><span class="line">      type: <span class="built_in">Symbol</span>(react.strict_mode)</span><br><span class="line">      _owner: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  mode: <span class="number">0</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: <span class="literal">null</span></span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: <span class="literal">null</span></span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: <span class="literal">null</span></span><br><span class="line">  stateNode: FiberRoot</span><br><span class="line">  tag: <span class="number">3</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="literal">null</span></span><br><span class="line">  updateQueue: &#123;</span><br><span class="line">    baseState: &#123;</span><br><span class="line">      element: &#123;</span><br><span class="line">        $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">        key: <span class="literal">null</span></span><br><span class="line">        props: &#123;</span><br><span class="line">          children: &#123;</span><br><span class="line">            $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">            key: <span class="literal">null</span></span><br><span class="line">            props: &#123;&#125;</span><br><span class="line">            ref: <span class="literal">null</span></span><br><span class="line">            type: ƒ App()</span><br><span class="line">            _owner: <span class="literal">null</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ref: <span class="literal">null</span></span><br><span class="line">        type: <span class="built_in">Symbol</span>(react.strict_mode)</span><br><span class="line">        _owner: <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    effects: <span class="literal">null</span></span><br><span class="line">    firstBaseUpdate: <span class="literal">null</span></span><br><span class="line">    lastBaseUpdate: <span class="literal">null</span></span><br><span class="line">    shared: &#123;<span class="attr">pending</span>: <span class="literal">null</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>&lt;React.StrictMode&gt;
 &lt;App /&gt;
&lt;/React.StrictMode&gt;</code>参与的循环过程</li>
</ol>
<p>函数调用过程：</p>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> beginWork;
  beginWork --> updateMode;
  updateMode --> reconcileChildren;
  reconcileChildren --> mountChildFibers;
  mountChildFibers --> placeSingleChild;
  placeSingleChild --> reconcileSingleElement;
  reconcileSingleElement --> createFiberFromElement;
  createFiberFromElement --> createFiberFromTypeAndProps;
  reconcileSingleElement --> coerceRef;</pre>

<p>进行到<code>updateMode --&gt; reconcileChildren</code>这一步的时候，当前的workInProgress(next)的child为null，但pendingProps.children中携带了子元素，用于child的构建（感觉pendingProps这个属性使用来存储后续更新用的）</p>
<p>mountChildFibers该函数同reconcileChildFibers，只不过其中的<code>shouldTrackSideEffects = false</code></p>
<p><code>$$typeof</code>用于在诸如<code>reconcileChildFibers</code>函数中进行分支判断</p>
<p>本次循环得到的结果：</p>
<p><strong>下一层的Fiber，next的值：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: <span class="literal">null</span></span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: ƒ App()</span><br><span class="line">  expirationTime: <span class="number">1073741823</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: <span class="literal">null</span></span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: &#123;&#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: 本次的workInProgress</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: <span class="literal">null</span></span><br><span class="line">  stateNode: <span class="literal">null</span></span><br><span class="line">  tag: <span class="number">2</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: ƒ App()</span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>本次workInProgress:</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: 本次的next</span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">2</span></span><br><span class="line">  elementType: <span class="built_in">Symbol</span>(react.strict_mode)</span><br><span class="line">  expirationTime: <span class="number">0</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: &#123;</span><br><span class="line">    children: &#123;</span><br><span class="line">      $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">      key: <span class="literal">null</span></span><br><span class="line">      props: &#123;&#125;</span><br><span class="line">      ref: <span class="literal">null</span></span><br><span class="line">      type: ƒ App()</span><br><span class="line">      _owner: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: &#123;</span><br><span class="line">    children: &#123;</span><br><span class="line">      $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">      key: <span class="literal">null</span></span><br><span class="line">      props: &#123;&#125;</span><br><span class="line">      ref: <span class="literal">null</span></span><br><span class="line">      type: ƒ App()</span><br><span class="line">      _owner: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: RootFiber对应的workInProgress（container循环那层形成的workInProgress）</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: <span class="literal">null</span></span><br><span class="line">  stateNode: <span class="literal">null</span></span><br><span class="line">  tag: <span class="number">8</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="built_in">Symbol</span>(react.strict_mode)</span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个迭代过程中使用了全局变量workInProgress，当前的workInProgress会作为新建的fiber的return属性的值引用存在。</p>
<p>在迭代过程中只产生了组件对应的Fiber，并没有创建其对应的alternate</p>
<p>每次处理前的WorkInProgress的expirationTime都是1073741823，在开始处理时，设置为0，取消了priority。</p>
<p>自定义组件会生成一个对应的Fiber</p>
<ol start="3">
<li>App函数的处理过程</li>
</ol>
<p>函数调用过程：</p>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> beginWork;
  beginWork --> mountIndeterminateComponent;
  mountIndeterminateComponent --> getUnmaskedContext;
  mountIndeterminateComponent --> getMaskedContext;
  mountIndeterminateComponent --> renderWithHooks;
  mountIndeterminateComponent --> reconcileChildren;
  reconcileChildren --> mountChildFibers;
  mountChildFibers --> placeSingleChild;
  placeSingleChild --> reconcileSingleElement;
  reconcileSingleElement --> createFiberFromElement;
  createFiberFromElement --> createFiberFromTypeAndProps;
  reconcileSingleElement --> coerceRef;</pre>

<p>在组件转换为ReactElement的过程中，好像是从内层像外层进行转换：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;header className=<span class="string">"App-header"</span>&gt;</span><br><span class="line">        &lt;img src=&#123;logo&#125; className=<span class="string">"App-logo"</span> alt=<span class="string">"logo"</span> /&gt;</span><br><span class="line">        &lt;p&gt;</span><br><span class="line">          Edit &lt;code&gt;src/App.js&lt;<span class="regexp">/code&gt; and save to reload.</span></span><br><span class="line"><span class="regexp">        &lt;/</span>p&gt;</span><br><span class="line">        &lt;a</span><br><span class="line">          className=<span class="string">"App-link"</span></span><br><span class="line">          href=<span class="string">"https://reactjs.org"</span></span><br><span class="line">          target=<span class="string">"_blank"</span></span><br><span class="line">          rel=<span class="string">"noopener noreferrer"</span></span><br><span class="line">        &gt;</span><br><span class="line">          test</span><br><span class="line">        &lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>header&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>转换完的结果为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  props: &#123;</span><br><span class="line">    children: &#123;</span><br><span class="line">      $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">      key: <span class="literal">null</span></span><br><span class="line">      props: &#123;</span><br><span class="line">        className: <span class="string">"App-header"</span>,</span><br><span class="line">        children: [</span><br><span class="line">          &#123;</span><br><span class="line">            $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">            key: <span class="literal">null</span></span><br><span class="line">            props: &#123;<span class="attr">src</span>: <span class="string">"/static/media/logo.5d5d9eef.svg"</span>, <span class="attr">className</span>: <span class="string">"App-logo"</span>, <span class="attr">alt</span>: <span class="string">"logo"</span>&#125;</span><br><span class="line">            ref: <span class="literal">null</span></span><br><span class="line">            type: <span class="string">"img"</span></span><br><span class="line">            _owner: <span class="literal">null</span></span><br><span class="line">          &#125;, &#123;</span><br><span class="line">            $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">            key: <span class="literal">null</span></span><br><span class="line">            props: &#123;</span><br><span class="line">              children: [</span><br><span class="line">                <span class="string">"Edit "</span>,</span><br><span class="line">                &#123;</span><br><span class="line">                  $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element),</span><br><span class="line">                  type: <span class="string">"code"</span>,</span><br><span class="line">                  key: <span class="literal">null</span>,</span><br><span class="line">                  ref: <span class="literal">null</span>,</span><br><span class="line">                  _owner: <span class="literal">null</span>,</span><br><span class="line">                  props: &#123;<span class="attr">children</span>: <span class="string">"src/App.js"</span>&#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">" and save to reload."</span></span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">            ref: <span class="literal">null</span></span><br><span class="line">            type: <span class="string">"p"</span></span><br><span class="line">          &#125;, &#123;</span><br><span class="line">            $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">            key: <span class="literal">null</span></span><br><span class="line">            props: &#123;</span><br><span class="line">              className: <span class="string">"App-link"</span>, <span class="attr">href</span>: <span class="string">"https://reactjs.org"</span>, <span class="attr">target</span>: <span class="string">"_blank"</span>, <span class="attr">rel</span>: <span class="string">"noopener noreferrer"</span>, <span class="attr">children</span>: <span class="string">"test"</span></span><br><span class="line">            &#125;</span><br><span class="line">            ref: <span class="literal">null</span></span><br><span class="line">            type: <span class="string">"a"</span></span><br><span class="line">            _owner: <span class="literal">null</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">      ref: <span class="literal">null</span></span><br><span class="line">      type: <span class="string">"header"</span></span><br><span class="line">      _owner: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    className: <span class="string">"App"</span></span><br><span class="line">  &#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  type: <span class="string">"div"</span></span><br><span class="line">  _owner: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mountIndeterminateComponent函数中进一步区分是函数组件还是类组件</p>
<p>本次循环得到的结果:</p>
<p><strong>下一层的Fiber</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: <span class="literal">null</span></span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="string">"div"</span></span><br><span class="line">  expirationTime: <span class="number">1073741823</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: <span class="literal">null</span></span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: 上面解析后的reactElement</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: 本次的workInProgress</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: <span class="literal">null</span></span><br><span class="line">  stateNode: <span class="literal">null</span></span><br><span class="line">  tag: <span class="number">5</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="string">"div"</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>本次workInProgress:</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: 上面新生成的Fiber</span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">1</span></span><br><span class="line">  elementType: ƒ App()</span><br><span class="line">  expirationTime: <span class="number">0</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: &#123;&#125;</span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: &#123;&#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: 上上面的workInProgress</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: <span class="literal">null</span></span><br><span class="line">  stateNode: <span class="literal">null</span></span><br><span class="line">  tag: <span class="number">0</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: ƒ App()</span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><code>&lt;div className=&quot;App&quot;&gt;</code>参与的循环过程</li>
</ol>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> beginWork;
  beginWork --> updateHostComponent;
  updateHostComponent --> reconcileChildren;
  reconcileChildren --> mountChildFibers;
  mountChildFibers --> placeSingleChild;
  placeSingleChild --> reconcileSingleElement;
  reconcileSingleElement --> createFiberFromElement;
  createFiberFromElement --> createFiberFromTypeAndProps;
  reconcileSingleElement --> coerceRef;</pre>

<p>本次循环得到的结果：</p>
<p><strong>下一层的Fiber：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">   actualStartTime: <span class="number">-1</span></span><br><span class="line">   alternate: <span class="literal">null</span></span><br><span class="line">   child: <span class="literal">null</span></span><br><span class="line">   childExpirationTime: <span class="number">0</span></span><br><span class="line">   dependencies_old: <span class="literal">null</span></span><br><span class="line">   effectTag: <span class="number">0</span></span><br><span class="line">   elementType: <span class="string">"header"</span></span><br><span class="line">   expirationTime: <span class="number">1073741823</span></span><br><span class="line">   firstEffect: <span class="literal">null</span></span><br><span class="line">   index: <span class="number">0</span></span><br><span class="line">   key: <span class="literal">null</span></span><br><span class="line">   lastEffect: <span class="literal">null</span></span><br><span class="line">   memoizedProps: <span class="literal">null</span></span><br><span class="line">   memoizedState: <span class="literal">null</span></span><br><span class="line">   mode: <span class="number">1</span></span><br><span class="line">   nextEffect: <span class="literal">null</span></span><br><span class="line">   pendingProps: 上面ReactElement下面一层</span><br><span class="line">   ref: <span class="literal">null</span></span><br><span class="line">   <span class="keyword">return</span>: 上面的workInProgress</span><br><span class="line">   selfBaseDuration: <span class="number">0</span></span><br><span class="line">   sibling: <span class="literal">null</span></span><br><span class="line">   stateNode: <span class="literal">null</span></span><br><span class="line">   tag: <span class="number">5</span></span><br><span class="line">   treeBaseDuration: <span class="number">0</span></span><br><span class="line">   type: <span class="string">"header"</span></span><br><span class="line">   updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>本次的workInProgress</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   actualDuration: <span class="number">0</span></span><br><span class="line">   actualStartTime: <span class="number">-1</span></span><br><span class="line">   alternate: <span class="literal">null</span></span><br><span class="line">   child: 上面的Fiber</span><br><span class="line">   childExpirationTime: <span class="number">0</span></span><br><span class="line">   dependencies_old: <span class="literal">null</span></span><br><span class="line">   effectTag: <span class="number">0</span></span><br><span class="line">   elementType: <span class="string">"div"</span></span><br><span class="line">   expirationTime: <span class="number">0</span></span><br><span class="line">   firstEffect: <span class="literal">null</span></span><br><span class="line">   index: <span class="number">0</span></span><br><span class="line">   key: <span class="literal">null</span></span><br><span class="line">   lastEffect: <span class="literal">null</span></span><br><span class="line">   memoizedProps: &#123;</span><br><span class="line">     className: <span class="string">"App"</span>,</span><br><span class="line">     children: &#123;</span><br><span class="line">       $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">       key: <span class="literal">null</span></span><br><span class="line">       props: &#123;<span class="attr">className</span>: <span class="string">"App-header"</span>, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">3</span>)&#125;</span><br><span class="line">       ref: <span class="literal">null</span></span><br><span class="line">       type: <span class="string">"header"</span></span><br><span class="line">       _owner: <span class="literal">null</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   memoizedState: <span class="literal">null</span></span><br><span class="line">   mode: <span class="number">1</span></span><br><span class="line">   nextEffect: <span class="literal">null</span></span><br><span class="line">   pendingProps: &#123;</span><br><span class="line">     className: <span class="string">"App"</span>,</span><br><span class="line">     children: &#123;</span><br><span class="line">       $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">       key: <span class="literal">null</span></span><br><span class="line">       props: &#123;<span class="attr">className</span>: <span class="string">"App-header"</span>, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">3</span>)&#125;</span><br><span class="line">       ref: <span class="literal">null</span></span><br><span class="line">       type: <span class="string">"header"</span></span><br><span class="line">       _owner: <span class="literal">null</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   ref: <span class="literal">null</span></span><br><span class="line">   <span class="keyword">return</span>: FiberNode &#123;<span class="attr">tag</span>: <span class="number">0</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: ƒ, <span class="attr">type</span>: ƒ, …&#125;</span><br><span class="line">   selfBaseDuration: <span class="number">0</span></span><br><span class="line">   sibling: <span class="literal">null</span></span><br><span class="line">   stateNode: <span class="literal">null</span></span><br><span class="line">   tag: <span class="number">5</span></span><br><span class="line">   treeBaseDuration: <span class="number">0</span></span><br><span class="line">   type: <span class="string">"div"</span></span><br><span class="line">   updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><code>&lt;header className=&quot;App-header&quot;&gt;</code>参与的循环过程</li>
</ol>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> beginWork;
  beginWork --> updateHostComponent;
  updateHostComponent --> reconcileChildren;
  reconcileChildren --> mountChildFibers;
  mountChildFibers --> reconcileChildrenArray;
  reconcileChildrenArray --> createChild;
  reconcileChildrenArray --> placeChild;</pre>

<p>第一次是处理<code>&lt;img /&gt;</code>标签，后续函数调用为：</p>
<pre class="mermaid" style="background: none">  graph TD;

  createChild --> createFiberFromElement;
  createFiberFromElement --> createFiberFromTypeAndProps;
  reconcileSingleElement --> coerceRef;</pre>

<p><code>&lt;img /&gt;</code>标签对应的fiber对象：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">   actualStartTime: <span class="number">-1</span></span><br><span class="line">   alternate: <span class="literal">null</span></span><br><span class="line">   child: <span class="literal">null</span></span><br><span class="line">   childExpirationTime: <span class="number">0</span></span><br><span class="line">   dependencies_old: <span class="literal">null</span></span><br><span class="line">   effectTag: <span class="number">0</span></span><br><span class="line">   elementType: <span class="string">"img"</span></span><br><span class="line">   expirationTime: <span class="number">1073741823</span></span><br><span class="line">   firstEffect: <span class="literal">null</span></span><br><span class="line">   index: <span class="number">0</span></span><br><span class="line">   key: <span class="literal">null</span></span><br><span class="line">   lastEffect: <span class="literal">null</span></span><br><span class="line">   memoizedProps: <span class="literal">null</span></span><br><span class="line">   memoizedState: <span class="literal">null</span></span><br><span class="line">   mode: <span class="number">1</span></span><br><span class="line">   nextEffect: <span class="literal">null</span></span><br><span class="line">   pendingProps: &#123;<span class="attr">src</span>: <span class="string">"/static/media/logo.5d5d9eef.svg"</span>, <span class="attr">className</span>: <span class="string">"App-logo"</span>, <span class="attr">alt</span>: <span class="string">"logo"</span>&#125;</span><br><span class="line">   ref: <span class="literal">null</span></span><br><span class="line">   <span class="keyword">return</span>: 上面的workInProgress</span><br><span class="line">   selfBaseDuration: <span class="number">0</span></span><br><span class="line">   sibling: 下一个Fiber</span><br><span class="line">   stateNode: <span class="literal">null</span></span><br><span class="line">   tag: <span class="number">5</span></span><br><span class="line">   treeBaseDuration: <span class="number">0</span></span><br><span class="line">   type: <span class="string">"img"</span></span><br><span class="line">   updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在处理这个fiber的时候，用到了index属性</p>
<p>第二次处理<code>p</code>标签，</p>
<p>本次生成的Fiber:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: <span class="literal">null</span></span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="string">"p"</span></span><br><span class="line">  expirationTime: <span class="number">1073741823</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: <span class="literal">null</span></span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: &#123;</span><br><span class="line">    children: &#123;</span><br><span class="line">      <span class="string">"Edit "</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">        key: <span class="literal">null</span></span><br><span class="line">        props: &#123;<span class="attr">children</span>: <span class="string">"src/App.js"</span>&#125;</span><br><span class="line">        ref: <span class="literal">null</span></span><br><span class="line">        type: <span class="string">"code"</span></span><br><span class="line">        _owner: <span class="literal">null</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">" and save to reload."</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: 上一个workInProgerss</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: 下面的Fiber实例</span><br><span class="line">  stateNode: <span class="literal">null</span></span><br><span class="line">  tag: <span class="number">5</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="string">"p"</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本次执行完毕，上一次生成的Fiber的sibling设为本次的P标签对应的Fiber</p>
<p>第三次处理<code>a</code>标签</p>
<p>本次生成的Fiber：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: <span class="literal">null</span></span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="string">"a"</span></span><br><span class="line">  expirationTime: <span class="number">1073741823</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: <span class="literal">null</span></span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: &#123;</span><br><span class="line">    children: <span class="string">"test"</span></span><br><span class="line">    className: <span class="string">"App-link"</span></span><br><span class="line">    href: <span class="string">"https://reactjs.org"</span></span><br><span class="line">    rel: <span class="string">"noopener noreferrer"</span></span><br><span class="line">    target: <span class="string">"_blank"</span></span><br><span class="line">  &#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: 上次的workInProgress</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: <span class="literal">null</span></span><br><span class="line">  stateNode: <span class="literal">null</span></span><br><span class="line">  tag: <span class="number">5</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="string">"a"</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本次循环执行完成上面的<code>p</code>标签对应的sibling指向了本次生成的Fiber实例</p>
<p>至此，本次的workInProgress的循环结束，此时workInProgress为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: 上面img标签对应的Fiber</span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="string">"header"</span></span><br><span class="line">  expirationTime: <span class="number">0</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: &#123;<span class="attr">className</span>: <span class="string">"App-header"</span>, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">3</span>)&#125;</span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: &#123;<span class="attr">className</span>: <span class="string">"App-header"</span>, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">3</span>)&#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: 外面一层div对应的Fiber</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: <span class="literal">null</span></span><br><span class="line">  stateNode: <span class="literal">null</span></span><br><span class="line">  tag: <span class="number">5</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="string">"header"</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li><code>img</code>标签对应的Fiber作为workInProgress参与循环</li>
</ol>
<p>本次循环的特殊之处在于循环至此第一次出现child为undefined的情况，进入performUnitOfWork中调用completeUnitOfWork函数的分支</p>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> beginWork;
  beginWork --> updateHostComponent;
  updateHostComponent --> reconcileChildren;
  reconcileChildren --> mountChildFibers;
  mountChildFibers --> deleteRemainingChildren;
  performUnitOfWork --> completeUnitOfWork;
  completeUnitOfWork --> completeWork;
  completeWork --> createInstance;
  completeWork --> appendAllChildren;</pre>

<p>本次的workInProgress:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: <span class="literal">null</span></span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="string">"img"</span></span><br><span class="line">  expirationTime: <span class="number">0</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: &#123;<span class="attr">src</span>: <span class="string">"/static/media/logo.5d5d9eef.svg"</span>, <span class="attr">className</span>: <span class="string">"App-logo"</span>, <span class="attr">alt</span>: <span class="string">"logo"</span>&#125;</span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: &#123;<span class="attr">src</span>: <span class="string">"/static/media/logo.5d5d9eef.svg"</span>, <span class="attr">className</span>: <span class="string">"App-logo"</span>, <span class="attr">alt</span>: <span class="string">"logo"</span>&#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: header对应的Fiber</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: P标签对应的Fiber</span><br><span class="line">  stateNode: <span class="literal">null</span> <span class="comment">// 注意此处的stateNode为null</span></span><br><span class="line">  tag: <span class="number">5</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="string">"img"</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>img</code>标签在completeWork函数中，感觉最大的效果是给其对应的Fiber的stateNode添加了指向，同时创建了<code>img</code>标签的dom元素，但并未赋值属性</p>
<p>在<code>completeUnitOfWork</code>函数的最后，将<code>img</code>标签对应的Fiber对象的sibling赋值给了workInProgress</p>
<ol start="7">
<li><code>img</code>标签的sibling<code>p</code>标签参与的本次循环</li>
</ol>
<p>本次的workInProgress:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">actualDuration: <span class="number">0</span></span><br><span class="line">actualStartTime: <span class="number">-1</span></span><br><span class="line">alternate: <span class="literal">null</span></span><br><span class="line">child: <span class="literal">null</span></span><br><span class="line">childExpirationTime: <span class="number">0</span></span><br><span class="line">dependencies_old: <span class="literal">null</span></span><br><span class="line">effectTag: <span class="number">0</span></span><br><span class="line">elementType: <span class="string">"p"</span></span><br><span class="line">expirationTime: <span class="number">0</span></span><br><span class="line">firstEffect: <span class="literal">null</span></span><br><span class="line">index: <span class="number">1</span></span><br><span class="line">key: <span class="literal">null</span></span><br><span class="line">lastEffect: <span class="literal">null</span></span><br><span class="line">memoizedProps: <span class="literal">null</span></span><br><span class="line">memoizedState: <span class="literal">null</span></span><br><span class="line">mode: <span class="number">1</span></span><br><span class="line">nextEffect: <span class="literal">null</span></span><br><span class="line">pendingProps: &#123;<span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">3</span>)&#125;</span><br><span class="line">ref: <span class="literal">null</span></span><br><span class="line"><span class="keyword">return</span>: FiberNode &#123;<span class="attr">tag</span>: <span class="number">5</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="string">"header"</span>, <span class="attr">type</span>: <span class="string">"header"</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, …&#125;</span><br><span class="line">selfBaseDuration: <span class="number">0</span></span><br><span class="line">sibling: FiberNode &#123;<span class="attr">tag</span>: <span class="number">5</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="string">"a"</span>, <span class="attr">type</span>: <span class="string">"a"</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, …&#125;</span><br><span class="line">stateNode: <span class="literal">null</span></span><br><span class="line">tag: <span class="number">5</span></span><br><span class="line">treeBaseDuration: <span class="number">0</span></span><br><span class="line">type: <span class="string">"p"</span></span><br><span class="line">updateQueue: <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> beginWork;
  beginWork --> updateHostComponent;
  updateHostComponent --> reconcileChildren;
  reconcileChildren --> mountChildFibers;
  mountChildFibers --> reconcileChildrenArray;
  reconcileChildrenArray --> createChild;
  reconcileChildrenArray --> placeChild;</pre>

<p>第一次是处理字符串<code>&quot;Edit &quot;</code>，后续函数调用为：</p>
<pre class="mermaid" style="background: none">  graph TD;

  createChild --> createFiberFromText;
  createFiberFromText --> createFiber;</pre>

<p>生成的Fiber为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: <span class="literal">null</span></span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="literal">null</span></span><br><span class="line">  expirationTime: <span class="number">1073741823</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: <span class="literal">null</span></span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: <span class="string">"Edit "</span></span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: 上面的workInProgress</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: 下面的Fiber</span><br><span class="line">  stateNode: <span class="literal">null</span></span><br><span class="line">  tag: <span class="number">6</span> <span class="comment">// 该Fiber的tag为6</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="literal">null</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二次处理<code>&lt;code&gt;src/App.js&lt;/code&gt;</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  props: &#123;<span class="attr">children</span>: <span class="string">"src/App.js"</span>&#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  type: <span class="string">"code"</span></span><br><span class="line">  _owner: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre class="mermaid" style="background: none">  graph TD;

  createChild --> createFiberFromElement;
  createFiberFromText --> createFiber;</pre>

<p>生成的Fiber为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: <span class="literal">null</span></span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="string">"code"</span></span><br><span class="line">  expirationTime: <span class="number">1073741823</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: <span class="literal">null</span></span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: &#123;<span class="attr">children</span>: <span class="string">"src/App.js"</span>&#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: 上面的workInProgress</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: 指向下面的Fiber</span><br><span class="line">  stateNode: <span class="literal">null</span></span><br><span class="line">  tag: <span class="number">5</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="string">"code"</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三次处理字符串<code>&quot; and save to reload&quot;</code></p>
<pre class="mermaid" style="background: none">  graph TD;

  createChild --> createFiberFromElement;
  createFiberFromText --> createFiber;</pre>

<p>生成的Fiber：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">actualDuration: <span class="number">0</span></span><br><span class="line">actualStartTime: <span class="number">-1</span></span><br><span class="line">alternate: <span class="literal">null</span></span><br><span class="line">child: <span class="literal">null</span></span><br><span class="line">childExpirationTime: <span class="number">0</span></span><br><span class="line">dependencies_old: <span class="literal">null</span></span><br><span class="line">effectTag: <span class="number">0</span></span><br><span class="line">elementType: <span class="literal">null</span></span><br><span class="line">expirationTime: <span class="number">1073741823</span></span><br><span class="line">firstEffect: <span class="literal">null</span></span><br><span class="line">index: <span class="number">0</span></span><br><span class="line">key: <span class="literal">null</span></span><br><span class="line">lastEffect: <span class="literal">null</span></span><br><span class="line">memoizedProps: <span class="literal">null</span></span><br><span class="line">memoizedState: <span class="literal">null</span></span><br><span class="line">mode: <span class="number">1</span></span><br><span class="line">nextEffect: <span class="literal">null</span></span><br><span class="line">pendingProps: <span class="string">" and save to reload."</span></span><br><span class="line">ref: <span class="literal">null</span></span><br><span class="line"><span class="keyword">return</span>: 上面的workInProgress</span><br><span class="line">selfBaseDuration: <span class="number">0</span></span><br><span class="line">sibling: <span class="literal">null</span></span><br><span class="line">stateNode: <span class="literal">null</span></span><br><span class="line">tag: <span class="number">6</span></span><br><span class="line">treeBaseDuration: <span class="number">0</span></span><br><span class="line">type: <span class="literal">null</span></span><br><span class="line">updateQueue: <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p>文本对应的Fiber，其type为null</p>
<p>本次循环过程中使用的workInProgress：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: FiberNode &#123;<span class="attr">tag</span>: <span class="number">6</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="literal">null</span>, <span class="attr">type</span>: <span class="literal">null</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, …&#125;</span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="string">"p"</span></span><br><span class="line">  expirationTime: <span class="number">0</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">1</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: &#123;<span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">3</span>)&#125;</span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: &#123;<span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">3</span>)&#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: FiberNode &#123;<span class="attr">tag</span>: <span class="number">5</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="string">"header"</span>, <span class="attr">type</span>: <span class="string">"header"</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, …&#125;</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: FiberNode &#123;<span class="attr">tag</span>: <span class="number">5</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="string">"a"</span>, <span class="attr">type</span>: <span class="string">"a"</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, …&#125;</span><br><span class="line">  stateNode: <span class="literal">null</span></span><br><span class="line">  tag: <span class="number">5</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="string">"p"</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>上面生成的字符串<code>&quot;Edit &quot;</code>的循环</li>
</ol>
<p>本次循环的workInProgress：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: <span class="literal">null</span></span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="literal">null</span></span><br><span class="line">  expirationTime: <span class="number">1073741823</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">0</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: <span class="literal">null</span></span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: <span class="string">"Edit "</span></span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: FiberNode &#123;<span class="attr">tag</span>: <span class="number">5</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="string">"p"</span>, <span class="attr">type</span>: <span class="string">"p"</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, …&#125;</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: FiberNode &#123;<span class="attr">tag</span>: <span class="number">5</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="string">"code"</span>, <span class="attr">type</span>: <span class="string">"code"</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, …&#125;</span><br><span class="line">  stateNode: TextNode</span><br><span class="line">  tag: <span class="number">6</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="literal">null</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> beginWork;
  beginWork --> updateHostText;
  performUnitOfWork --> completeUnitOfWork;
  completeUnitOfWork --> completeWork;
  completeWork --> createTextInstance;</pre>

<p>将sibling赋值给workInProgress的过程是在completeUnitOfWork函数中完成的</p>
<ol start="9">
<li>上面<code>&quot;Edit &quot;</code>字符串对应的Fiber的sibling的循环</li>
</ol>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> beginWork;
  beginWork --> updateHostComponent;
  updateHostComponent --> reconcileChildren;</pre>

<ol start="10">
<li><code>&quot; and save to reload&quot;</code>的Fiber的循环</li>
</ol>
<p>本次参与循环的workInProgress</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: <span class="literal">null</span></span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="literal">null</span></span><br><span class="line">  expirationTime: <span class="number">0</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">2</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: <span class="string">" and save to reload."</span></span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: <span class="string">" and save to reload."</span></span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: FiberNode &#123;<span class="attr">tag</span>: <span class="number">5</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="string">"p"</span>, <span class="attr">type</span>: <span class="string">"p"</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, …&#125;</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: <span class="literal">null</span></span><br><span class="line">  stateNode: 下面创建的TextNode</span><br><span class="line">  tag: <span class="number">6</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="literal">null</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> completeUnitOfWork;
  completeUnitOfWork --> completeWork;
  completeWork --> createTextInstance;</pre>

<p>在上面createTextInstance结束的时候会创建一个TextNode</p>
<ol start="11">
<li>包含上面三个元素的<code>p</code>标签参与本次的循环</li>
</ol>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> completeUnitOfWork;
  completeUnitOfWork --> completeWork;
  completeWork --> createInstance;
  createInstance --> createElement;</pre>

<p>在<code>createElement函数</code>结束的时候会创建一个P标签对应的dom元素</p>
<p>参与本次循环的workInProgress:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: FiberNode &#123;<span class="attr">tag</span>: <span class="number">6</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="literal">null</span>, <span class="attr">type</span>: <span class="literal">null</span>, <span class="attr">stateNode</span>: text, …&#125;</span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="string">"p"</span></span><br><span class="line">  expirationTime: <span class="number">0</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">1</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: &#123;<span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">3</span>)&#125;</span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps:</span><br><span class="line">  children: (<span class="number">3</span>) [<span class="string">"Edit "</span>, &#123;…&#125;, <span class="string">" and save to reload."</span>]</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: FiberNode &#123;<span class="attr">tag</span>: <span class="number">5</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="string">"header"</span>, <span class="attr">type</span>: <span class="string">"header"</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, …&#125;</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: FiberNode &#123;<span class="attr">tag</span>: <span class="number">5</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="string">"a"</span>, <span class="attr">type</span>: <span class="string">"a"</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, …&#125;</span><br><span class="line">  stateNode: p</span><br><span class="line">  tag: <span class="number">5</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="string">"p"</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TODO: 这里要捋一下sibling和return的代码细节</p>
<ol start="12">
<li><code>a</code>标签参与的循环</li>
</ol>
<p>本次循环的workInProgress：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualDuration: <span class="number">0</span></span><br><span class="line">  actualStartTime: <span class="number">-1</span></span><br><span class="line">  alternate: <span class="literal">null</span></span><br><span class="line">  child: <span class="literal">null</span></span><br><span class="line">  childExpirationTime: <span class="number">0</span></span><br><span class="line">  dependencies_old: <span class="literal">null</span></span><br><span class="line">  effectTag: <span class="number">0</span></span><br><span class="line">  elementType: <span class="string">"a"</span></span><br><span class="line">  expirationTime: <span class="number">1073741823</span></span><br><span class="line">  firstEffect: <span class="literal">null</span></span><br><span class="line">  index: <span class="number">2</span></span><br><span class="line">  key: <span class="literal">null</span></span><br><span class="line">  lastEffect: <span class="literal">null</span></span><br><span class="line">  memoizedProps: &#123;<span class="attr">className</span>: <span class="string">"App-link"</span>, <span class="attr">href</span>: <span class="string">"https://reactjs.org"</span>, <span class="attr">target</span>: <span class="string">"_blank"</span>, <span class="attr">rel</span>: <span class="string">"noopener noreferrer"</span>, <span class="attr">children</span>: <span class="string">"test"</span>&#125;</span><br><span class="line">  memoizedState: <span class="literal">null</span></span><br><span class="line">  mode: <span class="number">1</span></span><br><span class="line">  nextEffect: <span class="literal">null</span></span><br><span class="line">  pendingProps: &#123;<span class="attr">className</span>: <span class="string">"App-link"</span>, <span class="attr">href</span>: <span class="string">"https://reactjs.org"</span>, <span class="attr">target</span>: <span class="string">"_blank"</span>, <span class="attr">rel</span>: <span class="string">"noopener noreferrer"</span>, <span class="attr">children</span>: <span class="string">"test"</span>&#125;</span><br><span class="line">  ref: <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span>: FiberNode &#123;<span class="attr">tag</span>: <span class="number">5</span>, <span class="attr">key</span>: <span class="literal">null</span>, <span class="attr">elementType</span>: <span class="string">"header"</span>, <span class="attr">type</span>: <span class="string">"header"</span>, <span class="attr">stateNode</span>: <span class="literal">null</span>, …&#125;</span><br><span class="line">  selfBaseDuration: <span class="number">0</span></span><br><span class="line">  sibling: <span class="literal">null</span></span><br><span class="line">  stateNode: a标签节点</span><br><span class="line">  tag: <span class="number">5</span></span><br><span class="line">  treeBaseDuration: <span class="number">0</span></span><br><span class="line">  type: <span class="string">"a"</span></span><br><span class="line">  updateQueue: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre class="mermaid" style="background: none">  graph TD;

  workLoopSync --> performUnitOfWork;
  performUnitOfWork --> completeUnitOfWork;
  completeUnitOfWork --> completeWork;
  completeWork --> createInstance;
  createInstance --> createElement;</pre>


<hr>
<p>后续在<code>completeUnitOfWork</code>函数中不断循环(通过returnFiber)，逐渐从内循环到外层组件</p>
<p>在完成上面的创建更新的过程之后，执行控制回到<code>performSyncWorkOnRoot</code>函数中，进入commitRoot函数（位于react-reconciler/src/ReactFiberWorkLoop.old的 1056行，可在此处加断点获取此时的root值）</p>
<p>提交root的过程在下一篇继续</p>

    </div>

    <div>全文完。</div>
  </article>
  <div class="toc-container">
    
  <div id="toc" class="toc-article">
    <strong class="toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#主要函数"><span class="toc-text">主要函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#workLoopSync中的循环"><span class="toc-text">workLoopSync中的循环</span></a></li></ol>
  </div>


  </div>
</div>
<div class="copyright">
    <span>本作品采用</span>
    <a href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>
    <span>进行许可。 转载时请注明原文链接。</span>
</div>
<!-- <div class="share" style="width: 100%;">
  <img src="https://kevinofneu-blog-static.oss-cn-beijing.aliyuncs.com/static/2018-12-10-qrcode_for_gh_ffacf5722095_258.jpg" alt="Running Geek" style="margin: auto; display: block;"/>

  <div style="margin: auto; text-align: center; font-size: 0.8em; color: grey;">老铁们关注走一走，不迷路</div>
  
</div> -->

  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>〈 </span>
          <a href="/2020/07/12/react源码学习之首次渲染的更新过程/" rel="next" title="react源码学习之首次渲染创建更新的过程">
          react源码学习之首次渲染创建更新的过程
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
      </div>
    </div>
  

<div id="vcomments" class="vcomments"></div>
<script>
  new Valine({
    el: '#vcomments' ,
    appId: 'Fe5TNm20tHsqA6hpF5LHADO3-gzGzoHsz',
    appKey: 'nHYuy325r0l9GBVGIm2iCr0y',
    notify:true, 
    // verify:false, 
    avatar:'mp', 
    placeholder: '耶嘿康忙北鼻~'
  })
</script>

    </div>

    
    <div class="goodle-ads-below-container">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- below -->
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6846579683645896" data-ad-slot="7362272783" data-ad-format="auto" data-full-width-responsive="true"></ins>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>
    </div>
  </div>
  <footer class="footer text-center">
    <div id="bottom-inner">
        <!-- <a class="bottom-item" href="">首页</a> |
        <a class="bottom-item" href="" target="_blank">主站</a> | -->
        <!-- <a class="bottom-item" href="" target="_blank">GitHub</a> | -->
        <a class="bottom-item" href="https://hexo.io" target="_blank">Powered by hexo</a> |
        <a class="bottom-item" href="https://github.com/KevinOfNeu/hexo-theme-xoxo" target="_blank">Theme xoxo</a>
    </div>
</footer>
  
  <script src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'default'});
    }
  </script>

  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * 给logo设置点击事件
     * 
     * - 回到顶部
     * - 出现爱心
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>

</body>
</html>
